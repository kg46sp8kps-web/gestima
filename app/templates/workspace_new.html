{% extends "base.html" %}

{% block title %}Workspace - GESTIMA{% endblock %}

{% block head %}
<style>
    /* Workspace Container */
    .workspace-container {
        position: relative;
        width: 100%;
        min-height: calc(100vh - 120px);
        background: var(--bg-primary);
        overflow-x: hidden;
        overflow-y: auto;
    }

    /* Panel Styles */
    .workspace-panel {
        position: absolute;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        min-width: 300px;
        min-height: 200px;
    }

    .workspace-panel.active {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border-color: var(--accent-blue);
    }

    .workspace-panel.minimized {
        height: auto !important;
        min-height: auto;
    }

    .workspace-panel.minimized .panel-content {
        display: none;
    }

    /* Panel Header */
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
        cursor: move;
        user-select: none;
    }

    .panel-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .panel-icon {
        font-size: 1rem;
    }

    .panel-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .panel-link-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid currentColor;
    }

    .panel-controls {
        display: flex;
        gap: 4px;
    }

    .panel-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .panel-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .panel-btn.close:hover {
        background: var(--accent-red);
        color: white;
    }

    /* Panel Content */
    .panel-content {
        flex: 1;
        overflow: auto;
        padding: 12px;
    }

    /* Resize Handle */
    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 16px;
        height: 16px;
        cursor: se-resize;
        background: linear-gradient(135deg, transparent 50%, var(--border-color) 50%);
        border-radius: 0 0 8px 0;
    }

    .resize-handle:hover {
        background: linear-gradient(135deg, transparent 50%, var(--accent-blue) 50%);
    }

    /* Toolbar */
    .workspace-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .toolbar-left, .toolbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toolbar-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .toolbar-stats {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Workspace Selector */
    .workspace-selector {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .workspace-dropdown-btn {
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s;
    }

    .workspace-dropdown-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
    }

    .workspace-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 4px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        z-index: 100;
        overflow: hidden;
    }

    .workspace-dropdown-item {
        padding: 8px 12px;
        font-size: 0.8rem;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.15s;
    }

    .workspace-dropdown-item:hover {
        background: var(--bg-hover);
    }

    .workspace-dropdown-item.active {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        font-weight: 600;
    }

    .workspace-dropdown-item.action {
        border-top: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .workspace-dropdown-item.action:hover {
        color: var(--text-primary);
    }

    .workspace-favorite-btn {
        cursor: pointer;
        font-size: 0.9rem;
        opacity: 0.5;
        transition: opacity 0.15s;
    }

    .workspace-favorite-btn:hover,
    .workspace-favorite-btn.active {
        opacity: 1;
    }

    /* Quick Access Buttons */
    .workspace-quick-btn {
        padding: 4px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .workspace-quick-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
    }

    .workspace-quick-btn.active {
        background: rgba(59, 130, 246, 0.15);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
        font-weight: 600;
    }

    /* Add Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
    }

    .modal-section {
        margin-bottom: 16px;
    }

    .modal-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }

    .module-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .module-option {
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s;
    }

    .module-option:hover {
        border-color: var(--accent-blue);
        background: var(--bg-hover);
    }

    .module-option.selected {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.1);
    }

    .module-option-icon {
        font-size: 1.5rem;
        margin-bottom: 4px;
    }

    .module-option-name {
        font-size: 0.8rem;
        color: var(--text-primary);
    }

    .color-grid {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.15s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: var(--text-primary);
    }

    .color-option.none {
        background: var(--bg-tertiary);
        border: 2px dashed var(--border-color);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 20px;
    }

    /* Empty State */
    .workspace-empty {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-muted);
    }

    .workspace-empty-icon {
        font-size: 3rem;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .workspace-empty-text {
        font-size: 0.9rem;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="workspaceController()" x-init="init()">
    <!-- Toolbar -->
    <div class="workspace-toolbar">
        <div class="toolbar-left">
            <!-- Workspace Selector -->
            <div class="workspace-selector" x-data="{ open: false }" @click.outside="open = false">
                <!-- Dropdown Button -->
                <button @click="open = !open" class="workspace-dropdown-btn">
                    <span x-text="getActiveWorkspace()?.name || 'Default'"></span>
                    <span style="font-size: 0.6rem;" x-text="open ? '‚ñ≤' : '‚ñº'"></span>
                </button>

                <!-- Dropdown Menu -->
                <div x-show="open" x-transition class="workspace-dropdown-menu">
                    <!-- Workspace List -->
                    <template x-for="ws in getWorkspacesList()" :key="ws.id">
                        <div class="workspace-dropdown-item"
                             :class="{ 'active': ws.id === activeWorkspaceId }"
                             @click="switchWorkspace(ws.id); open = false;">
                            <span class="workspace-favorite-btn"
                                  :class="{ 'active': ws.favorite }"
                                  @click.stop="toggleFavorite(ws.id)"
                                  x-text="ws.favorite ? '‚≠ê' : '‚òÜ'">
                            </span>
                            <span style="flex: 1;" x-text="ws.name"></span>
                            <span x-show="ws.id === activeWorkspaceId" style="color: var(--accent-blue);">‚úì</span>
                        </div>
                    </template>

                    <!-- Actions -->
                    <div class="workspace-dropdown-item action" @click="showNewWorkspaceModal = true; open = false;">
                        ‚ûï Nov√Ω workspace
                    </div>
                    <div class="workspace-dropdown-item action" @click="showSaveAsModal = true; open = false;">
                        üíæ Ulo≈æit jako...
                    </div>
                    <div class="workspace-dropdown-item action"
                         x-show="activeWorkspaceId !== 'default'"
                         @click="deleteWorkspace(activeWorkspaceId); open = false;">
                        üóëÔ∏è Smazat tento
                    </div>
                </div>
            </div>

            <!-- Quick Access Buttons (Favorites) -->
            <template x-for="ws in getFavoriteWorkspaces()" :key="ws.id">
                <button class="workspace-quick-btn"
                        :class="{ 'active': ws.id === activeWorkspaceId }"
                        @click="switchWorkspace(ws.id)">
                    <span>‚≠ê</span>
                    <span x-text="ws.name"></span>
                </button>
            </template>

            <!-- Separator -->
            <div style="width: 1px; height: 20px; background: var(--border-color);"></div>

            <!-- Manual Save Button -->
            <button @click="saveCurrentWorkspace(); _showToast('Workspace ulo≈æen ‚úì', 'success')"
                    class="btn-flat"
                    style="padding: 4px 8px; font-size: 0.75rem;"
                    title="Ulo≈æit workspace">
                üíæ
            </button>

            <!-- Panel Stats -->
            <span class="toolbar-stats" x-text="`${panels.length} panel${panels.length !== 1 ? 'y' : ''}`"></span>
        </div>

        <div class="toolbar-right">
            <button @click="openAddModal()" class="btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                + Pridat modul
            </button>
            <button @click="resetLayout()" class="btn-flat" style="padding: 6px 12px; font-size: 0.75rem;">
                Reset
            </button>
        </div>
    </div>

    <!-- Workspace Container -->
    <div class="workspace-container">
        <!-- Empty State -->
        <template x-if="panels.length === 0">
            <div class="workspace-empty">
                <div class="workspace-empty-icon">üì¶</div>
                <div class="workspace-empty-text">
                    Workspace je prazdny.<br>
                    Pridejte modul pro zacatek.
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    + Pridat modul
                </button>
            </div>
        </template>

        <!-- Panels -->
        <template x-for="panel in panels" :key="panel.id">
            <div class="workspace-panel"
                 :class="{ 'active': activePanelId === panel.id, 'minimized': panel.minimized }"
                 :style="{
                     left: panel.position.x + 'px',
                     top: panel.position.y + 'px',
                     width: panel.position.width + 'px',
                     height: panel.minimized ? 'auto' : panel.position.height + 'px',
                     zIndex: panel.zIndex
                 }"
                 @mousedown="bringToFront(panel.id)">

                <!-- Panel Header -->
                <div class="panel-header" @mousedown="startDrag(panel, $event)">
                    <div class="panel-header-left">
                        <span class="panel-icon" x-text="getModuleIcon(panel.moduleType)"></span>
                        <span class="panel-title" x-text="getModuleDescription(panel.moduleType)"></span>
                        <template x-if="panel.linkColor">
                            <div class="panel-link-indicator"
                                 :style="{ color: getColorCSS(panel.linkColor), background: getColorCSS(panel.linkColor) }">
                            </div>
                        </template>
                    </div>
                    <div class="panel-controls">
                        <!-- Link Color Selector -->
                        <div class="panel-btn" style="position: relative;">
                            <select @change="changePanelLink(panel.id, $event.target.value || null)"
                                    :value="panel.linkColor || ''"
                                    style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                                <option value="">Bez linku</option>
                                <template x-for="color in getLinkColors()" :key="color">
                                    <option :value="color" x-text="getColorEmoji(color) + ' ' + color"></option>
                                </template>
                            </select>
                            <span x-text="panel.linkColor ? getColorEmoji(panel.linkColor) : 'üîó'"></span>
                        </div>
                        <!-- Minimize -->
                        <button class="panel-btn" @click.stop="toggleMinimize(panel.id)">
                            <span x-text="panel.minimized ? 'üîº' : 'üîΩ'"></span>
                        </button>
                        <!-- Close -->
                        <button class="panel-btn close" @click.stop="removePanel(panel.id)">‚úï</button>
                    </div>
                </div>

                <!-- Panel Content -->
                <div class="panel-content" x-show="!panel.minimized">
                    <!-- Module instance rendered here -->
                    <div x-data="createModuleInstance(panel)" x-init="init()">

                        <!-- PARTS LIST MODULE -->
                        {% include 'workspace/_module_parts_list.html' %}

                        <!-- PART MATERIAL MODULE -->
                        {% include 'workspace/_module_part_material.html' %}

                        <!-- PART OPERATIONS MODULE -->
                        {% include 'workspace/_module_part_operations.html' %}

                        <!-- PART PRICING MODULE -->
                        {% include 'workspace/_module_part_pricing.html' %}

                        <!-- BATCH SETS MODULE -->
                        {% include 'workspace/_module_batch_sets.html' %}

                        <!-- Generic Module Placeholder -->
                        <template x-if="!['batch-sets', 'parts-list', 'part-material', 'part-operations', 'part-pricing'].includes(moduleType)">
                            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                <div style="font-size: 2rem; margin-bottom: 8px;" x-text="getModuleIcon(moduleType)"></div>
                                <div x-text="getModuleDescription(moduleType)"></div>
                                <div style="font-size: 0.7rem; margin-top: 8px;">
                                    Module ID: <span x-text="moduleId"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" x-show="!panel.minimized" @mousedown.stop="startResize(panel, $event)"></div>
            </div>
        </template>
    </div>

    <!-- Add Module Modal -->
    <template x-if="showAddModal">
        <div class="modal-overlay" @click.self="closeAddModal()">
            <div class="modal-content">
                <div class="modal-title">Pridat modul</div>

                <!-- Module Type Selection -->
                <div class="modal-section">
                    <label class="modal-label">Typ modulu</label>
                    <div class="module-grid">
                        <template x-for="mod in getAvailableModules()" :key="mod.type">
                            <div class="module-option"
                                 :class="{ 'selected': selectedModuleType === mod.type }"
                                 @click="selectedModuleType = mod.type">
                                <div class="module-option-icon" x-text="mod.icon"></div>
                                <div class="module-option-name" x-text="mod.description"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Link Color Selection -->
                <div class="modal-section">
                    <label class="modal-label">Link barva (volitelne)</label>
                    <div class="color-grid">
                        <div class="color-option none"
                             :class="{ 'selected': selectedLinkColor === null }"
                             @click="selectedLinkColor = null"
                             title="Bez linku">
                        </div>
                        <template x-for="color in getLinkColors()" :key="color">
                            <div class="color-option"
                                 :class="{ 'selected': selectedLinkColor === color }"
                                 :style="{ background: getColorCSS(color) }"
                                 :title="color"
                                 @click="selectedLinkColor = color">
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Actions -->
                <div class="modal-actions">
                    <button @click="closeAddModal()" class="btn-flat">Zrusit</button>
                    <button @click="confirmAddPanel()" class="btn-primary" :disabled="!selectedModuleType">
                        Pridat
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- New Workspace Modal -->
    <template x-if="showNewWorkspaceModal">
        <div class="modal-overlay" @click.self="showNewWorkspaceModal = false">
            <div class="modal-content">
                <div class="modal-title">Nov√Ω workspace</div>

                <div class="modal-section">
                    <label class="modal-label">N√°zev workspace</label>
                    <input type="text"
                           x-model="newWorkspaceName"
                           @keydown.enter="createWorkspace(newWorkspaceName); showNewWorkspaceModal = false; newWorkspaceName = ''"
                           placeholder="nap≈ô. Pricing Setup"
                           style="width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary);"
                           autofocus>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">
                        Max <span x-text="MAX_WORKSPACES"></span> workspaces celkem
                    </div>
                </div>

                <div class="modal-actions">
                    <button @click="showNewWorkspaceModal = false; newWorkspaceName = ''" class="btn-flat">
                        Zru≈°it
                    </button>
                    <button @click="createWorkspace(newWorkspaceName); showNewWorkspaceModal = false; newWorkspaceName = ''"
                            class="btn-primary"
                            :disabled="!newWorkspaceName.trim()">
                        Vytvo≈ôit
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- Save As Modal -->
    <template x-if="showSaveAsModal">
        <div class="modal-overlay" @click.self="showSaveAsModal = false">
            <div class="modal-content">
                <div class="modal-title">Ulo≈æit workspace jako...</div>

                <div class="modal-section">
                    <label class="modal-label">N√°zev nov√© kopie</label>
                    <input type="text"
                           x-model="newWorkspaceName"
                           @keydown.enter="saveWorkspaceAs(newWorkspaceName); showSaveAsModal = false; newWorkspaceName = ''"
                           placeholder="nap≈ô. Pricing Setup v2"
                           style="width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary);"
                           autofocus>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">
                        Vytvo≈ô√≠ kopii souƒçasn√©ho workspace s <span x-text="panels.length"></span> panely
                    </div>
                </div>

                <div class="modal-actions">
                    <button @click="showSaveAsModal = false; newWorkspaceName = ''" class="btn-flat">
                        Zru≈°it
                    </button>
                    <button @click="saveWorkspaceAs(newWorkspaceName); showSaveAsModal = false; newWorkspaceName = ''"
                            class="btn-primary"
                            :disabled="!newWorkspaceName.trim()">
                        Ulo≈æit
                    </button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
    // Helper to create module instance from panel config
    function createModuleInstance(panel) {
        if (window.ModuleRegistry && ModuleRegistry.has(panel.moduleType)) {
            return ModuleRegistry.create(panel.moduleType, {
                moduleId: panel.id,
                linkColor: panel.linkColor
            });
        }

        // Fallback for unknown modules
        return {
            moduleType: panel.moduleType,
            moduleId: panel.id,
            linkColor: panel.linkColor,
            init() {
            },
            getModuleIcon(type) {
                return window.ModuleRegistry?.getMeta(type)?.icon || 'üìÅ';
            },
            getModuleDescription(type) {
                return window.ModuleRegistry?.getMeta(type)?.description || type;
            }
        };
    }
</script>
{% endblock %}
