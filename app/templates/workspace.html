{% extends "base.html" %}

{% block title %}Workspace - GESTIMA{% endblock %}

{% block head %}
<style>
    /* Workspace Container */
    .workspace-container {
        position: relative;
        width: 100%;
        min-height: calc(100vh - 120px);
        background: var(--bg-primary);
        overflow-x: hidden;
        overflow-y: auto;
    }

    /* Panel Styles */
    .workspace-panel {
        position: absolute;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        min-width: 300px;
        min-height: 200px;
    }

    .workspace-panel.active {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border-color: var(--accent-blue);
    }

    .workspace-panel.minimized {
        height: auto !important;
        min-height: auto;
    }

    .workspace-panel.minimized .panel-content {
        display: none;
    }

    /* Panel Header */
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
        cursor: move;
        user-select: none;
    }

    .panel-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .panel-icon {
        font-size: 1rem;
    }

    .panel-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .panel-link-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid currentColor;
    }

    .panel-controls {
        display: flex;
        gap: 4px;
    }

    .panel-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .panel-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .panel-btn.close:hover {
        background: var(--accent-red);
        color: white;
    }

    /* Panel Content */
    .panel-content {
        flex: 1;
        overflow: auto;
        padding: 12px;
    }

    /* Resize Handle */
    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 16px;
        height: 16px;
        cursor: se-resize;
        background: linear-gradient(135deg, transparent 50%, var(--border-color) 50%);
        border-radius: 0 0 8px 0;
    }

    .resize-handle:hover {
        background: linear-gradient(135deg, transparent 50%, var(--accent-blue) 50%);
    }

    /* Toolbar */
    .workspace-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .toolbar-left, .toolbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toolbar-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .toolbar-stats {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Workspace Selector */
    .workspace-selector {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .workspace-dropdown-btn {
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s;
    }

    .workspace-dropdown-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
    }

    .workspace-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 4px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        z-index: 100;
        overflow: hidden;
    }

    .workspace-dropdown-item {
        padding: 8px 12px;
        font-size: 0.8rem;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.15s;
    }

    .workspace-dropdown-item:hover {
        background: var(--bg-hover);
    }

    .workspace-dropdown-item.active {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        font-weight: 600;
    }

    .workspace-dropdown-item.action {
        border-top: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .workspace-dropdown-item.action:hover {
        color: var(--text-primary);
    }

    .workspace-favorite-btn {
        cursor: pointer;
        font-size: 0.9rem;
        opacity: 0.5;
        transition: opacity 0.15s;
    }

    .workspace-favorite-btn:hover,
    .workspace-favorite-btn.active {
        opacity: 1;
    }

    /* Quick Access Buttons */
    .workspace-quick-btn {
        padding: 4px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .workspace-quick-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-blue);
    }

    .workspace-quick-btn.active {
        background: rgba(59, 130, 246, 0.15);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
        font-weight: 600;
    }

    /* Add Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
    }

    .modal-section {
        margin-bottom: 16px;
    }

    .modal-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }

    .module-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .module-option {
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s;
    }

    .module-option:hover {
        border-color: var(--accent-blue);
        background: var(--bg-hover);
    }

    .module-option.selected {
        border-color: var(--accent-blue);
        background: rgba(59, 130, 246, 0.1);
    }

    .module-option-icon {
        font-size: 1.5rem;
        margin-bottom: 4px;
    }

    .module-option-name {
        font-size: 0.8rem;
        color: var(--text-primary);
    }

    .color-grid {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.15s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: var(--text-primary);
    }

    .color-option.none {
        background: var(--bg-tertiary);
        border: 2px dashed var(--border-color);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 20px;
    }

    /* Empty State */
    .workspace-empty {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-muted);
    }

    .workspace-empty-icon {
        font-size: 3rem;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .workspace-empty-text {
        font-size: 0.9rem;
        margin-bottom: 16px;
    }

    /* Input focus highlight */
    input[type="number"]:focus {
        background: rgba(59, 130, 246, 0.15) !important;
        border-color: var(--accent-blue) !important;
        outline: none;
    }

    /* Fast CSS tooltip */
    .fast-tip {
        position: relative;
        cursor: help;
    }
    .fast-tip::after {
        content: attr(data-tip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.3rem 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.6rem;
        font-weight: normal;
        color: var(--text-primary);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s, visibility 0.15s;
        z-index: 100;
        pointer-events: none;
    }
    .fast-tip:hover::after {
        opacity: 1;
        visibility: visible;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="workspaceController()" x-init="init()">
    <!-- Toolbar -->
    <div class="workspace-toolbar">
        <div class="toolbar-left">
            <!-- Workspace Selector -->
            <div class="workspace-selector" x-data="{ open: false }" @click.outside="open = false">
                <!-- Dropdown Button -->
                <button @click="open = !open" class="workspace-dropdown-btn">
                    <span x-text="getActiveWorkspace()?.name || 'Default'"></span>
                    <span style="font-size: 0.6rem;" x-text="open ? '‚ñ≤' : '‚ñº'"></span>
                </button>

                <!-- Dropdown Menu -->
                <div x-show="open" x-transition class="workspace-dropdown-menu">
                    <!-- Workspace List -->
                    <template x-for="ws in getWorkspacesList()" :key="ws.id">
                        <div class="workspace-dropdown-item"
                             :class="{ 'active': ws.id === activeWorkspaceId }"
                             @click="switchWorkspace(ws.id); open = false;">
                            <span class="workspace-favorite-btn"
                                  :class="{ 'active': ws.favorite }"
                                  @click.stop="toggleFavorite(ws.id)"
                                  x-text="ws.favorite ? '‚≠ê' : '‚òÜ'">
                            </span>
                            <span style="flex: 1;" x-text="ws.name"></span>
                            <span x-show="ws.id === activeWorkspaceId" style="color: var(--accent-blue);">‚úì</span>
                        </div>
                    </template>

                    <!-- Actions -->
                    <div class="workspace-dropdown-item action" @click="showNewWorkspaceModal = true; open = false;">
                        ‚ûï Nov√Ω workspace
                    </div>
                    <div class="workspace-dropdown-item action" @click="showSaveAsModal = true; open = false;">
                        üíæ Ulo≈æit jako...
                    </div>
                    <div class="workspace-dropdown-item action"
                         x-show="activeWorkspaceId !== 'default'"
                         @click="deleteWorkspace(activeWorkspaceId); open = false;">
                        üóëÔ∏è Smazat tento
                    </div>
                </div>
            </div>

            <!-- Quick Access Buttons (Favorites) -->
            <template x-for="ws in getFavoriteWorkspaces()" :key="ws.id">
                <button class="workspace-quick-btn"
                        :class="{ 'active': ws.id === activeWorkspaceId }"
                        @click="switchWorkspace(ws.id)">
                    <span>‚≠ê</span>
                    <span x-text="ws.name"></span>
                </button>
            </template>

            <!-- Separator -->
            <div style="width: 1px; height: 20px; background: var(--border-color);"></div>

            <!-- Manual Save Button -->
            <button @click="saveCurrentWorkspace(); _showToast('Workspace ulo≈æen ‚úì', 'success')"
                    class="btn-flat"
                    style="padding: 4px 8px; font-size: 0.75rem;"
                    title="Ulo≈æit workspace">
                üíæ
            </button>

            <!-- Panel Stats -->
            <span class="toolbar-stats" x-text="`${panels.length} panel${panels.length !== 1 ? 'y' : ''}`"></span>
        </div>

        <div class="toolbar-right">
            <button @click="openAddModal()" class="btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                + Pridat modul
            </button>
            <button @click="resetLayout()" class="btn-flat" style="padding: 6px 12px; font-size: 0.75rem;">
                Reset
            </button>
        </div>
    </div>

    <!-- Workspace Container -->
    <div class="workspace-container">
        <!-- Empty State -->
        <template x-if="panels.length === 0">
            <div class="workspace-empty">
                <div class="workspace-empty-icon">üì¶</div>
                <div class="workspace-empty-text">
                    Workspace je prazdny.<br>
                    Pridejte modul pro zacatek.
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    + Pridat modul
                </button>
            </div>
        </template>

        <!-- Panels -->
        <template x-for="panel in panels" :key="panel.id">
            <div class="workspace-panel"
                 :class="{ 'active': activePanelId === panel.id, 'minimized': panel.minimized }"
                 :style="{
                     left: panel.position.x + 'px',
                     top: panel.position.y + 'px',
                     width: panel.position.width + 'px',
                     height: panel.minimized ? 'auto' : panel.position.height + 'px',
                     zIndex: panel.zIndex
                 }"
                 @mousedown="bringToFront(panel.id)">

                <!-- Panel Header -->
                <div class="panel-header" @mousedown="startDrag(panel, $event)">
                    <div class="panel-header-left">
                        <span class="panel-icon" x-text="getModuleIcon(panel.moduleType)"></span>
                        <span class="panel-title" x-text="getModuleDescription(panel.moduleType)"></span>
                        <template x-if="panel.linkColor">
                            <div class="panel-link-indicator"
                                 :style="{ color: getColorCSS(panel.linkColor), background: getColorCSS(panel.linkColor) }">
                            </div>
                        </template>
                    </div>
                    <div class="panel-controls">
                        <!-- Link Color Selector -->
                        <div class="panel-btn" style="position: relative;">
                            <select @change="changePanelLink(panel.id, $event.target.value || null)"
                                    :value="panel.linkColor || ''"
                                    style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                                <option value="">Bez linku</option>
                                <template x-for="color in getLinkColors()" :key="color">
                                    <option :value="color" x-text="getColorEmoji(color) + ' ' + color"></option>
                                </template>
                            </select>
                            <span x-text="panel.linkColor ? getColorEmoji(panel.linkColor) : 'üîó'"></span>
                        </div>
                        <!-- Minimize -->
                        <button class="panel-btn" @click.stop="toggleMinimize(panel.id)">
                            <span x-text="panel.minimized ? 'üîº' : 'üîΩ'"></span>
                        </button>
                        <!-- Close -->
                        <button class="panel-btn close" @click.stop="removePanel(panel.id)">‚úï</button>
                    </div>
                </div>

                <!-- Panel Content -->
                <div class="panel-content" x-show="!panel.minimized">
                    <!-- Module instance rendered here -->
                    <div x-data="createModuleInstance(panel)" x-init="init()">
                        <!-- Batch Sets Module UI -->
                        <template x-if="moduleType === 'batch-sets'">
                            <div>
                                <!-- Part ID Input -->
                                <div style="margin-bottom: 12px;">
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Part ID:</label>
                                    <div style="display: flex; gap: 8px; margin-top: 4px;">
                                        <input type="number" x-model.number="partId"
                                               style="flex: 1; padding: 6px 10px; font-size: 0.85rem;"
                                               placeholder="Zadej ID dilu">
                                        <button @click="loadBatchSets()" class="btn-primary"
                                                style="padding: 6px 12px; font-size: 0.8rem;"
                                                :disabled="!partId">
                                            Nacist
                                        </button>
                                    </div>
                                </div>

                                <!-- Loading -->
                                <template x-if="loading">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        Nacitam...
                                    </div>
                                </template>

                                <!-- Batch Sets List -->
                                <template x-if="!loading && batchSets.length > 0">
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">
                                            <span x-text="batchSets.length"></span> sad
                                        </div>
                                        <template x-for="set in batchSets" :key="set.id">
                                            <div @click="selectSet(set.id)"
                                                 :class="{ 'selected': selectedSetId === set.id }"
                                                 style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s;"
                                                 :style="selectedSetId === set.id ? 'border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1);' : ''">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 0.85rem; font-weight: 500;" x-text="set.name"></span>
                                                    <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;"
                                                          :style="set.status === 'frozen' ? 'background: var(--accent-blue); color: white;' : 'background: var(--bg-tertiary); color: var(--text-secondary);'"
                                                          x-text="set.status === 'frozen' ? 'Zmrazeno' : 'Draft'">
                                                    </span>
                                                </div>
                                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                                    #<span x-text="set.set_number"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Empty State -->
                                <template x-if="!loading && partId && batchSets.length === 0">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üì≠</div>
                                        Zadne sady pro tento dil.
                                        <button @click="createSet()" class="btn-primary"
                                                style="display: block; margin: 12px auto 0; padding: 6px 12px; font-size: 0.8rem;">
                                            + Vytvorit sadu
                                        </button>
                                    </div>
                                </template>

                                <!-- No Part Selected -->
                                <template x-if="!loading && !partId">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üéØ</div>
                                        Zadej Part ID nebo propoj modul.
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Parts List Module UI -->
                        <template x-if="moduleType === 'parts-list'">
                            <div>
                                <!-- Search -->
                                <div style="margin-bottom: 12px;">
                                    <div style="position: relative;">
                                        <input type="text" x-model="search" @input="debouncedSearch()"
                                               placeholder="Hledat dily..."
                                               style="width: 100%; padding: 8px 32px 8px 10px; font-size: 0.85rem;">
                                        <button x-show="search.length > 0" @click="clearSearch()"
                                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted);">
                                            √ó
                                        </button>
                                    </div>
                                </div>

                                <!-- Loading -->
                                <template x-if="loading">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Nacitam...</div>
                                </template>

                                <!-- Parts List -->
                                <template x-if="!loading && parts.length > 0">
                                    <div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">
                                            <span x-text="totalParts"></span> dilu
                                        </div>
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <template x-for="part in parts" :key="part.id">
                                                <div @click="selectPart(part)"
                                                     :style="isSelected(part.id) ? 'border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1);' : ''"
                                                     style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.15s;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-weight: 600; font-size: 0.85rem;" x-text="part.part_number"></span>
                                                        <span style="font-size: 0.7rem; color: var(--text-muted);" x-text="'ID:' + part.id"></span>
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;" x-text="part.name || part.article_number || '-'"></div>
                                                </div>
                                            </template>
                                        </div>
                                        <!-- Pagination -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.75rem;">
                                            <button @click="prevPage()" :disabled="!hasPrevious" class="btn-flat" style="padding: 4px 8px; font-size: 0.7rem;">‚Üê Zpet</button>
                                            <span style="color: var(--text-muted);" x-text="currentPage + '/' + totalPages"></span>
                                            <button @click="nextPage()" :disabled="!hasMore" class="btn-flat" style="padding: 4px 8px; font-size: 0.7rem;">Dalsi ‚Üí</button>
                                        </div>
                                    </div>
                                </template>

                                <!-- Empty -->
                                <template x-if="!loading && parts.length === 0">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üìã</div>
                                        Zadne dily nenalezeny.
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Part Material Module UI (1:1 from edit.html) -->
                        <template x-if="moduleType === 'part-material'">
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.75rem;">
                                <template x-if="loading">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Nacitam...</div>
                                </template>

                                <template x-if="!loading && !partNumber">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üî©</div>
                                        Vyber dil pres link.
                                    </div>
                                </template>

                                <template x-if="!loading && partNumber">
                                    <div>
                                        <!-- Part Number Header -->
                                        <div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-weight: 600;" x-text="partNumber"></div>

                                        <!-- QUICK INPUT: Material Parser -->
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.75rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-bottom: 0.75rem;">
                                            <div style="color: white; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.7rem; display: flex; align-items: center; gap: 0.5rem;">
                                                üîç Rychl√© zad√°n√≠ materi√°lu
                                                <span style="font-weight: 400; font-size: 0.65rem; opacity: 0.9;">(nap≈ô. D20 C45 100mm)</span>
                                            </div>
                                            <div style="position: relative;">
                                                <input
                                                    type="text"
                                                    x-model="quickMaterialInput"
                                                    @input="debouncedParseMaterial()"
                                                    @keydown.enter="applyParsedMaterial()"
                                                    placeholder="D20 C45 100mm, 20x30 S235 500, t2 1.4301..."
                                                    style="width: 100%; background: rgba(255,255,255,0.95); border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 0.5rem; font-size: 0.75rem; color: #2d3748; font-weight: 500;">
                                                <div x-show="parsingMaterial" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 0.7rem;">
                                                    ‚è≥
                                                </div>
                                            </div>

                                            <!-- Parse result -->
                                            <template x-if="parseResult && parseResult.confidence > 0">
                                                <div style="margin-top: 0.5rem; background: white; border-radius: 4px; padding: 0.5rem; font-size: 0.7rem;">
                                                    <!-- Status badge -->
                                                    <div style="margin-bottom: 0.5rem;">
                                                        <span x-show="parseResult.confidence >= 0.7" style="background: #48bb78; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚úÖ ROZPOZN√ÅNO</span>
                                                        <span x-show="parseResult.confidence >= 0.4 && parseResult.confidence < 0.7" style="background: #ed8936; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚ö†Ô∏è ƒå√ÅSTEƒåNƒö</span>
                                                        <span x-show="parseResult.confidence < 0.4" style="background: #f56565; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚ùå N√çZK√Å SHODA</span>
                                                        <span style="float: right; color: #718096; font-size: 0.65rem;">
                                                            Spolehlivost: <span x-text="Math.round(parseResult.confidence * 100) + '%'"></span>
                                                        </span>
                                                    </div>

                                                    <!-- Recognized values -->
                                                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 0.5rem; color: #2d3748;">
                                                        <template x-if="parseResult.shape">
                                                            <template>
                                                                <strong>Tvar:</strong>
                                                                <span x-text="formatShape(parseResult.shape)"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.diameter">
                                                            <template>
                                                                <strong>Pr≈Ømƒõr:</strong>
                                                                <span x-text="parseResult.diameter + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.width">
                                                            <template>
                                                                <strong>≈†√≠≈ôka:</strong>
                                                                <span x-text="parseResult.width + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.height && parseResult.height !== parseResult.width">
                                                            <template>
                                                                <strong>V√Ω≈°ka:</strong>
                                                                <span x-text="parseResult.height + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.thickness">
                                                            <template>
                                                                <strong>Tlou≈°≈•ka:</strong>
                                                                <span x-text="parseResult.thickness + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.wall_thickness">
                                                            <template>
                                                                <strong>Tl. stƒõny:</strong>
                                                                <span x-text="parseResult.wall_thickness + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.length">
                                                            <template>
                                                                <strong>D√©lka:</strong>
                                                                <span x-text="parseResult.length + ' mm'"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.suggested_material_group_name">
                                                            <template>
                                                                <strong>Materi√°l:</strong>
                                                                <span x-text="parseResult.suggested_material_group_name"></span>
                                                            </template>
                                                        </template>
                                                        <template x-if="parseResult.suggested_price_category_name">
                                                            <template>
                                                                <strong>Kategorie:</strong>
                                                                <span x-text="parseResult.suggested_price_category_name"></span>
                                                            </template>
                                                        </template>
                                                    </div>

                                                    <!-- Action buttons -->
                                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                                        <button
                                                            @click="applyParsedMaterial()"
                                                            :disabled="parseResult.confidence < 0.4"
                                                            style="flex: 1; background: #667eea; color: white; border: none; border-radius: 4px; padding: 0.4rem; font-size: 0.7rem; font-weight: 600; cursor: pointer; opacity: 1;"
                                                            :style="parseResult.confidence < 0.4 ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                                                            Pou≈æ√≠t
                                                        </button>
                                                        <button
                                                            @click="clearParseResult()"
                                                            style="background: #e2e8f0; color: #4a5568; border: none; border-radius: 4px; padding: 0.4rem 0.75rem; font-size: 0.7rem; font-weight: 600; cursor: pointer;">
                                                            Zru≈°it
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>

                                            <div style="color: rgba(255,255,255,0.8); font-size: 0.65rem; margin-top: 0.5rem; font-style: italic;">
                                                üí° Tip: Zadejte tvar (D20, 20x30, t2), normu (C45, 1.4301) a d√©lku (100mm)
                                            </div>
                                        </div>

                                        <div style="text-align: center; color: var(--text-muted); font-size: 0.65rem; padding: 0.25rem 0;">
                                            ‚îÄ‚îÄ‚îÄ NEBO manu√°lnƒõ ‚îÄ‚îÄ‚îÄ
                                        </div>

                                        <!-- 1. Typ polotovaru -->
                                        <div>
                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">1. Typ polotovaru</label>
                                            <select x-model="partData.stock_shape" @change="debouncedSave()"
                                                    style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                                <option value="">- Vyberte typ -</option>
                                                <option value="round_bar">Tyƒç kruhov√°</option>
                                                <option value="flat_bar">Tyƒç ploch√°</option>
                                                <option value="square_bar">Tyƒç ƒçtvercov√°</option>
                                                <option value="hexagonal_bar">Tyƒç ≈°estihrann√°</option>
                                                <option value="plate">Plech / Deska</option>
                                                <option value="tube">Trubka</option>
                                                <option value="casting">Odlitek</option>
                                                <option value="forging">V√Ωkovek</option>
                                            </select>
                                        </div>

                                        <!-- 2. Kategorie materi√°lu (FILTROVAN√Å podle typu) -->
                                        <div x-show="partData.stock_shape">
                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">2. Kategorie materi√°lu</label>
                                            <select x-model.number="partData.price_category_id" @change="debouncedSave()"
                                                    style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                                <option value="">- Vyberte kategorii -</option>
                                                <template x-for="item in filteredCategories" :key="item.id">
                                                    <option :value="item.id" :selected="item.id === partData.price_category_id" x-text="item.name + ' (' + (item.material_group?.name || '-') + ')'"></option>
                                                </template>
                                            </select>
                                            <div x-show="filteredCategories.length === 0" style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;">
                                                ≈Ω√°dn√© kategorie pro tento typ polotovaru
                                            </div>
                                        </div>

                                        <!-- Selected Material Info -->
                                        <div x-show="selectedMaterial" style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                                            <div style="font-weight: 600; margin-bottom: 0.25rem;" x-text="selectedMaterial?.name || '-'"></div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">
                                                <span x-text="selectedMaterial?.material_group?.name || '-'"></span> |
                                                Hustota: <span x-text="(selectedMaterial?.material_group?.density || 0).toFixed(2)"></span> kg/dm¬≥
                                            </div>
                                        </div>

                                        <!-- Rozmƒõry polotovaru -->
                                        <div x-show="selectedShape" style="margin-top: 0.5rem;">
                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">üìê Rozmƒõry [mm]</label>

                                            <!-- ROUND_BAR, HEXAGONAL_BAR, CASTING, FORGING -->
                                            <template x-if="['round_bar', 'hexagonal_bar', 'casting', 'forging'].includes(selectedShape)">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- TUBE -->
                                            <template x-if="selectedShape === 'tube'">
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                                        <div>
                                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò vnƒõj≈°√≠ [mm]</label>
                                                            <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                        </div>
                                                        <div>
                                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Tl. stƒõny [mm]</label>
                                                            <input type="number" step="0.1" min="0" x-model.number="partData.stock_wall_thickness" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- SQUARE_BAR -->
                                            <template x-if="selectedShape === 'square_bar'">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Strana [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- FLAT_BAR, PLATE -->
                                            <template x-if="['flat_bar', 'plate'].includes(selectedShape)">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">≈†√≠≈ôka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                    <div>
                                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">V√Ω≈°ka [mm]</label>
                                                        <input type="number" step="0.1" min="0" x-model.number="partData.stock_height" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- No material selected -->
                                            <div x-show="!selectedShape" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.7rem;">
                                                Vyberte polotovar
                                            </div>

                                            <!-- Copy from catalog button -->
                                            <button x-show="selectedMaterial" @click="copyGeometryFromCatalog()"
                                                    class="btn-flat" style="font-size: 0.7rem; padding: 0.4rem 0.6rem; margin-top: 0.5rem;">
                                                üìã Naƒç√≠st rozmƒõry z katalogu
                                            </button>
                                        </div>

                                        <!-- Stock Cost Display -->
                                        <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: var(--text-muted); font-weight: 600;">Materi√°l/ks:</span>
                                                <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-green);" x-text="stockCost.cost.toFixed(0) + ' Kƒç'"></span>
                                            </div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;">
                                                <span x-text="stockCost.weight_kg.toFixed(3) + ' kg'"></span> √ó
                                                <span x-text="stockCost.price_per_kg.toFixed(0) + ' Kƒç/kg'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Part Operations Module UI (1:1 from edit.html) -->
                        <template x-if="moduleType === 'part-operations'">
                            <div style="padding: 0.5rem;">
                                <template x-if="loading">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Nacitam...</div>
                                </template>

                                <template x-if="!loading && !partId">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üîß</div>
                                        Vyber dil pres link.
                                    </div>
                                </template>

                                <template x-if="!loading && partId">
                                    <div>
                                        <!-- Header with Add button -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600; font-size: 0.8rem;">
                                                üîß OPERACE (<span x-text="operations.length">0</span>)
                                            </div>
                                            <button @click="addOperation" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                                                + P≈ôidat operaci
                                            </button>
                                        </div>

                                        <!-- Operations List -->
                                        <template x-for="(op, index) in operations" :key="op.id">
                                            <div class="operation-card" x-data="{ expanded: false }" style="margin-bottom: 0.5rem;">
                                                <!-- Header (editovateln√Ω inline) -->
                                                <div class="op-header" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px;">
                                                    <!-- Seq + Icon -->
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <div class="op-seq" style="color: var(--text-muted); font-size: 0.7rem; font-weight: 600;" x-text="op.seq"></div>
                                                        <div class="op-icon" x-text="op.icon"></div>
                                                    </div>

                                                    <!-- Pracovi≈°tƒõ (editovateln√Ω dropdown) -->
                                                    <div @click.stop style="flex: 1; min-width: 180px;">
                                                        <select x-model.number="op.work_center_id" @change="debouncedUpdate(op)"
                                                                style="width: 100%; padding: 0.35rem 0.5rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem; font-weight: 500;">
                                                            <option value="">- Vyberte pracovi≈°tƒõ -</option>
                                                            <template x-for="workCenter in workCenters" :key="workCenter.id">
                                                                <option :value="workCenter.id" :selected="workCenter.id === op.work_center_id" x-text="workCenter.name"></option>
                                                            </template>
                                                        </select>
                                                    </div>

                                                    <!-- tp - se≈ôizovac√≠ ƒças (editovateln√Ω inline) -->
                                                    <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                                        <span style="color: var(--accent-yellow); font-size: 0.7rem; font-weight: 600;">tp:</span>
                                                        <input type="number" step="0.1" min="0" x-model.number="op.setup_time_min" @input="debouncedUpdate(op)"
                                                               @focus="$el.dataset.fresh = 'true'"
                                                               @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }"
                                                               @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                                        <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                                    </div>

                                                    <!-- tj - v√Ωrobn√≠ ƒças (editovateln√Ω inline) -->
                                                    <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                                        <span style="color: var(--accent-blue); font-size: 0.7rem; font-weight: 600;">tj:</span>
                                                        <input type="number" step="0.1" min="0" x-model.number="op.operation_time_min" @input="debouncedUpdate(op)"
                                                               @focus="$el.dataset.fresh = 'true'"
                                                               @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }"
                                                               @blur="$el.dataset.fresh = 'false'"
                                                               style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                                        <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                                    </div>

                                                    <!-- Maz√°n√≠ operace -->
                                                    <button @click.stop="deleteOperation(op)"
                                                            style="padding: 0.25rem 0.4rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem; opacity: 0.6; transition: opacity 0.2s;"
                                                            @mouseenter="$el.style.opacity = '1'; $el.style.color = '#E53E3E'"
                                                            @mouseleave="$el.style.opacity = '0.6'; $el.style.color = 'var(--text-muted)'"
                                                            title="Smazat operaci">üóëÔ∏è</button>

                                                    <!-- Expand indicator (pro kooperace) -->
                                                    <div @click="expanded = !expanded" style="font-size: 0.7rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem;" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                                                </div>

                                                <!-- Features (rozbalovac√≠) -->
                                                <div class="features-section" x-show="expanded" x-collapse>
                                                    <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                                        <!-- Mode buttons -->
                                                        <div style="margin-bottom: 0.75rem;">
                                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Re≈æim ≈ôez√°n√≠</label>
                                                            <div class="mode-buttons-inline">
                                                                <button @click="changeMode(op, 'low')"
                                                                        :class="{ 'active': op.cutting_mode === 'low' }"
                                                                        class="mode-btn-sm mode-low">LOW</button>
                                                                <button @click="changeMode(op, 'mid')"
                                                                        :class="{ 'active': op.cutting_mode === 'mid' }"
                                                                        class="mode-btn-sm mode-mid">MID</button>
                                                                <button @click="changeMode(op, 'high')"
                                                                        :class="{ 'active': op.cutting_mode === 'high' }"
                                                                        class="mode-btn-sm mode-high">HIGH</button>
                                                            </div>
                                                        </div>

                                                        <!-- Kooperace toggle -->
                                                        <div style="margin-bottom: 0.5rem;">
                                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Re≈æim</label>
                                                            <button @click="toggleCoopMode(op)"
                                                                    :style="op.is_cooperation ? 'background: var(--accent-purple); color: white;' : 'background: var(--bg-tertiary); color: var(--text-primary);'"
                                                                    style="padding: 0.4rem 0.6rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s;">
                                                                <span x-text="op.is_cooperation ? 'üè≠ Kooperace' : 'üè¢ Intern√≠'"></span>
                                                            </button>
                                                        </div>
                                                        <!-- Coop price (pokud kooperace) -->
                                                        <div x-show="op.is_cooperation" style="margin-top: 0.5rem;">
                                                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Cena/ks [Kƒç]</label>
                                                            <input type="number" step="0.1" min="0" x-model.number="op.coop_price_per_piece" @input="debouncedUpdate(op)"
                                                                   style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                                        </div>

                                                        <!-- Features placeholder -->
                                                        <div class="no-features" style="margin-top: 0.75rem; padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem; font-style: italic;">
                                                            üìù Kroky operace (zat√≠m neimplementov√°no)
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Pr√°zdn√Ω stav -->
                                        <div x-show="operations.length === 0" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                            <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">üîß Zat√≠m ≈æ√°dn√© operace</div>
                                            <div style="font-size: 0.75rem;">Klikni na "+ P≈ôidat operaci" pro zaƒç√°tek</div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Part Pricing Module UI -->
                        <template x-if="moduleType === 'part-pricing'">
                            <div>
                                <template x-if="loading">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Nacitam...</div>
                                </template>

                                <template x-if="!loading && !partId">
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                        <div style="font-size: 1.5rem; margin-bottom: 8px;">üí∞</div>
                                        Vyber dil pres link.
                                    </div>
                                </template>

                                <template x-if="!loading && partId">
                                    <div>
                                        <!-- Batch Sets Controls (like parts/edit.html) -->
                                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                            <div style="flex: 1;">
                                                <select x-model="selectedSetId" @change="loadBatches()"
                                                        style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.7rem;">
                                                    <option value="">üìù Voln√© ≈°ar≈æe (rozpracov√°no)</option>
                                                    <template x-for="set in batchSets" :key="set.id">
                                                        <option :value="String(set.id)" x-text="'üì¶ ' + set.set_number + ' - ' + set.name + ' (' + (set.batch_count || 0) + ' ks)'"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            <!-- Detail button - shows when set selected -->
                                            <a x-show="selectedSetId && selectedSetId !== ''"
                                               :href="'/pricing/batch-sets/' + selectedSetId"
                                               class="btn-flat"
                                               style="font-size: 0.7rem; padding: 0.4rem 0.6rem; white-space: nowrap; text-decoration: none;"
                                               title="Zobrazit detail sady">
                                                üìã
                                            </a>
                                            <!-- Freeze button - shows when loose batches exist -->
                                            <button x-show="selectedSetId === '' && looseBatchCount > 0"
                                                    @click="freezeLooseBatches()"
                                                    class="btn-flat"
                                                    style="font-size: 0.7rem; padding: 0.4rem 0.6rem; white-space: nowrap; background: var(--accent-green); color: white;"
                                                    :title="'Zmrazit ' + looseBatchCount + ' voln√Ωch ≈°ar≈æ√≠ jako sadu'">
                                                <span x-text="'üì¶ Zmrazit (' + looseBatchCount + ')'"></span>
                                            </button>
                                        </div>

                                        <!-- Tabulka cen - kompaktn√≠ -->
                                        <table style="width: 100%; font-size: 0.65rem; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <th style="padding: 0.2rem; text-align: left; color: var(--text-muted); font-weight: 600;">D√°vka</th>
                                                    <th style="padding: 0.2rem 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">Mat</th>
                                                    <th style="padding: 0.2rem 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">Koop</th>
                                                    <th style="padding: 0.2rem 0.5rem; text-align: center; color: var(--text-muted); font-weight: 600;">Rozlo≈æen√≠</th>
                                                    <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Pr√°ce</th>
                                                    <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Œ£ N√°kl</th>
                                                    <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Re≈æie</th>
                                                    <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Mar≈æe</th>
                                                    <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Cena/ks</th>
                                                    <th style="padding: 0.2rem; width: 24px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="batch in displayedBatches" :key="batch.id">
                                                    <tr :style="batch.is_frozen ? 'border-bottom: 1px solid var(--border-color); opacity: 0.6; background: var(--bg-secondary);' : 'border-bottom: 1px solid var(--border-color);'">
                                                        <!-- D√°vka -->
                                                        <td style="padding: 0.2rem;">
                                                            <div style="display: flex; align-items: center; gap: 0.2rem; flex-wrap: wrap;">
                                                                <span style="font-weight: 600;" x-text="batch.quantity + ' ks'"></span>
                                                                <span x-show="batch.is_frozen"
                                                                      style="background: var(--accent-green); color: white; padding: 0.1rem 0.2rem; border-radius: 2px; font-size: 0.55rem; font-weight: 600;"
                                                                      title="Zmrazeno - nelze mƒõnit">
                                                                    üîí FRZ
                                                                </span>
                                                            </div>
                                                        </td>
                                                        <!-- Materi√°l -->
                                                        <td class="fast-tip" style="padding: 0.2rem 0.4rem; text-align: right; color: var(--accent-green); font-weight: 600;"
                                                            :data-tip="(batch.material_price_per_kg || 0).toFixed(0) + ' Kƒç/kg'"
                                                            x-text="batch.material_cost.toFixed(0)"></td>
                                                        <!-- Kooperace -->
                                                        <td style="padding: 0.2rem 0.4rem; text-align: right; color: var(--accent-purple); font-weight: 600;"
                                                            x-text="batch.coop_cost.toFixed(0)"></td>
                                                        <!-- Bar n√°klad≈Ø (mat, koop, tp, tj) = 100% -->
                                                        <td style="padding: 0.2rem 0.5rem;">
                                                            <div style="position: relative; height: 12px; border-radius: 2px; overflow: hidden; background: var(--bg-tertiary); cursor: help; min-width: 70px;"
                                                                 :title="'Materi√°l: ' + batch.material_cost.toFixed(0) + ' Kƒç\nKooperace: ' + batch.coop_cost.toFixed(0) + ' Kƒç\ntp (se≈ô√≠zen√≠): ' + batch.setup_cost.toFixed(0) + ' Kƒç\ntj (v√Ωroba): ' + batch.machining_cost.toFixed(0) + ' Kƒç'">
                                                                <div style="display: flex; height: 100%;">
                                                                    <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.material_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-green);'"></div>
                                                                    <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.coop_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-purple);'"></div>
                                                                    <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.setup_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-yellow);'"></div>
                                                                    <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.machining_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-blue);'"></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <!-- Pr√°ce (tp + tj) -->
                                                        <td style="padding: 0.2rem; text-align: right; color: var(--accent-blue); font-weight: 600;"
                                                            :title="'tp (se≈ô√≠zen√≠): ' + batch.setup_cost.toFixed(0) + ' Kƒç\ntj (v√Ωroba): ' + batch.machining_cost.toFixed(0) + ' Kƒç'"
                                                            x-text="(batch.setup_cost + batch.machining_cost).toFixed(0)"></td>
                                                        <!-- Œ£ N√°klady -->
                                                        <td style="padding: 0.2rem; text-align: right; font-weight: 700; color: var(--text-primary);"
                                                            x-text="(batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost).toFixed(0)"></td>
                                                        <!-- Re≈æie -->
                                                        <td style="padding: 0.2rem; text-align: right; color: #ED8936; font-weight: 600;"
                                                            x-text="batch.overhead_cost.toFixed(0)"></td>
                                                        <!-- Mar≈æe -->
                                                        <td style="padding: 0.2rem; text-align: right; color: #E53E3E; font-weight: 600;"
                                                            x-text="batch.margin_cost.toFixed(0)"></td>
                                                        <!-- Cena/ks s hover pro celkovou cenu -->
                                                        <td class="fast-tip" style="padding: 0.2rem; text-align: right; font-weight: 700; color: var(--text-primary);"
                                                            :data-tip="'Œ£ ' + batch.total_cost.toFixed(0) + ' Kƒç'"
                                                            x-text="batch.unit_cost.toFixed(0)"></td>
                                                        <!-- Akce -->
                                                        <td style="padding: 0.2rem; text-align: center;">
                                                            <button x-show="!batch.is_frozen"
                                                                    @click="deleteBatch(batch)"
                                                                    style="padding: 0.15rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.65rem; opacity: 0.5; transition: all 0.2s;"
                                                                    @mouseenter="$el.style.opacity = '1'; $el.style.color = '#E53E3E'"
                                                                    @mouseleave="$el.style.opacity = '0.5'; $el.style.color = 'var(--text-muted)'"
                                                                    title="Smazat">‚úï</button>
                                                        </td>
                                                    </tr>
                                                </template>
                                                <tr x-show="batches.length === 0">
                                                    <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 0.8rem; font-size: 0.65rem;">
                                                        Zat√≠m ≈æ√°dn√© ceny
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <!-- Legenda - kompaktn√≠ -->
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.6rem; color: var(--text-muted); justify-content: center; flex-wrap: wrap; padding: 0.4rem; background: var(--bg-secondary); border-radius: 3px;">
                                            <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-green); border-radius: 1px;"></span>mat</span>
                                            <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-purple); border-radius: 1px;"></span>koop</span>
                                            <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-yellow); border-radius: 1px;"></span>tp</span>
                                            <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-blue); border-radius: 1px;"></span>tj</span>
                                        </div>

                                        <!-- P≈ôidat batch -->
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.4rem; align-items: center;">
                                            <input type="number" x-model.number="newBatchQty" placeholder="ks" min="1"
                                                   @keydown.enter="addBatch()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                                   style="width: 60px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; padding: 0.3rem; font-size: 0.7rem; color: var(--text-primary); text-align: center;">
                                            <button @click="addBatch()" class="btn-flat btn-add-op" style="font-size: 0.65rem; padding: 0.3rem 0.5rem;">
                                                + P≈ôidat
                                            </button>
                                        </div>

                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Generic Module Placeholder (fallback) -->
                        <template x-if="!['batch-sets', 'parts-list', 'part-material', 'part-operations', 'part-pricing'].includes(moduleType)">
                            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                <div style="font-size: 2rem; margin-bottom: 8px;" x-text="getModuleIcon(moduleType)"></div>
                                <div x-text="getModuleDescription(moduleType)"></div>
                                <div style="font-size: 0.7rem; margin-top: 8px;">
                                    Module ID: <span x-text="moduleId"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" x-show="!panel.minimized" @mousedown.stop="startResize(panel, $event)"></div>
            </div>
        </template>
    </div>

    <!-- Add Module Modal -->
    <template x-if="showAddModal">
        <div class="modal-overlay" @click.self="closeAddModal()">
            <div class="modal-content">
                <div class="modal-title">Pridat modul</div>

                <!-- Module Type Selection -->
                <div class="modal-section">
                    <label class="modal-label">Typ modulu</label>
                    <div class="module-grid">
                        <template x-for="mod in getAvailableModules()" :key="mod.type">
                            <div class="module-option"
                                 :class="{ 'selected': selectedModuleType === mod.type }"
                                 @click="selectedModuleType = mod.type">
                                <div class="module-option-icon" x-text="mod.icon"></div>
                                <div class="module-option-name" x-text="mod.description"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Link Color Selection -->
                <div class="modal-section">
                    <label class="modal-label">Link barva (volitelne)</label>
                    <div class="color-grid">
                        <div class="color-option none"
                             :class="{ 'selected': selectedLinkColor === null }"
                             @click="selectedLinkColor = null"
                             title="Bez linku">
                        </div>
                        <template x-for="color in getLinkColors()" :key="color">
                            <div class="color-option"
                                 :class="{ 'selected': selectedLinkColor === color }"
                                 :style="{ background: getColorCSS(color) }"
                                 :title="color"
                                 @click="selectedLinkColor = color">
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Actions -->
                <div class="modal-actions">
                    <button @click="closeAddModal()" class="btn-flat">Zrusit</button>
                    <button @click="confirmAddPanel()" class="btn-primary" :disabled="!selectedModuleType">
                        Pridat
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- New Workspace Modal -->
    <template x-if="showNewWorkspaceModal">
        <div class="modal-overlay" @click.self="showNewWorkspaceModal = false">
            <div class="modal-content">
                <div class="modal-title">Nov√Ω workspace</div>

                <div class="modal-section">
                    <label class="modal-label">N√°zev workspace</label>
                    <input type="text"
                           x-model="newWorkspaceName"
                           @keydown.enter="createWorkspace(newWorkspaceName); showNewWorkspaceModal = false; newWorkspaceName = ''"
                           placeholder="nap≈ô. Pricing Setup"
                           style="width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary);"
                           autofocus>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">
                        Max <span x-text="MAX_WORKSPACES"></span> workspaces celkem
                    </div>
                </div>

                <div class="modal-actions">
                    <button @click="showNewWorkspaceModal = false; newWorkspaceName = ''" class="btn-flat">
                        Zru≈°it
                    </button>
                    <button @click="createWorkspace(newWorkspaceName); showNewWorkspaceModal = false; newWorkspaceName = ''"
                            class="btn-primary"
                            :disabled="!newWorkspaceName.trim()">
                        Vytvo≈ôit
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- Save As Modal -->
    <template x-if="showSaveAsModal">
        <div class="modal-overlay" @click.self="showSaveAsModal = false">
            <div class="modal-content">
                <div class="modal-title">Ulo≈æit workspace jako...</div>

                <div class="modal-section">
                    <label class="modal-label">N√°zev nov√© kopie</label>
                    <input type="text"
                           x-model="newWorkspaceName"
                           @keydown.enter="saveWorkspaceAs(newWorkspaceName); showSaveAsModal = false; newWorkspaceName = ''"
                           placeholder="nap≈ô. Pricing Setup v2"
                           style="width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary);"
                           autofocus>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">
                        Vytvo≈ô√≠ kopii souƒçasn√©ho workspace s <span x-text="panels.length"></span> panely
                    </div>
                </div>

                <div class="modal-actions">
                    <button @click="showSaveAsModal = false; newWorkspaceName = ''" class="btn-flat">
                        Zru≈°it
                    </button>
                    <button @click="saveWorkspaceAs(newWorkspaceName); showSaveAsModal = false; newWorkspaceName = ''"
                            class="btn-primary"
                            :disabled="!newWorkspaceName.trim()">
                        Ulo≈æit
                    </button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
    // Helper to create module instance from panel config
    function createModuleInstance(panel) {
        if (window.ModuleRegistry && ModuleRegistry.has(panel.moduleType)) {
            return ModuleRegistry.create(panel.moduleType, {
                moduleId: panel.id,
                linkColor: panel.linkColor
            });
        }

        // Fallback for unknown modules
        return {
            moduleType: panel.moduleType,
            moduleId: panel.id,
            linkColor: panel.linkColor,
            init() {
            },
            getModuleIcon(type) {
                return window.ModuleRegistry?.getMeta(type)?.icon || 'üìÅ';
            },
            getModuleDescription(type) {
                return window.ModuleRegistry?.getMeta(type)?.description || type;
            }
        };
    }
</script>
{% endblock %}
