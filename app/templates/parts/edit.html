{% extends "base.html" %}

{% block title %}GESTIMA - {{ part.part_number }}{% endblock %}

{% block head %}
<style>
    /* Input focus highlight */
    input[type="number"]:focus {
        background: rgba(59, 130, 246, 0.15) !important;
        border-color: var(--accent-blue) !important;
        outline: none;
    }
    /* Fast CSS tooltip */
    .fast-tip {
        position: relative;
        cursor: help;
    }
    .fast-tip::after {
        content: attr(data-tip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.3rem 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.6rem;
        font-weight: normal;
        color: var(--text-primary);
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s, visibility 0.15s;
        z-index: 100;
        pointer-events: none;
    }
    .fast-tip:hover::after {
        opacity: 1;
        visibility: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="split-layout" x-data="partEdit({{ part.id }}, '{{ part.part_number }}')">

    <!-- LEFT PANEL (320px) -->
    <div class="left-panel">

        <!-- Z√°kladn√≠ √∫daje -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showBasic = !showBasic">
                <div class="ribbon-title">üìã Z√°kladn√≠ √∫daje</div>
                <div class="ribbon-toggle" x-text="showBasic ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showBasic">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.8rem;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">ID d√≠lu (auto)</label>
                        <div style="font-weight: 600; font-family: monospace; color: var(--text-secondary);">{{ part.part_number }}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">ƒå√≠slo v√Ωkresu</label>
                        <input type="text" x-model="partData.article_number" @input="debouncedSave()"
                               placeholder="nap≈ô. DWG-12345, V-2024-001..."
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">N√°zev</label>
                        <input type="text" x-model="partData.name" @input="debouncedSave()"
                               placeholder="N√°zev d√≠lu"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka obr√°bƒõn√© ƒç√°sti [mm]</label>
                        <input type="number" step="0.1" min="0" x-model.number="partData.length" @input="debouncedSave()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Materi√°l -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showMaterial = !showMaterial">
                <div class="ribbon-title">üî© Materi√°l</div>
                <div class="ribbon-toggle" x-text="showMaterial ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showMaterial">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.75rem;">

                    <!-- QUICK INPUT: Material Parser -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.75rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                        <div style="color: white; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.7rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîç Rychl√© zad√°n√≠ materi√°lu
                            <span style="font-weight: 400; font-size: 0.65rem; opacity: 0.9;">(nap≈ô. D20 C45 100mm)</span>
                        </div>
                        <div style="position: relative;">
                            <input
                                type="text"
                                x-model="quickMaterialInput"
                                @input="debouncedParseMaterial()"
                                @keydown.enter="applyParsedMaterial()"
                                placeholder="D20 C45 100mm, 20x30 S235 500, t2 1.4301..."
                                style="width: 100%; background: rgba(255,255,255,0.95); border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 0.5rem; font-size: 0.75rem; color: #2d3748; font-weight: 500;">
                            <div x-show="parsingMaterial" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 0.7rem;">
                                ‚è≥
                            </div>
                        </div>

                        <!-- Parse result -->
                        <template x-if="parseResult && parseResult.confidence > 0">
                            <div style="margin-top: 0.5rem; background: white; border-radius: 4px; padding: 0.5rem; font-size: 0.7rem;">
                                <!-- Status badge -->
                                <div style="margin-bottom: 0.5rem;">
                                    <span x-show="parseResult.confidence >= 0.7" style="background: #48bb78; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚úÖ ROZPOZN√ÅNO</span>
                                    <span x-show="parseResult.confidence >= 0.4 && parseResult.confidence < 0.7" style="background: #ed8936; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚ö†Ô∏è ƒå√ÅSTEƒåNƒö</span>
                                    <span x-show="parseResult.confidence < 0.4" style="background: #f56565; color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 600; font-size: 0.65rem;">‚ùå N√çZK√Å SHODA</span>
                                    <span style="float: right; color: #718096; font-size: 0.65rem;">
                                        Spolehlivost: <span x-text="Math.round(parseResult.confidence * 100) + '%'"></span>
                                    </span>
                                </div>

                                <!-- Recognized values -->
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 0.5rem; color: #2d3748;">
                                    <template x-if="parseResult.shape">
                                        <template>
                                            <strong>Tvar:</strong>
                                            <span x-text="formatShape(parseResult.shape)"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.diameter">
                                        <template>
                                            <strong>Pr≈Ømƒõr:</strong>
                                            <span x-text="parseResult.diameter + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.width">
                                        <template>
                                            <strong>≈†√≠≈ôka:</strong>
                                            <span x-text="parseResult.width + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.height && parseResult.height !== parseResult.width">
                                        <template>
                                            <strong>V√Ω≈°ka:</strong>
                                            <span x-text="parseResult.height + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.thickness">
                                        <template>
                                            <strong>Tlou≈°≈•ka:</strong>
                                            <span x-text="parseResult.thickness + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.wall_thickness">
                                        <template>
                                            <strong>Tl. stƒõny:</strong>
                                            <span x-text="parseResult.wall_thickness + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.length">
                                        <template>
                                            <strong>D√©lka:</strong>
                                            <span x-text="parseResult.length + ' mm'"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.suggested_material_group_name">
                                        <template>
                                            <strong>Materi√°l:</strong>
                                            <span x-text="parseResult.suggested_material_group_name"></span>
                                        </template>
                                    </template>
                                    <template x-if="parseResult.suggested_price_category_name">
                                        <template>
                                            <strong>Kategorie:</strong>
                                            <span x-text="parseResult.suggested_price_category_name"></span>
                                        </template>
                                    </template>
                                </div>

                                <!-- Action buttons -->
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <button
                                        @click="applyParsedMaterial()"
                                        :disabled="parseResult.confidence < 0.4"
                                        style="flex: 1; background: #667eea; color: white; border: none; border-radius: 4px; padding: 0.4rem; font-size: 0.7rem; font-weight: 600; cursor: pointer; opacity: 1;"
                                        :style="parseResult.confidence < 0.4 ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                                        Pou≈æ√≠t
                                    </button>
                                    <button
                                        @click="clearParseResult()"
                                        style="background: #e2e8f0; color: #4a5568; border: none; border-radius: 4px; padding: 0.4rem 0.75rem; font-size: 0.7rem; font-weight: 600; cursor: pointer;">
                                        Zru≈°it
                                    </button>
                                </div>
                            </div>
                        </template>

                        <div style="color: rgba(255,255,255,0.8); font-size: 0.65rem; margin-top: 0.5rem; font-style: italic;">
                            üí° Tip: Zadejte tvar (D20, 20x30, t2), normu (C45, 1.4301) a d√©lku (100mm)
                        </div>
                    </div>

                    <div style="text-align: center; color: var(--text-muted); font-size: 0.65rem; padding: 0.25rem 0;">
                        ‚îÄ‚îÄ‚îÄ NEBO manu√°lnƒõ ‚îÄ‚îÄ‚îÄ
                    </div>

                    <!-- 1. Typ polotovaru (PRVN√ç krok) -->
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">1. Typ polotovaru</label>
                        <select x-model="partData.stock_shape"
                                @change="debouncedSaveAndLoadStock()"
                                style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                            <option value="">- Vyberte typ -</option>
                            <option value="round_bar">Tyƒç kruhov√°</option>
                            <option value="flat_bar">Tyƒç ploch√°</option>
                            <option value="square_bar">Tyƒç ƒçtvercov√°</option>
                            <option value="hexagonal_bar">Tyƒç ≈°estihrann√°</option>
                            <option value="plate">Plech / Deska</option>
                            <option value="tube">Trubka</option>
                            <option value="casting">Odlitek</option>
                            <option value="forging">V√Ωkovek</option>
                        </select>
                    </div>

                    <!-- 2. Kategorie materi√°lu (FILTROVAN√Å podle typu) -->
                    <div x-show="partData.stock_shape">
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">2. Kategorie materi√°lu</label>
                        <select x-model.number="partData.price_category_id"
                                @change="selectMaterialCategory()"
                                style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                            <option value="">- Vyberte kategorii -</option>
                            <template x-for="item in filteredCategories" :key="item.id">
                                <option :value="item.id" :selected="item.id === partData.price_category_id" x-text="item.name + ' (' + (item.material_group?.name || '-') + ')'"></option>
                            </template>
                        </select>
                        <div x-show="filteredCategories.length === 0" style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;">
                            ≈Ω√°dn√© kategorie pro tento typ polotovaru
                        </div>
                    </div>

                    <!-- Selected Material Info -->
                    <div x-show="selectedMaterial" style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;" x-text="selectedMaterial?.name || '-'"></div>
                        <div style="color: var(--text-muted); font-size: 0.65rem;">
                            <span x-text="selectedMaterial?.material_group?.name || '-'"></span> |
                            Hustota: <span x-text="(selectedMaterial?.material_group?.density || 0).toFixed(2)"></span> kg/dm¬≥ |
                            <span style="font-style: italic;">Cena podle mno≈æstv√≠</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Polotovar (rozmƒõry) -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showStock = !showStock">
                <div class="ribbon-title">üìê Rozmƒõry polotovaru</div>
                <div class="ribbon-toggle" x-text="showStock ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showStock">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.75rem;">

                    <!-- ROUND_BAR, HEXAGONAL_BAR, CASTING, FORGING -->
                    <template x-if="['round_bar', 'hexagonal_bar', 'casting', 'forging'].includes(selectedShape)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- TUBE -->
                    <template x-if="selectedShape === 'tube'">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò vnƒõj≈°√≠ [mm]</label>
                                    <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSaveAndLoadStock()"
                                           style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Tlou≈°≈•ka stƒõny [mm]</label>
                                    <input type="number" step="0.1" min="0" x-model.number="partData.stock_wall_thickness" @input="debouncedSaveAndLoadStock()"
                                           style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                </div>
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- SQUARE_BAR -->
                    <template x-if="selectedShape === 'square_bar'">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Strana [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- FLAT_BAR, PLATE -->
                    <template x-if="['flat_bar', 'plate'].includes(selectedShape)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">≈†√≠≈ôka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">V√Ω≈°ka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_height" @input="debouncedSaveAndLoadStock()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- No material selected -->
                    <div x-show="!selectedShape" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.7rem;">
                        Vyberte polotovar
                    </div>

                    <!-- Copy from catalog button -->
                    <button x-show="selectedMaterial" @click="copyGeometryFromCatalog()"
                            class="btn-flat" style="font-size: 0.7rem; padding: 0.4rem 0.6rem; margin-top: 0.5rem;">
                        üìã Naƒç√≠st rozmƒõry z katalogu
                    </button>

                </div>
            </div>
        </div>

        <!-- N√°klady -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showPrice = !showPrice">
                <div class="ribbon-title">üí∞ N√°klady</div>
                <div class="ribbon-toggle" x-text="showPrice ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showPrice">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.75rem;">

                    <!-- Materi√°l/ks (konstantn√≠) -->
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted); font-weight: 600;">Materi√°l/ks:</span>
                            <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-green);" x-text="stockCost.cost.toFixed(0) + ' Kƒç'"></span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;">
                            <span x-text="stockCost.weight_kg.toFixed(3) + ' kg'"></span> √ó
                            <span x-text="stockCost.price_per_kg.toFixed(0) + ' Kƒç/kg'"></span>
                        </div>
                    </div>

                    <!-- Kooperace celkov√° -->
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted); font-weight: 600;">Kooperace:</span>
                            <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-purple);" x-text="totalCoopCost.toFixed(0) + ' Kƒç'"></span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;" x-show="coopOperations > 0">
                            <span x-text="coopOperations"></span> kooperaƒçn√≠ch operac√≠
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;" x-show="coopOperations === 0">
                            ≈Ω√°dn√© kooperace
                        </div>
                    </div>

                    <!-- Detail polotovaru (collapsible) -->
                    <div x-data="{ showDetail: false }" style="margin-top: 0.5rem;">
                        <button @click="showDetail = !showDetail"
                                style="width: 100%; background: none; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; color: var(--text-secondary); font-size: 0.7rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <span>Detail polotovaru</span>
                            <span x-text="showDetail ? '‚ñº' : '‚ñ∂'"></span>
                        </button>
                        <div x-show="showDetail" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--text-muted);">Objem:</span>
                                <span x-text="(stockCost.volume_mm3 / 1000).toFixed(1) + ' cm¬≥'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--text-muted);">Hmotnost:</span>
                                <span x-text="stockCost.weight_kg.toFixed(3) + ' kg'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Hustota:</span>
                                <span x-text="(selectedMaterial?.group?.density || 0).toFixed(2) + ' kg/dm¬≥'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tlaƒç√≠tko zpƒõt -->
        <a href="/parts" hx-boost="false" class="btn-flat" style="text-decoration: none; text-align: center; margin-top: 1rem;">
            ‚Üê Zpƒõt na seznam
        </a>

    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">

        <!-- Cenov√Ω p≈ôehled (STICKY RIBBON) -->
        <div class="right-panel-sticky">
            <div class="ribbon">
                <div class="ribbon-header" @click="showBatches = !showBatches">
                    <div class="ribbon-title">üí∞ Cenov√Ω p≈ôehled</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="showPriceDetail = true"
                                class="btn-flat"
                                style="font-size: 0.7rem; padding: 0.3rem 0.6rem;"
                                title="Zobrazit detail v≈°ech cen">
                            üìä Detail
                        </button>
                        <div class="ribbon-toggle" x-text="showBatches ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showBatches">
                    <!-- Batch Set Selector + Freeze Button -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center;">
                        <div style="flex: 1;">
                            <select x-model="selectedBatchSetId"
                                    @change="loadBatches()"
                                    style="width: 100%; padding: 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.7rem;">
                                <option value="">üìù Voln√© ≈°ar≈æe (rozpracov√°no)</option>
                                <template x-for="set in batchSets" :key="set.id">
                                    <option :value="set.id" x-text="'üì¶ ' + set.set_number + ' - ' + set.name + ' (' + set.batch_count + ' ks)'"></option>
                                </template>
                            </select>
                        </div>
                        <button x-show="selectedBatchSetId === '' && looseBatchCount > 0"
                                @click="freezeLooseBatches()"
                                class="btn-flat"
                                style="font-size: 0.7rem; padding: 0.4rem 0.6rem; white-space: nowrap; background: var(--accent-green); color: white;"
                                :title="'Zmrazit ' + looseBatchCount + ' voln√Ωch ≈°ar≈æ√≠ jako sadu'">
                            <span x-text="'üì¶ Zmrazit (' + looseBatchCount + ')'"></span>
                        </button>
                    </div>

                    <!-- Tabulka cen - kompaktn√≠ -->
                    <table style="width: 100%; font-size: 0.65rem; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="padding: 0.2rem; text-align: left; color: var(--text-muted); font-weight: 600;">D√°vka</th>
                                <th style="padding: 0.2rem 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">Mat</th>
                                <th style="padding: 0.2rem 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">Koop</th>
                                <th style="padding: 0.2rem 0.5rem; text-align: center; color: var(--text-muted); font-weight: 600;">Rozlo≈æen√≠</th>
                                <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Pr√°ce</th>
                                <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Œ£ N√°kl</th>
                                <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Re≈æie</th>
                                <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Mar≈æe</th>
                                <th style="padding: 0.2rem; text-align: right; color: var(--text-muted); font-weight: 600;">Cena/ks</th>
                                <th style="padding: 0.2rem; width: 24px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="batch in batches" :key="batch.id">
                                <tr :style="batch.is_frozen ? 'border-bottom: 1px solid var(--border-color); opacity: 0.6; background: var(--bg-secondary);' : 'border-bottom: 1px solid var(--border-color);'">
                                    <!-- D√°vka -->
                                    <td style="padding: 0.2rem;">
                                        <div style="display: flex; align-items: center; gap: 0.2rem; flex-wrap: wrap;">
                                            <span style="font-weight: 600;" x-text="batch.quantity + ' ks'"></span>
                                            <span x-show="batch.is_frozen"
                                                  style="background: var(--accent-green); color: white; padding: 0.1rem 0.2rem; border-radius: 2px; font-size: 0.55rem; font-weight: 600;"
                                                  title="Zmrazeno - nelze mƒõnit">
                                                üîí FRZ
                                            </span>
                                        </div>
                                    </td>
                                    <!-- Materi√°l -->
                                    <td class="fast-tip" style="padding: 0.2rem 0.4rem; text-align: right; color: var(--accent-green); font-weight: 600;"
                                        :data-tip="(batch.material_price_per_kg || 0).toFixed(0) + ' Kƒç/kg'"
                                        x-text="batch.material_cost.toFixed(0)"></td>
                                    <!-- Kooperace -->
                                    <td style="padding: 0.2rem 0.4rem; text-align: right; color: var(--accent-purple); font-weight: 600;"
                                        x-text="batch.coop_cost.toFixed(0)"></td>
                                    <!-- Bar n√°klad≈Ø (mat, koop, tp, tj) = 100% -->
                                    <td style="padding: 0.2rem 0.5rem;">
                                        <div style="position: relative; height: 12px; border-radius: 2px; overflow: hidden; background: var(--bg-tertiary); cursor: help; min-width: 70px;"
                                             :title="'Materi√°l: ' + batch.material_cost.toFixed(0) + ' Kƒç\nKooperace: ' + batch.coop_cost.toFixed(0) + ' Kƒç\ntp (se≈ô√≠zen√≠): ' + batch.setup_cost.toFixed(0) + ' Kƒç\ntj (v√Ωroba): ' + batch.machining_cost.toFixed(0) + ' Kƒç'">
                                            <div style="display: flex; height: 100%;">
                                                <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.material_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-green);'"></div>
                                                <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.coop_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-purple);'"></div>
                                                <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.setup_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-yellow);'"></div>
                                                <div :style="'width: ' + ((batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) > 0 ? (batch.machining_cost / (batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost) * 100) : 0) + '%; background: var(--accent-blue);'"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <!-- Pr√°ce (tp + tj) -->
                                    <td style="padding: 0.2rem; text-align: right; color: var(--accent-blue); font-weight: 600;"
                                        :title="'tp (se≈ô√≠zen√≠): ' + batch.setup_cost.toFixed(0) + ' Kƒç\ntj (v√Ωroba): ' + batch.machining_cost.toFixed(0) + ' Kƒç'"
                                        x-text="(batch.setup_cost + batch.machining_cost).toFixed(0)"></td>
                                    <!-- Œ£ N√°klady -->
                                    <td style="padding: 0.2rem; text-align: right; font-weight: 700; color: var(--text-primary);"
                                        x-text="(batch.material_cost + batch.coop_cost + batch.setup_cost + batch.machining_cost).toFixed(0)"></td>
                                    <!-- Re≈æie -->
                                    <td style="padding: 0.2rem; text-align: right; color: #ED8936; font-weight: 600;"
                                        x-text="batch.overhead_cost.toFixed(0)"></td>
                                    <!-- Mar≈æe -->
                                    <td style="padding: 0.2rem; text-align: right; color: #E53E3E; font-weight: 600;"
                                        x-text="batch.margin_cost.toFixed(0)"></td>
                                    <!-- Cena/ks s hover pro celkovou cenu -->
                                    <td class="fast-tip" style="padding: 0.2rem; text-align: right; font-weight: 700; color: var(--text-primary);"
                                        :data-tip="'Œ£ ' + batch.total_cost.toFixed(0) + ' Kƒç'"
                                        x-text="batch.unit_cost.toFixed(0)"></td>
                                    <!-- Akce -->
                                    <td style="padding: 0.2rem; text-align: center;">
                                        <button x-show="!batch.is_frozen"
                                                @click="deleteBatch(batch)"
                                                style="padding: 0.15rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.65rem; opacity: 0.5; transition: all 0.2s;"
                                                @mouseenter="$el.style.opacity = '1'; $el.style.color = '#E53E3E'"
                                                @mouseleave="$el.style.opacity = '0.5'; $el.style.color = 'var(--text-muted)'"
                                                title="Smazat">‚úï</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="batches.length === 0">
                                <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 0.8rem; font-size: 0.65rem;">
                                    Zat√≠m ≈æ√°dn√© ceny
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Legenda - kompaktn√≠ -->
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.6rem; color: var(--text-muted); justify-content: center; flex-wrap: wrap; padding: 0.4rem; background: var(--bg-secondary); border-radius: 3px;">
                        <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-green); border-radius: 1px;"></span>mat</span>
                        <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-purple); border-radius: 1px;"></span>koop</span>
                        <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-yellow); border-radius: 1px;"></span>tp</span>
                        <span style="display: flex; align-items: center; gap: 0.2rem;"><span style="width: 8px; height: 6px; background: var(--accent-blue); border-radius: 1px;"></span>tj</span>
                    </div>

                    <!-- P≈ôidat batch (pouze pro voln√© ≈°ar≈æe) -->
                    <div x-show="selectedBatchSetId === ''" style="margin-top: 0.5rem; display: flex; gap: 0.4rem; align-items: center;">
                        <input type="number" x-model.number="newBatchQty" placeholder="ks" min="1"
                               @keydown.enter="addBatch()" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                               style="width: 60px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; padding: 0.3rem; font-size: 0.7rem; color: var(--text-primary); text-align: center;">
                        <button @click="addBatch()" class="btn-flat btn-add-op" style="font-size: 0.65rem; padding: 0.3rem 0.5rem;">
                            + P≈ôidat
                        </button>
                    </div>

                    <!-- Info when viewing frozen set -->
                    <div x-show="selectedBatchSetId !== ''" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.7rem; color: var(--text-muted); text-align: center;">
                        üîí Prohl√≠≈æ√≠te zmrazenou sadu. Pro editaci p≈ôepnƒõte na "Voln√© ≈°ar≈æe".
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollovateln√Ω obsah -->
        <div class="right-panel-content">

            <!-- Sady cen (ADR-022) -->
            <div class="ribbon" style="margin-bottom: 1rem;">
                <div class="ribbon-header" @click="showBatchSets = !showBatchSets">
                    <div class="ribbon-title">üì¶ Sady cen</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="createBatchSet()" class="btn-flat" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            ‚ûï P≈ôidat sadu
                        </button>
                        <div class="ribbon-toggle" x-text="showBatchSets ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showBatchSets">
                    <!-- BatchSets Table -->
                    <template x-if="batchSets.length > 0">
                        <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; color: var(--text-secondary);">ƒå√≠slo sady</th>
                                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; color: var(--text-secondary);">N√°zev</th>
                                    <th style="padding: 0.5rem; text-align: center; font-weight: 600; color: var(--text-secondary);">D√°vky</th>
                                    <th style="padding: 0.5rem; text-align: center; font-weight: 600; color: var(--text-secondary);">Stav</th>
                                    <th style="padding: 0.5rem; text-align: center; font-weight: 600; color: var(--text-secondary);">Akce</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="set in batchSets" :key="set.id">
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 0.5rem;">
                                            <a :href="'/pricing/batch-sets/' + set.id" style="color: var(--accent-blue); text-decoration: none; font-weight: 500;" x-text="set.set_number"></a>
                                        </td>
                                        <td style="padding: 0.5rem; color: var(--text-primary);" x-text="set.name"></td>
                                        <td style="padding: 0.5rem; text-align: center;">
                                            <span style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;" x-text="set.batch_count || 0"></span>
                                        </td>
                                        <td style="padding: 0.5rem; text-align: center;">
                                            <span :style="{
                                                    background: set.status === 'frozen' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                                                    color: set.status === 'frozen' ? 'var(--accent-blue)' : 'var(--accent-green)',
                                                    padding: '0.25rem 0.5rem',
                                                    borderRadius: '4px',
                                                    fontSize: '0.7rem',
                                                    fontWeight: '500'
                                                  }"
                                                  x-text="set.status === 'frozen' ? '‚ùÑÔ∏è' : 'üìù'">
                                            </span>
                                        </td>
                                        <td style="padding: 0.5rem; text-align: center;">
                                            <a :href="'/pricing/batch-sets/' + set.id" class="btn-flat" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                                Detail
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                    <!-- Empty State -->
                    <div x-show="batchSets.length === 0" style="text-align: center; padding: 1.5rem; color: var(--text-muted); font-size: 0.8rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
                        <div>Zat√≠m ≈æ√°dn√© sady cen</div>
                        <div style="font-size: 0.7rem; margin-top: 0.25rem;">Kliknƒõte na "‚ûï P≈ôidat sadu" pro vytvo≈ôen√≠.</div>
                    </div>
                </div>
            </div>

            <!-- ƒåas na kus (detailn√≠ rozklad podle kategori√≠) -->
            <div class="ribbon" style="margin-bottom: 1rem;">
                <div class="ribbon-header" @click="showTime = !showTime">
                    <div class="ribbon-title">‚è±Ô∏è ƒåas na kus</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; font-weight: 600;">
                            <span style="color: var(--accent-yellow);" x-text="'tp ' + totalSetupTime.toFixed(1)"></span>
                            <span style="color: var(--accent-blue);" x-text="'tj ' + totalOperationTime.toFixed(1)"></span>
                        </div>
                        <div class="ribbon-toggle" x-text="showTime ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showTime">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Rozklad podle kategori√≠ operac√≠ -->
                        <template x-for="category in timeBreakdown" :key="category.type">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <!-- Label -->
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="font-weight: 600;" x-text="category.label"></span>
                                    <span style="color: var(--text-muted);">
                                        <span style="font-size: 0.7rem;">
                                            tp <span x-text="category.setup_time.toFixed(1)"></span> + tj <span x-text="category.operation_time.toFixed(1)"></span>
                                        </span>
                                    </span>
                                </div>
                                <!-- Bar -->
                                <div style="display: flex; height: 6px; border-radius: 3px; overflow: hidden; background: var(--bg-secondary);">
                                    <div :style="`width: ${(category.setup_time / totalTimeWithSetup * 100).toFixed(1)}%; background: var(--accent-yellow);`"
                                         :title="'tp: ' + category.setup_time.toFixed(1) + ' min'"></div>
                                    <div :style="`width: ${(category.operation_time / totalTimeWithSetup * 100).toFixed(1)}%; background: var(--accent-blue);`"
                                         :title="'tj: ' + category.operation_time.toFixed(1) + ' min'"></div>
                                </div>
                            </div>
                        </template>

                        <!-- Legenda -->
                        <div style="display: flex; gap: 1rem; margin-top: 0.25rem; font-size: 0.65rem; color: var(--text-muted); justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 6px; background: var(--accent-yellow); border-radius: 2px;"></div>
                                <span>tp (se≈ô√≠zen√≠)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div style="width: 12px; height: 6px; background: var(--accent-blue); border-radius: 2px;"></div>
                                <span>tj (v√Ωroba)</span>
                            </div>
                        </div>

                        <!-- Empty state -->
                        <div x-show="timeBreakdown.length === 0" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.75rem;">
                            ≈Ω√°dn√© operace
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug - V√Ωpoƒçet ceny (RIBBON) -->
            <div class="ribbon" style="margin-bottom: 1rem;">
                <div class="ribbon-header" @click="showPriceDebug = !showPriceDebug">
                    <div class="ribbon-title">üîç Debug - V√Ωpoƒçet ceny</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="loadPriceBreakdowns()"
                                class="btn-flat"
                                style="font-size: 0.7rem; padding: 0.3rem 0.6rem;"
                                :disabled="loadingBreakdowns">
                            <span x-show="!loadingBreakdowns">üìä Naƒç√≠st breakdown</span>
                            <span x-show="loadingBreakdowns">‚è≥ Naƒç√≠t√°m...</span>
                        </button>
                        <div class="ribbon-toggle" x-text="showPriceDebug ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                    </div>
                </div>

                <div class="ribbon-body" x-show="showPriceDebug" style="padding: 0.5rem;">
                    <!-- Breakdowns tabulka -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; font-size: 0.65rem; border-collapse: collapse;" x-show="priceBreakdowns.length > 0">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color); background: var(--bg-secondary);">
                                    <th style="padding: 0.4rem; text-align: left; font-weight: 600;">D√°vka</th>
                                    <th style="padding: 0.4rem; text-align: left; font-weight: 600; min-width: 450px;">Cesta v√Ωpoƒçtu (krok po kroku)</th>
                                    <th style="padding: 0.4rem; text-align: right; font-weight: 600; background: var(--accent-blue); color: white;">Cena/ks</th>
                                    <th style="padding: 0.4rem; text-align: right; font-weight: 600; background: var(--accent-green); color: white;">Celkem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="breakdown in priceBreakdowns" :key="breakdown.quantity">
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 0.4rem; font-weight: 600; vertical-align: top;" x-text="breakdown.quantity + ' ks'"></td>
                                        <td style="padding: 0.4rem; font-family: monospace; font-size: 0.6rem; line-height: 1.6; color: var(--text-secondary); vertical-align: top;">
                                            <!-- V√Ωpoƒçet krok po kroku -->
                                            <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                                <div>
                                                    <strong style="color: var(--accent-blue);">1. Stroje:</strong>
                                                    (Setup <span x-text="breakdown.machine_setup_time_min.toFixed(1)"></span>min √ó <span x-text="(breakdown.machine_setup_cost/breakdown.machine_setup_time_min*60).toFixed(0)"></span> Kƒç/h = <span x-text="(breakdown.machine_setup_cost/breakdown.quantity).toFixed(0)"></span> Kƒç)
                                                    + (Operace <span x-text="breakdown.machine_operation_time_min.toFixed(1)"></span>min √ó <span x-text="(breakdown.machine_operation_cost/breakdown.machine_operation_time_min*60).toFixed(0)"></span> Kƒç/h = <span x-text="(breakdown.machine_operation_cost/breakdown.quantity).toFixed(0)"></span> Kƒç)
                                                    = <strong x-text="(breakdown.machine_total/breakdown.quantity).toFixed(0)"></strong> Kƒç/ks
                                                </div>
                                                <div>
                                                    <strong style="color: #ED8936;">2. + Re≈æie:</strong>
                                                    <span x-text="(breakdown.machine_total/breakdown.quantity).toFixed(0)"></span> Kƒç √ó <span x-text="breakdown.overhead_coefficient.toFixed(2)"></span>
                                                    = <span x-text="(breakdown.work_with_overhead/breakdown.quantity).toFixed(0)"></span> Kƒç
                                                    (+<span x-text="(breakdown.overhead_markup/breakdown.quantity).toFixed(0)"></span> Kƒç)
                                                </div>
                                                <div>
                                                    <strong style="color: #E53E3E;">3. + Mar≈æe:</strong>
                                                    <span x-text="(breakdown.work_with_overhead/breakdown.quantity).toFixed(0)"></span> Kƒç √ó <span x-text="breakdown.margin_coefficient.toFixed(2)"></span>
                                                    = <span x-text="(breakdown.work_with_margin/breakdown.quantity).toFixed(0)"></span> Kƒç
                                                    (+<span x-text="(breakdown.margin_markup/breakdown.quantity).toFixed(0)"></span> Kƒç)
                                                </div>
                                                <div x-show="breakdown.coop_cost > 0">
                                                    <strong style="color: #9F7AEA;">4. + Kooperace:</strong>
                                                    <span x-text="breakdown.coop_cost_raw.toFixed(0)"></span> Kƒç √ó <span x-text="breakdown.coop_coefficient.toFixed(2)"></span>
                                                    = <span x-text="(breakdown.coop_cost/breakdown.quantity).toFixed(0)"></span> Kƒç/ks
                                                </div>
                                                <div>
                                                    <strong style="color: #48BB78;">5. + Materi√°l:</strong>
                                                    <span x-text="breakdown.material_cost_raw.toFixed(0)"></span> Kƒç √ó <span x-text="breakdown.stock_coefficient.toFixed(2)"></span>
                                                    = <span x-text="(breakdown.material_cost/breakdown.quantity).toFixed(0)"></span> Kƒç/ks
                                                </div>
                                                <div style="margin-top: 0.25rem; padding-top: 0.25rem; border-top: 1px solid var(--border-color);">
                                                    <strong style="color: var(--text-primary);">V√ùSLEDEK:</strong>
                                                    <span x-text="(breakdown.work_with_margin/breakdown.quantity).toFixed(0)"></span> +
                                                    <span x-text="(breakdown.coop_cost/breakdown.quantity).toFixed(0)"></span> +
                                                    <span x-text="(breakdown.material_cost/breakdown.quantity).toFixed(0)"></span>
                                                    = <strong style="color: var(--accent-blue);" x-text="breakdown.cost_per_piece.toFixed(0)"></strong> Kƒç/ks
                                                </div>
                                            </div>
                                        </td>
                                        <td style="padding: 0.4rem; text-align: right; font-weight: 700; font-size: 0.85rem; color: var(--accent-blue); vertical-align: top;" x-text="breakdown.cost_per_piece.toFixed(0) + ' Kƒç'"></td>
                                        <td style="padding: 0.4rem; text-align: right; font-weight: 700; font-size: 0.85rem; color: var(--accent-green); vertical-align: top;" x-text="breakdown.total_cost.toFixed(0) + ' Kƒç'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Legenda -->
                    <div x-show="priceBreakdowns.length > 0" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.65rem; color: var(--text-muted);">
                        <strong>Popis:</strong> Ka≈æd√Ω ≈ô√°dek ukazuje kompletn√≠ cestu v√Ωpoƒçtu od ƒças≈Ø stroj≈Ø p≈ôes koeficienty a≈æ k v√Ωsledn√© cenƒõ. Hodnoty jsou zaokrouhlen√© na cel√© Kƒç.
                    </div>

                    <!-- Empty state -->
                    <div x-show="priceBreakdowns.length === 0" style="text-align: center; color: var(--text-muted); padding: 1.5rem; font-size: 0.75rem;">
                        üìä Klikni na "Naƒç√≠st breakdown" pro zobrazen√≠ detailn√≠ho v√Ωpoƒçtu
                    </div>
                </div>
            </div>

            <!-- Operace (RIBBON) -->
            <div class="ribbon" style="margin-bottom: 1rem;">
                <div class="ribbon-header" @click="showOperations = !showOperations">
                    <div class="ribbon-title">
                        üîß OPERACE (<span x-text="operations.length">0</span>)
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="addOperation" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                            + P≈ôidat operaci
                        </button>
                        <div class="ribbon-toggle" x-text="showOperations ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>

                <div class="ribbon-body" x-show="showOperations" style="padding: 0.5rem;">
                    <!-- Seznam operac√≠ -->
                    <template x-for="(op, index) in operations" :key="op.id">
                        <div class="operation-card" x-data="{ expanded: false }">
                            <!-- Header (editovateln√Ω inline) -->
                            <div class="op-header" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px;">
                                <!-- Seq + Icon -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div class="op-seq" x-text="op.seq"></div>
                                    <div class="op-icon" x-text="op.icon"></div>
                                </div>

                                <!-- Pracovi≈°tƒõ (editovateln√Ω dropdown) -->
                                <div @click.stop style="flex: 1; min-width: 180px;">
                                    <select x-model.number="op.work_center_id"
                                            @change="updateOperationFromWorkCenter(op); debouncedUpdateOperation(op)"
                                            style="width: 100%; padding: 0.35rem 0.5rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem; font-weight: 500;">
                                        <option value="">- Vyberte pracovi≈°tƒõ -</option>
                                        <template x-for="workCenter in workCenters" :key="workCenter.id">
                                            <option :value="workCenter.id" :selected="workCenter.id === op.work_center_id" x-text="workCenter.name"></option>
                                        </template>
                                    </select>
                                </div>

                                <!-- tp - se≈ôizovac√≠ ƒças (editovateln√Ω inline) -->
                                <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="color: var(--accent-yellow); font-size: 0.7rem; font-weight: 600;">tp:</span>
                                    <input type="number" step="0.1" min="0" x-model.number="op.setup_time_min"
                                           @input="debouncedUpdateOperation(op)" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                           style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                </div>

                                <!-- tj - v√Ωrobn√≠ ƒças (editovateln√Ω inline) -->
                                <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="color: var(--accent-blue); font-size: 0.7rem; font-weight: 600;">tj:</span>
                                    <input type="number" step="0.1" min="0" x-model.number="op.operation_time_min"
                                           @input="debouncedUpdateOperation(op)" @focus="$el.dataset.fresh = 'true'" @keydown="if($el.dataset.fresh === 'true' && $event.key.length === 1 && !$event.ctrlKey && !$event.metaKey) { $el.value = ''; $el.dataset.fresh = 'false' }" @blur="$el.dataset.fresh = 'false'"
                                           style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                </div>

                                <!-- Maz√°n√≠ operace -->
                                <button @click.stop="deleteOperation(op)"
                                        style="padding: 0.25rem 0.4rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem; opacity: 0.6; transition: opacity 0.2s;"
                                        @mouseenter="$el.style.opacity = '1'; $el.style.color = '#E53E3E'"
                                        @mouseleave="$el.style.opacity = '0.6'; $el.style.color = 'var(--text-muted)'"
                                        title="Smazat operaci">üóëÔ∏è</button>

                                <!-- Expand indicator (pro features) -->
                                <div @click="expanded = !expanded" style="font-size: 0.7rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem;" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                            </div>

                            <!-- Features (rozbalovac√≠) -->
                            <div class="features-section" x-show="expanded" x-collapse>
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                    <!-- Mode buttons -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Re≈æim ≈ôez√°n√≠</label>
                                        <div class="mode-buttons-inline">
                                            <button @click="changeMode(op, 'low')"
                                                    :class="{ 'active': op.cutting_mode === 'low' }"
                                                    class="mode-btn-sm mode-low">LOW</button>
                                            <button @click="changeMode(op, 'mid')"
                                                    :class="{ 'active': op.cutting_mode === 'mid' }"
                                                    class="mode-btn-sm mode-mid">MID</button>
                                            <button @click="changeMode(op, 'high')"
                                                    :class="{ 'active': op.cutting_mode === 'high' }"
                                                    class="mode-btn-sm mode-high">HIGH</button>
                                        </div>
                                    </div>

                                    <!-- Features placeholder -->
                                    <div class="no-features">
                                        üìù Kroky operace (zat√≠m neimplementov√°no)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Pr√°zdn√Ω stav -->
                    <div x-show="operations.length === 0"
                         style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">üîß Zat√≠m ≈æ√°dn√© operace</div>
                        <div style="font-size: 0.75rem;">Klikni na "+ P≈ôidat operaci" pro zaƒç√°tek</div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Modal - Detail cen v≈°ech d√°vek -->
    <div x-show="showPriceDetail"
         @click.self="showPriceDetail = false"
         style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;"
         x-transition>
        <div @click.stop
             style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 680px; max-height: 85vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                <h2 style="font-size: 1rem; font-weight: 700; color: var(--text-primary);">üìä Detail cen v≈°ech d√°vek</h2>
                <button @click="showPriceDetail = false"
                        style="background: var(--bg-secondary); border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; padding: 0.25rem 0.5rem; line-height: 1; border-radius: 4px; transition: all 0.2s;"
                        @mouseenter="$el.style.background = 'var(--bg-tertiary)'; $el.style.color = 'var(--text-primary)'"
                        @mouseleave="$el.style.background = 'var(--bg-secondary)'; $el.style.color = 'var(--text-muted)'"
                        title="Zav≈ô√≠t">√ó</button>
            </div>

            <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 0.5rem; text-align: left; color: var(--text-muted); font-weight: 600;">D√°vka</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Materi√°l</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;" title="V√Ωrobn√≠ ƒças">tp</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;" title="Se≈ôizovac√≠ ƒças">tj</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Koop</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">CELKEM</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="batch in batches" :key="batch.id">
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <span x-text="batch.quantity + ' ks'"></span>
                                    <span x-show="batch.is_frozen"
                                          style="background: var(--accent-green); color: white; padding: 0.15rem 0.35rem; border-radius: 3px; font-size: 0.6rem; font-weight: 600;">
                                        ZMRAZENO
                                    </span>
                                </div>
                            </td>
                            <td style="padding: 0.5rem; text-align: right;">
                                <span x-text="batch.material_cost.toFixed(0) + ' Kƒç'"></span>
                                <span x-show="batch.material_price_per_kg"
                                      style="color: var(--text-muted); font-size: 0.7rem;"
                                      x-text="' (' + (batch.material_price_per_kg || 0).toFixed(0) + ' Kƒç/kg)'"></span>
                            </td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.machining_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.setup_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.coop_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right; font-weight: 700; color: var(--accent-blue);"
                                x-text="batch.unit_cost.toFixed(0) + ' Kƒç'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
function partEdit(partId, partNumber) {
    return {
        partId: partId,
        partNumber: partNumber,

        // UI state
        showBasic: true,
        showMaterial: true,
        showStock: true,
        showPrice: true,
        showBatches: true,
        showBatchSets: true,
        showTime: true,
        showOperations: true,
        showPriceDetail: false,
        showPriceDebug: false,  // Debug ribbon (ADR-016)

        // Price breakdown debug (ADR-016)
        priceBreakdowns: [],
        loadingBreakdowns: false,

        // Part data
        partData: {
            article_number: '',
            name: '',
            material_item_id: null,
            price_category_id: null,
            length: 0,
            notes: '',
            stock_shape: null,
            stock_diameter: null,
            stock_length: null,
            stock_width: null,
            stock_height: null,
            stock_wall_thickness: null,
            version: 0
        },

        // Material selection
        materialItems: [],
        selectedMaterial: null,

        // Material parser (quick input)
        quickMaterialInput: '',
        parseResult: null,
        parsingMaterial: false,
        parseTimeout: null,

        // Work Centers
        workCenters: [],

        // Computed
        get selectedShape() {
            // Migration 2026-01-26: Part.stock_shape m√≠sto selectedMaterial.shape
            return this.partData.stock_shape || null;
        },

        get filteredCategories() {
            // Filtrovat kategorie podle stock_shape
            if (!this.partData.stock_shape) {
                return this.materialItems; // Pokud nen√≠ shape, zobraz v≈°e
            }

            // Mapping: shape ‚Üí category code suffix (pro spr√°vn√Ω v√Ωbƒõr cenov√© kategorie!)
            const shapeToSuffix = {
                'round_bar': ['KRUHOVA', 'BRONZ'],       // OCEL-KRUHOVA, MOSAZ-BRONZ
                'square_bar': ['CTVEREC'],                // OCEL-KONS-CTVEREC, NEREZ-CTVEREC, HLINIK-CTVEREC
                'hexagonal_bar': ['KRUHOVA', 'SESTIH'],  // OCEL-KRUHOVA (obsahuje ≈°estihran v n√°zvu)
                'flat_bar': ['PLOCHA'],                   // OCEL-PLOCHA, NEREZ-PLOCHA, HLINIK-PLOCHA
                'plate': ['DESKY'],                       // OCEL-DESKY, HLINIK-DESKY, PLASTY-DESKY
                'tube': ['TRUBKA'],                       // OCEL-TRUBKA
                'casting': [],                            // ≈Ω√°dn√Ω filtr (zobraz v≈°e)
                'forging': []                             // ≈Ω√°dn√Ω filtr (zobraz v≈°e)
            };

            const suffixes = shapeToSuffix[this.partData.stock_shape];
            if (!suffixes || suffixes.length === 0) {
                return this.materialItems; // Fallback: ≈æ√°dn√Ω filtr definov√°n
            }

            // Filtrovat podle code suffix
            const filtered = this.materialItems.filter(item =>
                suffixes.some(suffix => item.code.includes(suffix))
            );

            // FALLBACK: Pokud filter nic nena≈°el, zobraz v≈°echny kategorie
            if (filtered.length === 0) {
                console.warn(`‚ö†Ô∏è No categories found for shape ${this.partData.stock_shape} with suffixes ${suffixes.join(', ')} - showing all`);
                return this.materialItems;
            }

            return filtered;
        },

        get totalCoopCost() {
            return this.operations
                .filter(op => op.is_coop)
                .reduce((sum, op) => sum + (op.coop_price || 0), 0);
        },

        get coopOperations() {
            return this.operations.filter(op => op.is_coop).length;
        },

        get totalSetupTime() {
            // Celkov√Ω ƒças se≈ô√≠zen√≠ (tj) - v≈°echny operace, bez coop
            return this.operations
                .filter(op => !op.is_coop)
                .reduce((sum, op) => sum + (op.setup_time_min || 0), 0);
        },

        get totalOperationTime() {
            // Celkov√Ω v√Ωrobn√≠ ƒças (tp) - v≈°echny operace, bez coop
            return this.operations
                .filter(op => !op.is_coop)
                .reduce((sum, op) => sum + (op.operation_time_min || 0), 0);
        },

        get totalTimeWithSetup() {
            // Celkov√Ω ƒças = se≈ô√≠zen√≠ + v√Ωroba (v≈°echny operace, bez coop)
            return this.totalSetupTime + this.totalOperationTime;
        },

        get timeBreakdown() {
            // Seskupit operace podle typu a spoƒç√≠tat ƒçasy
            const breakdown = {};
            const typeLabels = {
                'turning': 'üîÑ Soustru≈æen√≠',
                'milling': 'üî® Fr√©zov√°n√≠',
                'drilling': 'üî© Vrt√°n√≠',
                'grinding': '‚öôÔ∏è Brou≈°en√≠',
                'other': 'üîß Ostatn√≠'
            };

            // Filtrovat jen non-coop operations
            const machiningOps = this.operations.filter(op => !op.is_coop);

            machiningOps.forEach(op => {
                const type = op.type || 'other';
                if (!breakdown[type]) {
                    breakdown[type] = {
                        label: typeLabels[type] || 'üîß ' + type,
                        setup_time: 0,
                        operation_time: 0,
                        total_time: 0
                    };
                }
                breakdown[type].setup_time += op.setup_time_min || 0;
                breakdown[type].operation_time += op.operation_time_min || 0;
                breakdown[type].total_time += (op.setup_time_min || 0) + (op.operation_time_min || 0);
            });

            // P≈ôev√©st na array a se≈ôadit podle ƒçasu (descending)
            return Object.entries(breakdown)
                .map(([type, data]) => ({ type, ...data }))
                .sort((a, b) => b.total_time - a.total_time);
        },

        // Stock cost (from backend)
        stockCost: {
            volume_mm3: 0,
            weight_kg: 0,
            price_per_kg: 0,
            cost: 0,
            density: 0
        },

        // Operations & Batches
        operations: [],
        batches: [],
        batchSets: [],  // ADR-022: BatchSets for pricing
        selectedBatchSetId: '',  // '' = loose batches, number = specific set
        looseBatchCount: 0,  // Count of loose batches (for freeze button)
        totalTime: 0,
        newBatchQty: null,

        // Debounce timers
        saveTimeout: null,
        stockCostTimeout: null,
        operationUpdateTimeout: null,
        operationUpdateSequence: 0, // Track update order to ignore stale API responses
        hasPendingChanges: false, // Track unsaved changes for beforeunload warning
        pendingOperationSnapshot: null, // Store snapshot for sync flush on unload

        async init() {
            // Prevent data loss on quick navigation (L-017 + beforeunload)
            window.addEventListener('beforeunload', (e) => {
                if (this.hasPendingChanges || this.operationUpdateTimeout) {
                    // Browser native warning
                    e.preventDefault();
                    e.returnValue = ''; // Chrome requires this

                    // Best effort: Try to flush pending updates synchronously
                    if (this.pendingOperationSnapshot) {
                        this.flushPendingOperationSync();
                    }
                }
            });
            // 1. Load reference data
            await Promise.all([
                this.loadMaterialItems(),
                this.loadWorkCenters()
            ]);

            // 2. Load part with material item
            await this.loadPart();

            // 3. Load stock cost, operations, batches, batch sets
            await Promise.all([
                this.loadStockCost(),
                this.loadOperations(),
                this.loadBatches(),
                this.loadBatchSets()
            ]);
        },

        // Helper: Sort batches by quantity (ascending)
        sortBatches() {
            this.batches.sort((a, b) => a.quantity - b.quantity);
        },

        async loadMaterialItems() {
            try {
                const response = await fetch('/api/materials/price-categories');
                if (response.ok) {
                    this.materialItems = await response.json();
                    this.filteredMaterials = this.materialItems;
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load price categories:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st kategorie materi√°l≈Ø', 'error');
                }
            } catch (error) {
                console.error('Error loading price categories:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ kategori√≠ materi√°l≈Ø', 'error');
            }
        },

        async loadWorkCenters() {
            try {
                const response = await fetch('/api/data/work-centers');
                if (response.ok) {
                    this.workCenters = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load work centers:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st pracovi≈°tƒõ', 'error');
                }
            } catch (error) {
                console.error('Error loading work centers:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ pracovi≈°≈•', 'error');
            }
        },

        async loadPart() {
            try {
                const response = await fetch(`/api/parts/${this.partNumber}/full`);
                if (response.ok) {
                    const data = await response.json();
                    this.partData = {
                        article_number: data.article_number || '',
                        name: data.name || '',
                        material_item_id: data.material_item_id,
                        price_category_id: data.price_category_id,
                        length: data.length || 0,
                        notes: data.notes || '',
                        stock_shape: data.stock_shape,
                        stock_diameter: data.stock_diameter,
                        stock_length: data.stock_length,
                        stock_width: data.stock_width,
                        stock_height: data.stock_height,
                        stock_wall_thickness: data.stock_wall_thickness,
                        version: data.version
                    };

                    // Set selected material (Migration 2026-01-26: price_category m√≠sto material_item)
                    if (data.price_category) {
                        this.selectedMaterial = data.price_category;
                        this.materialSearch = data.price_category.name;
                    } else if (data.material_item) {
                        // Fallback pro star≈°√≠ parts s material_item
                        this.selectedMaterial = data.material_item;
                        this.materialSearch = data.material_item.name;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load part:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st d√≠l', 'error');
                }
            } catch (error) {
                console.error('Error loading part:', error);
                window.showToast('Kritick√° chyba p≈ôi naƒç√≠t√°n√≠ d√≠lu', 'error');
            }
        },

        async selectMaterialCategory() {
            // Naj√≠t vybranou kategorii
            const categoryId = this.partData.price_category_id;
            if (categoryId) {
                this.selectedMaterial = this.materialItems.find(item => item.id === categoryId);
            } else {
                this.selectedMaterial = null;
            }

            // Save immediately
            await this.savePart();
            await this.loadStockCost();
            await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ materi√°lu
        },

        // ========== MATERIAL PARSER METHODS ==========

        debouncedParseMaterial() {
            clearTimeout(this.parseTimeout);
            this.parsingMaterial = true;

            this.parseTimeout = setTimeout(async () => {
                await this.parseMaterialDescription();
                this.parsingMaterial = false;
            }, 500);
        },

        async parseMaterialDescription() {
            if (!this.quickMaterialInput || this.quickMaterialInput.trim().length < 2) {
                this.parseResult = null;
                return;
            }

            try {
                const params = new URLSearchParams({ description: this.quickMaterialInput.trim() });
                const response = await fetch(`/api/materials/parse?${params}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    this.parseResult = await response.json();
                } else {
                    console.error('Parse failed:', response.status);
                    this.parseResult = null;
                    window.showToast('Chyba p≈ôi rozpozn√°v√°n√≠ materi√°lu', 'error');
                }
            } catch (error) {
                console.error('Error parsing material:', error);
                this.parseResult = null;
                window.showToast('Chyba p≈ôi rozpozn√°v√°n√≠ materi√°lu', 'error');
            }
        },

        async applyParsedMaterial() {
            // RACE CONDITION FIX: Cancel pending parse and trigger immediate parse
            if (this.parseTimeout) {
                clearTimeout(this.parseTimeout);
                this.parseTimeout = null;
            }

            // If input exists but no parseResult, or parse is in progress, wait for fresh parse
            if (this.quickMaterialInput && this.quickMaterialInput.trim().length >= 2) {
                if (!this.parseResult || this.parsingMaterial) {
                    await this.parseMaterialDescription();
                }
            }

            if (!this.parseResult || this.parseResult.confidence < 0.4) {
                window.showToast('N√≠zk√° spolehlivost rozpozn√°n√≠ - zadejte materi√°l ruƒçnƒõ', 'warning');
                return;
            }

            // SNAPSHOT: Create a copy of parseResult to avoid race conditions with reactive proxy
            const parsed = JSON.parse(JSON.stringify(this.parseResult));

            try {
                // 1. Apply shape
                if (parsed.shape) {
                    this.partData.stock_shape = parsed.shape;
                }

                // 2. Apply dimensions
                if (parsed.diameter) {
                    this.partData.stock_diameter = parsed.diameter;
                }
                if (parsed.width) {
                    this.partData.stock_width = parsed.width;
                }
                if (parsed.height) {
                    this.partData.stock_height = parsed.height;
                }
                if (parsed.thickness) {
                    // For plate
                    this.partData.stock_height = parsed.thickness;
                }
                if (parsed.wall_thickness) {
                    this.partData.stock_wall_thickness = parsed.wall_thickness;
                }

                // LENGTH: Apply if present (including 0 - use explicit null check)
                if (parsed.length !== null && parsed.length !== undefined) {
                    this.partData.stock_length = parsed.length;
                } else {
                    console.warn(`‚ö†Ô∏è parsed.length is ${parsed.length} - NOT setting stock_length`);
                }

                    shape: this.partData.stock_shape,
                    diameter: this.partData.stock_diameter,
                    width: this.partData.stock_width,
                    height: this.partData.stock_height,
                    length: this.partData.stock_length
                });

                // 3. Apply price category
                if (parsed.suggested_price_category_id) {
                    this.partData.price_category_id = parsed.suggested_price_category_id;
                    this.selectedMaterial = this.materialItems.find(
                        item => item.id === parsed.suggested_price_category_id
                    );

                    // VALIDATE: Je vybran√° kategorie v filteredCategories? (ghost selection check)
                    if (this.selectedMaterial && !this.filteredCategories.some(item => item.id === this.selectedMaterial.id)) {
                        console.warn('Parser found category not in filteredCategories for shape:', this.partData.stock_shape, this.selectedMaterial.name);
                        window.showToast(`‚ö†Ô∏è ${this.selectedMaterial.name} nesed√≠ s typem polotovaru - vyberte manu√°lnƒõ`, 'warning');
                        this.partData.price_category_id = null;
                        this.selectedMaterial = null;
                    }
                } else if (parsed.shape) {
                    // Parser na≈°el shape, ale NENA≈†EL kategorii ‚Üí reset star√© kategorie (jinak ghost selection)
                    this.partData.price_category_id = null;
                    this.selectedMaterial = null;
                }

                // 4. Save & reload
                await this.savePart();
                    length: this.partData.stock_length,
                    width: this.partData.stock_width,
                    height: this.partData.stock_height
                });

                await this.loadStockCost();
                    length: this.partData.stock_length,
                    width: this.partData.stock_width,
                    height: this.partData.stock_height
                });

                await this.recalculateAllBatches();

                // 5. Show warnings/success (using snapshot)
                if (parsed.warnings && parsed.warnings.length > 0) {
                    parsed.warnings.forEach(warning => {
                        window.showToast(`‚ö†Ô∏è ${warning}`, 'warning');
                    });
                } else {
                    window.showToast('Materi√°l nastaven podle rozpozn√°n√≠', 'success');
                }

                // 6. Clear quick input
                this.clearParseResult();

            } catch (error) {
                console.error('Error applying parsed material:', error);
                window.showToast('Chyba p≈ôi aplikaci materi√°lu', 'error');
            }
        },

        clearParseResult() {
            this.quickMaterialInput = '';
            this.parseResult = null;
        },

        formatShape(shape) {
            const labels = {
                'round_bar': 'Kulatina (D)',
                'square_bar': 'ƒåty≈ôhran (‚ñ°)',
                'flat_bar': 'Profil',
                'hexagonal_bar': '≈†estihran (‚¨°)',
                'plate': 'Plech',
                'tube': 'Trubka',
                'casting': 'Odlitek',
                'forging': 'V√Ωkovek'
            };
            return labels[shape] || shape || '-';
        },

        shapeLabel(shape) {
            const labels = {
                'round_bar': 'Tyƒç kruhov√°',
                'square_bar': 'Tyƒç ƒçtvercov√°',
                'flat_bar': 'Tyƒç ploch√°',
                'hexagonal_bar': 'Tyƒç ≈°estihrann√°',
                'plate': 'Plech',
                'tube': 'Trubka',
                'casting': 'Odlitek',
                'forging': 'V√Ωkovek'
            };
            return labels[shape] || shape || '-';
        },

        getMachineName(machineId) {
            if (!machineId) return '-';
            const machine = this.machines.find(m => m.id === machineId);
            return machine ? machine.name : 'Nezn√°m√Ω stroj';
        },

        getMachineRate(machineId) {
            if (!machineId) return 0;
            const machine = this.machines.find(m => m.id === machineId);
            return machine ? machine.hourly_rate : 0;
        },

        async copyGeometryFromCatalog() {
            try {
                const response = await fetch(`/api/parts/${this.partNumber}/copy-material-geometry`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    // Reload part to get updated geometry
                    await this.loadPart();
                    await this.loadStockCost();
                    window.showToast('Rozmƒõry naƒçteny z katalogu', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba', 'error');
                }
            } catch (error) {
                console.error('Error copying geometry:', error);
                window.showToast('Chyba p≈ôi kop√≠rov√°n√≠ rozmƒõr≈Ø', 'error');
            }
        },

        async loadStockCost() {
            try {
                const response = await fetch(`/api/parts/${this.partNumber}/stock-cost`);
                if (response.ok) {
                    this.stockCost = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load stock cost:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st cenu polotovaru', 'error');
                    // Keep previous stockCost to avoid showing 0
                }
            } catch (error) {
                console.error('Error loading stock cost:', error);
                window.showToast('Chyba p≈ôi v√Ωpoƒçtu ceny polotovaru', 'error');
            }
        },

        // Combined debounced save + stock cost load (fixes race condition)
        debouncedSaveAndLoadStock() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(async () => {
                await this.savePart();
                await this.loadStockCost();
                await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ stock fields
            }, 400);
        },

        debouncedSave() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => {
                this.savePart();
            }, 500);
        },

        debouncedUpdateOperation(op) {
            clearTimeout(this.operationUpdateTimeout);
            this.operationUpdateTimeout = null;  // Clear reference after cancelling

            // Increment sequence to track this update
            this.operationUpdateSequence++;
            const currentSequence = this.operationUpdateSequence;

            // L-017: Snapshot to avoid Alpine Proxy race condition
            // Freeze op.version and all values BEFORE timeout
            const snapshot = JSON.parse(JSON.stringify(op));

            // Track pending changes for beforeunload warning
            this.hasPendingChanges = true;
            this.pendingOperationSnapshot = snapshot;

            this.operationUpdateTimeout = setTimeout(async () => {
                await this.updateOperation(snapshot, currentSequence);
            }, 250);  // Reduced from 400ms for faster UX
        },

        async savePart() {
            try {
                const response = await fetch(`/api/parts/${this.partNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.partData,
                        version: this.partData.version
                    })
                });

                if (response.ok) {
                    const updated = await response.json();
                    this.partData.version = updated.version;
                } else if (response.status === 409) {
                    // Version conflict - offer reload (HIGH-006 fix)
                    if (confirm('Data byla zmƒõnƒõna jin√Ωm u≈æivatelem. Obnovit str√°nku? (Neulo≈æen√© zmƒõny budou ztraceny)')) {
                        window.location.reload();
                    } else {
                        await this.loadPart();
                        window.showToast('Naƒçtena aktu√°ln√≠ verze. Zkuste zmƒõnu znovu.', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save part:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se ulo≈æit d√≠l', 'error');
                }
            } catch (error) {
                console.error('Error saving part:', error);
                window.showToast('Kritick√° chyba p≈ôi ukl√°d√°n√≠ d√≠lu', 'error');
            }
        },

        async loadOperations() {
            try {
                const response = await fetch(`/api/operations/part/${this.partId}`);
                if (response.ok) {
                    this.operations = await response.json();

                    // Auto-sync operation type/icon/name from work center (CRITICAL!)
                    // Needed because DB may contain old hardcoded types that don't match work center
                    this.operations.forEach(op => {
                        this.updateOperationFromWorkCenter(op);
                    });

                    this.calculateTotalTime();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load operations:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st operace', 'error');
                }
            } catch (error) {
                console.error('Error loading operations:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ operac√≠', 'error');
            }
        },

        async loadBatches() {
            try {
                // Fetch all batches for this part
                const response = await fetch(`/api/batches/part/${this.partId}`);
                if (response.ok) {
                    const allBatches = await response.json();

                    // Filter batches based on selectedBatchSetId
                    if (this.selectedBatchSetId === '') {
                        // Show only loose batches (batch_set_id IS NULL)
                        this.batches = allBatches.filter(b => b.batch_set_id === null);
                        this.looseBatchCount = this.batches.length;
                    } else {
                        // Show batches from selected set (convert string to number)
                        const setId = parseInt(this.selectedBatchSetId, 10);
                        this.batches = allBatches.filter(b => b.batch_set_id === setId);
                        // Also count loose batches for the freeze button
                        this.looseBatchCount = allBatches.filter(b => b.batch_set_id === null).length;
                    }

                    this.sortBatches();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load batches:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st cenov√© p≈ôehledy', 'error');
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ cenov√Ωch p≈ôehled≈Ø', 'error');
            }
        },

        async loadBatchSets() {
            // ADR-022: Load BatchSets for this part
            try {
                const response = await fetch(`/api/pricing/part/${this.partId}/batch-sets`);
                if (response.ok) {
                    this.batchSets = await response.json();
                } else {
                    console.error('Failed to load batch sets:', response.status);
                    // Silent fail - not critical
                }
            } catch (error) {
                console.error('Error loading batch sets:', error);
                // Silent fail - not critical
            }
        },

        async createBatchSet() {
            // ADR-022: Create new BatchSet for this part
            try {
                const response = await fetch('/api/pricing/batch-sets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ part_id: this.partId })
                });

                if (response.ok) {
                    const newSet = await response.json();
                    window.showToast('Sada vytvo≈ôena', 'success');
                    // Redirect to detail page
                    window.location.href = `/pricing/batch-sets/${newSet.id}`;
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create batch set');
                }
            } catch (error) {
                console.error('Error creating batch set:', error);
                window.showToast('Nepoda≈ôilo se vytvo≈ôit sadu: ' + error.message, 'error');
            }
        },

        async freezeLooseBatches() {
            // ADR-022: Freeze all loose batches into a new BatchSet
            if (this.looseBatchCount === 0) {
                window.showToast('≈Ω√°dn√© voln√© ≈°ar≈æe k zmrazen√≠', 'warning');
                return;
            }

            if (!confirm(`Zmrazit v≈°echny voln√© ≈°ar≈æe (${this.looseBatchCount} ks) jako sadu?\n\nPo zmrazen√≠ nebude mo≈æn√© ceny mƒõnit.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pricing/parts/${this.partId}/freeze-batches-as-set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const frozenSet = await response.json();
                    window.showToast(`Sada zmrazena: ${frozenSet.set_number} (${frozenSet.batches.length} ≈°ar≈æ√≠)`, 'success');

                    // Reload batch sets and select the new frozen set
                    await this.loadBatchSets();
                    this.selectedBatchSetId = frozenSet.id;
                    await this.loadBatches();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to freeze batches');
                }
            } catch (error) {
                console.error('Error freezing loose batches:', error);
                window.showToast('Nepoda≈ôilo se zmrazit ≈°ar≈æe: ' + error.message, 'error');
            }
        },

        calculateTotalTime() {
            this.totalTime = this.operations.reduce((sum, op) => sum + op.operation_time_min, 0);
        },

        async recalculateAllBatches() {
            /**
             * P≈ôepoƒç√≠t√° v≈°echny batches po zmƒõnƒõ operac√≠ nebo materi√°lu.
             * SEQUENTIAL to avoid race conditions (CRITICAL-001 fix).
             */
            if (!this.batches || this.batches.length === 0) {
                return; // ≈Ω√°dn√© batches k p≈ôepoƒç√≠t√°n√≠
            }

            const batchCount = this.batches.length;

            try {
                // Sequential recalculation to avoid race conditions
                let successCount = 0;
                let failCount = 0;

                for (const batch of this.batches) {
                    const response = await fetch(`/api/batches/${batch.batch_number}/recalculate`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        const errorText = await response.text();
                        console.warn(`Batch ${batch.batch_number} recalculation failed:`, response.status, errorText);
                    }
                }

                // Reload batches to show updated prices
                await this.loadBatches();

                if (failCount === 0) {
                    window.showToast(`P≈ôepoƒçteno ${batchCount} d√°vek`, 'success');
                } else {
                    window.showToast(`P≈ôepoƒç√≠t√°no ${successCount}/${batchCount} d√°vek (${failCount} selhalo)`, 'warning');
                }
            } catch (error) {
                console.error('Error recalculating batches:', error);
                window.showToast('Chyba p≈ôi p≈ôepoƒçtu cenov√Ωch p≈ôehled≈Ø', 'error');
            }
        },

        async deleteOperation(op) {
            if (!confirm(`Smazat operaci ${op.seq} - ${op.name || 'bez n√°zvu'}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/operations/${op.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    this.operations = this.operations.filter(o => o.id !== op.id);
                    this.calculateTotalTime();
                    await this.recalculateAllBatches();
                    window.showToast('Operace smaz√°na', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi maz√°n√≠ operace', 'error');
                }
            } catch (error) {
                console.error('Error deleting operation:', error);
                window.showToast('Chyba p≈ôi maz√°n√≠ operace', 'error');
            }
        },

        async addOperation() {
            const maxSeq = this.operations.reduce((max, op) => Math.max(max, op.seq), 0);

            try {
                const response = await fetch('/api/operations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        seq: maxSeq + 10,
                        name: 'OP' + (maxSeq + 10),  // Generic name - type is set when machine is selected
                        type: 'generic',  // Will be updated when machine is selected
                        icon: 'üîß',  // Generic tool icon
                        cutting_mode: 'mid',
                        setup_time_min: 30.0
                    })
                });

                if (response.ok) {
                    const newOp = await response.json();
                    this.operations.push(newOp);
                    this.calculateTotalTime();
                    await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po p≈ôid√°n√≠ operace
                    window.showToast('Operace p≈ôid√°na - vyberte stroj', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
                }
            } catch (error) {
                console.error('Error adding operation:', error);
                window.showToast('Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
            }
        },

        updateOperationFromWorkCenter(op) {
            // Auto-update operation type/icon/name when work center is selected
            if (!op.work_center_id) {
                // No work center selected - reset to generic
                op.type = 'generic';
                op.icon = 'üîß';
                op.name = `OP${op.seq}`;
                return;
            }

            const workCenter = this.workCenters.find(wc => wc.id === op.work_center_id);
            if (!workCenter) return;

            // WorkCenter type ‚Üí Operation type mapping
            const typeMap = {
                'CNC_LATHE': { type: 'turning', icon: 'üîÑ', label: 'Soustru≈æen√≠' },
                'CNC_MILL_3AX': { type: 'milling', icon: '‚öôÔ∏è', label: 'Fr√©zov√°n√≠ 3AX' },
                'CNC_MILL_4AX': { type: 'milling', icon: '‚öôÔ∏è', label: 'Fr√©zov√°n√≠ 4AX' },
                'CNC_MILL_5AX': { type: 'milling', icon: '‚öôÔ∏è', label: 'Fr√©zov√°n√≠ 5AX' },
                'SAW': { type: 'cutting', icon: '‚úÇÔ∏è', label: '≈òez√°n√≠' },
                'DRILL': { type: 'drilling', icon: 'üî©', label: 'Vrt√°n√≠' },
                'QUALITY_CONTROL': { type: 'inspection', icon: 'üîç', label: 'Kontrola' },
                'MANUAL_ASSEMBLY': { type: 'assembly', icon: 'üîß', label: 'Mont√°≈æ' },
                'EXTERNAL': { type: 'coop', icon: 'üè≠', label: 'Kooperace' }
            };

            const mapping = typeMap[workCenter.work_center_type] || { type: 'generic', icon: 'üîß', label: 'Operace' };

            // Update operation properties
            op.type = mapping.type;
            op.icon = mapping.icon;
            op.name = `OP${op.seq} - ${mapping.label}`;
        },

        async changeMode(op, mode) {
            try {
                const response = await fetch(`/api/operations/${op.id}/change-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cutting_mode: mode,
                        version: op.version
                    })
                });

                if (response.ok) {
                    const updated = await response.json();
                    const index = this.operations.findIndex(o => o.id === op.id);
                    if (index !== -1) {
                        this.operations[index] = updated;
                        this.calculateTotalTime();
                    }
                    window.showToast(`Re≈æim zmƒõnƒõn na ${mode.toUpperCase()}`, 'success');
                } else if (response.status === 409) {
                    window.showToast('Verze konfliktu - obnovte str√°nku', 'error');
                }
            } catch (error) {
                console.error('Error changing mode:', error);
                window.showToast('Chyba p≈ôi zmƒõnƒõ re≈æimu', 'error');
            }
        },

        async updateOperation(op, requestSequence) {
            try {
                // Normalize null/empty/NaN values to defaults
                // IMPORTANT: Preserve 0 values! Replace null/undefined/NaN with defaults
                // When user deletes input content, x-model.number converts "" to NaN
                const normalizeValue = (value, defaultValue) => {
                    // Keep 0 as valid! Only replace null/undefined/NaN/empty
                    if (value === 0) return 0;
                    if (value === null || value === undefined || isNaN(value) || value === '') {
                        return defaultValue;
                    }
                    return value;
                };

                const payload = {
                    work_center_id: op.work_center_id,
                    type: op.type,  // Auto-updated from work center type
                    icon: op.icon,  // Auto-updated from work center type
                    name: op.name,  // Auto-updated from work center type
                    operation_time_min: normalizeValue(op.operation_time_min, 0.0),
                    setup_time_min: normalizeValue(op.setup_time_min, 0.0),  // Empty field = 0, not 30!
                    is_coop: op.is_coop,
                    coop_type: op.coop_type,
                    coop_price: normalizeValue(op.coop_price, 0.0),
                    coop_days: op.coop_days ?? 0,
                    version: op.version
                };

                const response = await fetch(`/api/operations/${op.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const updated = await response.json();

                    // RACE CONDITION FIX: Ignore stale responses
                    // If a newer update has been triggered (sequence increased), ignore this response
                    if (requestSequence < this.operationUpdateSequence) {
                        return;  // Stale response - ignore
                    }

                    // CRITICAL: Create new array to trigger Alpine reactivity
                    this.operations = this.operations.map(o =>
                        o.id === updated.id ? updated : o
                    );

                    this.calculateTotalTime();
                    await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ operace

                    // Clear pending changes flag (success)
                    this.hasPendingChanges = false;
                    this.pendingOperationSnapshot = null;

                    window.showToast('Operace aktualizov√°na', 'success');
                } else if (response.status === 409) {
                    window.showToast('Verze konfliktu - obnovte str√°nku', 'error');
                    await this.loadOperations();
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi aktualizaci operace', 'error');
                }
            } catch (error) {
                console.error('Error updating operation:', error);
                window.showToast('Chyba p≈ôi aktualizaci operace', 'error');
            } finally {
                // Always clear pending changes (even on error - user saw the error toast)
                this.hasPendingChanges = false;
                this.pendingOperationSnapshot = null;
                this.operationUpdateTimeout = null;  // Clear timeout reference
            }
        },

        flushPendingOperationSync() {
            /**
             * Best-effort synchronous flush for beforeunload event.
             * Uses deprecated synchronous XHR as last resort to prevent data loss.
             * Called only when user is leaving page with unsaved changes.
             */
            if (!this.pendingOperationSnapshot) return;

            const op = this.pendingOperationSnapshot;

            // Normalize values (same as async updateOperation)
            const normalizeValue = (value, defaultValue) => {
                if (value === 0) return 0;
                if (value === null || value === undefined || isNaN(value) || value === '') {
                    return defaultValue;
                }
                return value;
            };

            const payload = {
                work_center_id: op.work_center_id,
                type: op.type,
                icon: op.icon,
                name: op.name,
                operation_time_min: normalizeValue(op.operation_time_min, 0.0),
                setup_time_min: normalizeValue(op.setup_time_min, 0.0),
                is_coop: op.is_coop,
                coop_type: op.coop_type,
                coop_price: normalizeValue(op.coop_price, 0.0),
                coop_days: op.coop_days ?? 0,
                version: op.version
            };

            try {
                // Synchronous XHR (deprecated but only option for beforeunload)
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', `/api/operations/${op.id}`, false); // false = synchronous
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify(payload));

                if (xhr.status >= 200 && xhr.status < 300) {
                } else {
                    console.warn('‚ö†Ô∏è Failed to flush pending operation:', xhr.status);
                }
            } catch (error) {
                console.error('‚ùå Error flushing pending operation:', error);
                // Fail silently - user is leaving anyway
            }
        },

        async addBatch() {
            if (!this.newBatchQty || this.newBatchQty < 1) {
                window.showToast('Zadejte platn√© mno≈æstv√≠', 'error');
                return;
            }

            try {
                const response = await fetch('/api/batches/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        quantity: this.newBatchQty
                    })
                });

                if (response.ok) {
                    const newBatch = await response.json();
                    // Reload batches to update looseBatchCount
                    await this.loadBatches();
                    this.newBatchQty = null;
                    window.showToast('Kalkulace p≈ôid√°na', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ kalkulace', 'error');
                }
            } catch (error) {
                console.error('Error adding batch:', error);
                window.showToast('Chyba p≈ôi p≈ôid√°n√≠ kalkulace', 'error');
            }
        },

        async deleteBatch(batch) {
            if (batch.is_frozen) {
                window.showToast('Zmrazenou d√°vku nelze smazat', 'error');
                return;
            }

            if (!confirm(`Smazat kalkulaci pro ${batch.quantity} ks?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/batches/${batch.batch_number}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload batches to update looseBatchCount
                    await this.loadBatches();
                    window.showToast('Kalkulace smaz√°na', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi maz√°n√≠ kalkulace', 'error');
                }
            } catch (error) {
                console.error('Error deleting batch:', error);
                window.showToast('Chyba p≈ôi maz√°n√≠ kalkulace', 'error');
            }
        },

        async cloneBatch(batchNumber) {
            if (!confirm('Vytvo≈ôit kopii tohoto batche? Nov√Ω batch nebude zmrazen√Ω.')) {
                return;
            }

            try {
                const response = await fetch(`/api/batches/${batchNumber}/clone`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const clonedBatch = await response.json();
                    await this.loadBatches();
                    window.showToast(`Batch naklonov√°n (${clonedBatch.quantity} ks)`, 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi klonov√°n√≠', 'error');
                }
            } catch (error) {
                console.error('Error cloning batch:', error);
                window.showToast('Chyba p≈ôi klonov√°n√≠ batche', 'error');
            }
        },

        async loadPriceBreakdowns() {
            /**
             * Naƒçte price breakdown pro v≈°echny batches (ADR-016 debug).
             * Paraleln√≠ requesty pro rychlost.
             */
            if (this.batches.length === 0) {
                window.showToast('Nejprve p≈ôidej batch', 'warning');
                return;
            }

            this.loadingBreakdowns = true;
            this.priceBreakdowns = [];

            try {
                // Paraleln√≠ requesty pro v≈°echny batches
                const promises = this.batches.map(batch =>
                    fetch(`/api/parts/${this.partNumber}/pricing?quantity=${batch.quantity}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            return response.json();
                        })
                );

                const results = await Promise.all(promises);
                this.priceBreakdowns = results;

                window.showToast('Breakdown naƒçten pro v≈°echny batches', 'success');
            } catch (error) {
                console.error('Error loading price breakdowns:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ breakdown', 'error');
            } finally {
                this.loadingBreakdowns = false;
            }
        }
    }
}
</script>
{% endblock %}
