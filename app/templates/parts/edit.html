{% extends "base.html" %}

{% block title %}GESTIMA - {{ part.part_number }}{% endblock %}

{% block content %}
<div class="split-layout" x-data="partEdit({{ part.id }})">

    <!-- LEFT PANEL (320px) -->
    <div class="left-panel">

        <!-- Z√°kladn√≠ √∫daje -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showBasic = !showBasic">
                <div class="ribbon-title">üìã Z√°kladn√≠ √∫daje</div>
                <div class="ribbon-toggle" x-text="showBasic ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showBasic">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.8rem;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">ƒå√≠slo v√Ωkresu</label>
                        <div style="font-weight: 600;">{{ part.part_number }}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">ƒål√°nkov√© ƒç√≠slo</label>
                        <input type="text" x-model="partData.article_number" @input="debouncedSave()"
                               placeholder="Dodavatelsk√© ƒç√≠slo"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">N√°zev</label>
                        <input type="text" x-model="partData.name" @input="debouncedSave()"
                               placeholder="N√°zev d√≠lu"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka obr√°bƒõn√© ƒç√°sti [mm]</label>
                        <input type="number" step="0.1" min="0" x-model.number="partData.length" @input="debouncedSave()"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Materi√°l -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showMaterial = !showMaterial">
                <div class="ribbon-title">üî© Materi√°l</div>
                <div class="ribbon-toggle" x-text="showMaterial ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showMaterial">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.75rem;">

                    <!-- Searchable Material Item -->
                    <div style="position: relative;">
                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Polotovar</label>
                        <input type="text"
                               x-model="materialSearch"
                               @focus="showMaterialDropdown = true"
                               @input="filterMaterials()"
                               placeholder="Hledat polotovar..."
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">

                        <!-- Dropdown -->
                        <div x-show="showMaterialDropdown && filteredMaterials.length > 0"
                             @click.away="showMaterialDropdown = false"
                             style="position: absolute; left: 0; right: 0; top: 100%; margin-top: 2px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow-md);">
                            <template x-for="item in filteredMaterials" :key="item.id">
                                <div @mousedown.prevent="selectMaterial(item)"
                                     style="padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;"
                                     :style="item.id === partData.material_item_id ? 'background: var(--bg-card-hover)' : ''"
                                     @mouseenter="$el.style.background = 'var(--bg-card-hover)'"
                                     @mouseleave="$el.style.background = item.id === partData.material_item_id ? 'var(--bg-card-hover)' : ''">
                                    <div>
                                        <div style="font-weight: 500;" x-text="item.name"></div>
                                        <div style="font-size: 0.65rem; color: var(--text-muted);" x-text="item.group?.name || ''"></div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: var(--accent-blue);" x-text="item.price_per_kg + ' Kƒç/kg'"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Selected Material Info -->
                    <div x-show="selectedMaterial" style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;" x-text="selectedMaterial?.name || '-'"></div>
                        <div style="color: var(--text-muted); font-size: 0.65rem;">
                            <span x-text="shapeLabel(selectedMaterial?.shape)"></span> |
                            <span x-text="(selectedMaterial?.price_per_kg || 0) + ' Kƒç/kg'"></span> |
                            Hustota: <span x-text="(selectedMaterial?.group?.density || 0).toFixed(2)"></span> kg/dm¬≥
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Polotovar (rozmƒõry) -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showStock = !showStock">
                <div class="ribbon-title">üìê Rozmƒõry polotovaru</div>
                <div class="ribbon-toggle" x-text="showStock ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showStock">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.75rem;">

                    <!-- ROUND_BAR, HEXAGONAL_BAR, CASTING, FORGING -->
                    <template x-if="['round_bar', 'hexagonal_bar', 'casting', 'forging'].includes(selectedShape)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- TUBE -->
                    <template x-if="selectedShape === 'tube'">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò vnƒõj≈°√≠ [mm]</label>
                                    <input type="number" step="0.1" min="0" x-model.number="partData.stock_diameter" @input="debouncedSaveAndLoadStock()"
                                           style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Tlou≈°≈•ka stƒõny [mm]</label>
                                    <input type="number" step="0.1" min="0" x-model.number="partData.stock_wall_thickness" @input="debouncedSaveAndLoadStock()"
                                           style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                </div>
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- SQUARE_BAR -->
                    <template x-if="selectedShape === 'square_bar'">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Strana [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- FLAT_BAR, PLATE -->
                    <template x-if="['flat_bar', 'plate'].includes(selectedShape)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_length" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">≈†√≠≈ôka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_width" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">V√Ω≈°ka [mm]</label>
                                <input type="number" step="0.1" min="0" x-model.number="partData.stock_height" @input="debouncedSaveAndLoadStock()"
                                       style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </template>

                    <!-- No material selected -->
                    <div x-show="!selectedShape" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.7rem;">
                        Vyberte polotovar
                    </div>

                    <!-- Copy from catalog button -->
                    <button x-show="selectedMaterial" @click="copyGeometryFromCatalog()"
                            class="btn-flat" style="font-size: 0.7rem; padding: 0.4rem 0.6rem; margin-top: 0.5rem;">
                        üìã Naƒç√≠st rozmƒõry z katalogu
                    </button>

                </div>
            </div>
        </div>

        <!-- N√°klady -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showPrice = !showPrice">
                <div class="ribbon-title">üí∞ N√°klady</div>
                <div class="ribbon-toggle" x-text="showPrice ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showPrice">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.75rem;">

                    <!-- Materi√°l/ks (konstantn√≠) -->
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted); font-weight: 600;">Materi√°l/ks:</span>
                            <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-green);" x-text="stockCost.cost.toFixed(0) + ' Kƒç'"></span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;">
                            <span x-text="stockCost.weight_kg.toFixed(3) + ' kg'"></span> √ó
                            <span x-text="stockCost.price_per_kg.toFixed(0) + ' Kƒç/kg'"></span>
                        </div>
                    </div>

                    <!-- Kooperace celkov√° -->
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-muted); font-weight: 600;">Kooperace:</span>
                            <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-purple);" x-text="totalCoopCost.toFixed(0) + ' Kƒç'"></span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;" x-show="coopOperations > 0">
                            <span x-text="coopOperations"></span> kooperaƒçn√≠ch operac√≠
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.65rem; margin-top: 0.25rem;" x-show="coopOperations === 0">
                            ≈Ω√°dn√© kooperace
                        </div>
                    </div>

                    <!-- Detail polotovaru (collapsible) -->
                    <div x-data="{ showDetail: false }" style="margin-top: 0.5rem;">
                        <button @click="showDetail = !showDetail"
                                style="width: 100%; background: none; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; color: var(--text-secondary); font-size: 0.7rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <span>Detail polotovaru</span>
                            <span x-text="showDetail ? '‚ñº' : '‚ñ∂'"></span>
                        </button>
                        <div x-show="showDetail" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--text-muted);">Objem:</span>
                                <span x-text="(stockCost.volume_mm3 / 1000).toFixed(1) + ' cm¬≥'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--text-muted);">Hmotnost:</span>
                                <span x-text="stockCost.weight_kg.toFixed(3) + ' kg'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Hustota:</span>
                                <span x-text="(selectedMaterial?.group?.density || 0).toFixed(2) + ' kg/dm¬≥'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tlaƒç√≠tko zpƒõt -->
        <a href="/parts" hx-boost="false" class="btn-flat" style="text-decoration: none; text-align: center; margin-top: 1rem;">
            ‚Üê Zpƒõt na seznam
        </a>

    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">

        <!-- Cenov√Ω p≈ôehled (STICKY RIBBON) -->
        <div class="right-panel-sticky">
            <div class="ribbon">
                <div class="ribbon-header" @click="showBatches = !showBatches">
                    <div class="ribbon-title">üí∞ Cenov√Ω p≈ôehled</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="showPriceDetail = true"
                                class="btn-flat"
                                style="font-size: 0.7rem; padding: 0.3rem 0.6rem;"
                                title="Zobrazit detail v≈°ech cen">
                            üìä Detail
                        </button>
                        <div class="ribbon-toggle" x-text="showBatches ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showBatches">
                    <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="padding: 0.4rem; text-align: left; color: var(--text-muted); font-weight: 600;">D√°vka</th>
                                <th style="padding: 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">ƒåas/ks</th>
                                <th style="padding: 0.4rem; text-align: left; color: var(--text-muted); font-weight: 600;">Cena/ks</th>
                                <th style="padding: 0.4rem; text-align: right; color: var(--text-muted); font-weight: 600;">Celkem</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="batch in batches" :key="batch.id">
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.4rem;">
                                        <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
                                            <span x-text="batch.quantity + ' ks'"></span>
                                            <span x-show="batch.is_frozen"
                                                  style="background: var(--accent-green); color: white; padding: 0.15rem 0.35rem; border-radius: 3px; font-size: 0.6rem; font-weight: 600; white-space: nowrap;">
                                                ZMRAZENO
                                            </span>
                                            <span x-show="batch.is_frozen && batch.snapshot_data?.warnings?.length > 0"
                                                  :title="'Varov√°n√≠:\n' + (batch.snapshot_data?.warnings || []).join('\n')"
                                                  style="cursor: help; font-size: 0.9rem;">
                                                ‚ö†Ô∏è
                                            </span>
                                        </div>
                                    </td>
                                    <td style="padding: 0.4rem; text-align: right; color: var(--text-secondary);"
                                        x-text="batch.unit_time_min.toFixed(1) + ' min'"></td>
                                    <td style="padding: 0.4rem;">
                                        <!-- Bar chart with breakdown -->
                                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <div style="font-weight: 600; color: var(--text-primary);"
                                                 x-text="batch.unit_cost.toFixed(0) + ' Kƒç'"></div>
                                            <div style="display: flex; height: 8px; border-radius: 3px; overflow: hidden; background: var(--bg-secondary);">
                                                <div :style="`width: ${batch.material_percent}%; background: var(--accent-green);`"
                                                     :title="'Materi√°l: ' + batch.material_cost.toFixed(0) + ' Kƒç (' + batch.material_percent + '%)'"></div>
                                                <div :style="`width: ${batch.machining_percent}%; background: var(--accent-blue);`"
                                                     :title="'V√Ωroba: ' + batch.machining_cost.toFixed(0) + ' Kƒç (' + batch.machining_percent + '%)'"></div>
                                                <div :style="`width: ${batch.setup_percent}%; background: var(--accent-yellow);`"
                                                     :title="'Se≈ô√≠zen√≠: ' + batch.setup_cost.toFixed(0) + ' Kƒç (' + batch.setup_percent + '%)'"></div>
                                                <div :style="`width: ${batch.coop_percent}%; background: var(--accent-purple);`"
                                                     :title="'Kooperace: ' + batch.coop_cost.toFixed(0) + ' Kƒç (' + batch.coop_percent + '%)'"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 0.4rem; text-align: right; font-weight: 600; color: var(--accent-blue);"
                                        x-text="batch.total_cost.toFixed(0) + ' Kƒç'"></td>
                                </tr>
                            </template>
                            <tr x-show="batches.length === 0">
                                <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.75rem;">
                                    Zat√≠m ≈æ√°dn√© ceny
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Legenda -->
                    <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.65rem; color: var(--text-muted); justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div style="width: 12px; height: 8px; background: var(--accent-green); border-radius: 2px;"></div>
                            <span>materi√°l</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div style="width: 12px; height: 8px; background: var(--accent-blue); border-radius: 2px;"></div>
                            <span>v√Ωroba</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div style="width: 12px; height: 8px; background: var(--accent-yellow); border-radius: 2px;"></div>
                            <span>se≈ô√≠zen√≠</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <div style="width: 12px; height: 8px; background: var(--accent-purple); border-radius: 2px;"></div>
                            <span>kooperace</span>
                        </div>
                    </div>

                    <!-- P≈ôidat batch -->
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" x-model.number="newBatchQty" placeholder="Mno≈æstv√≠" min="1"
                               style="width: 80px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                        <button @click="addBatch()" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.4rem 0.6rem;">
                            + P≈ôidat
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollovateln√Ω obsah -->
        <div class="right-panel-content">

            <!-- ƒåas na kus (p≈ôesunut dol≈Ø) -->
            <div class="ribbon">
                <div class="ribbon-header" @click="showTime = !showTime">
                    <div class="ribbon-title">‚è±Ô∏è ƒåas na kus</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--accent-blue);" x-text="totalTime.toFixed(1) + ' min'">
                            0.0 min
                        </div>
                        <div class="ribbon-toggle" x-text="showTime ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showTime">
                    <div style="color: var(--text-muted); font-size: 0.75rem;">
                        Souƒçet operac√≠ (materi√°l: <span x-text="stockCost.cost.toFixed(0)"></span> Kƒç)
                    </div>
                </div>
            </div>

            <!-- Operace (RIBBON) -->
            <div class="ribbon">
                <div class="ribbon-header" @click="showOperations = !showOperations">
                    <div class="ribbon-title">
                        üîß OPERACE (<span x-text="operations.length">0</span>)
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="addOperation" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                            + P≈ôidat operaci
                        </button>
                        <div class="ribbon-toggle" x-text="showOperations ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>

                <div class="ribbon-body" x-show="showOperations" style="padding: 0.5rem;">
                    <!-- Seznam operac√≠ -->
                    <template x-for="(op, index) in operations" :key="op.id">
                        <div class="operation-card" x-data="{ expanded: false }">
                            <!-- Header (editovateln√Ω inline) -->
                            <div class="op-header" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px;">
                                <!-- Seq + Icon -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div class="op-seq" x-text="op.seq"></div>
                                    <div class="op-icon" x-text="op.icon"></div>
                                </div>

                                <!-- Stroj (editovateln√Ω dropdown) -->
                                <div @click.stop style="flex: 1; min-width: 180px;">
                                    <select x-model.number="op.machine_id"
                                            @change="updateOperation(op)"
                                            style="width: 100%; padding: 0.35rem 0.5rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem; font-weight: 500;">
                                        <option value="">- Vyberte stroj -</option>
                                        <template x-for="machine in machines" :key="machine.id">
                                            <option :value="machine.id" :selected="machine.id === op.machine_id" x-text="machine.name"></option>
                                        </template>
                                    </select>
                                </div>

                                <!-- tp (editovateln√Ω inline) -->
                                <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">tp:</span>
                                    <input type="number" step="0.1" min="0" x-model.number="op.operation_time_min"
                                           @input="debouncedUpdateOperation(op)"
                                           style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                </div>

                                <!-- tj (editovateln√Ω inline) -->
                                <div @click.stop style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">tj:</span>
                                    <input type="number" step="0.1" min="0" x-model.number="op.setup_time_min"
                                           @input="debouncedUpdateOperation(op)"
                                           style="width: 60px; padding: 0.3rem 0.4rem; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 0.75rem; font-weight: 600; text-align: right;">
                                    <span style="color: var(--text-muted); font-size: 0.7rem;">min</span>
                                </div>

                                <!-- Expand indicator (pro features) -->
                                <div @click="expanded = !expanded" style="font-size: 0.7rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem;" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                            </div>

                            <!-- Features (rozbalovac√≠) -->
                            <div class="features-section" x-show="expanded" x-collapse>
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                    <!-- Mode buttons -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Re≈æim ≈ôez√°n√≠</label>
                                        <div class="mode-buttons-inline">
                                            <button @click="changeMode(op, 'low')"
                                                    :class="{ 'active': op.cutting_mode === 'low' }"
                                                    class="mode-btn-sm mode-low">LOW</button>
                                            <button @click="changeMode(op, 'mid')"
                                                    :class="{ 'active': op.cutting_mode === 'mid' }"
                                                    class="mode-btn-sm mode-mid">MID</button>
                                            <button @click="changeMode(op, 'high')"
                                                    :class="{ 'active': op.cutting_mode === 'high' }"
                                                    class="mode-btn-sm mode-high">HIGH</button>
                                        </div>
                                    </div>

                                    <!-- Features placeholder -->
                                    <div class="no-features">
                                        üìù Kroky operace (zat√≠m neimplementov√°no)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Pr√°zdn√Ω stav -->
                    <div x-show="operations.length === 0"
                         style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">üîß Zat√≠m ≈æ√°dn√© operace</div>
                        <div style="font-size: 0.75rem;">Klikni na "+ P≈ôidat operaci" pro zaƒç√°tek</div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Modal - Detail cen v≈°ech d√°vek -->
    <div x-show="showPriceDetail"
         @click.self="showPriceDetail = false"
         style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;"
         x-transition>
        <div @click.stop
             style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; max-width: 90vw; max-height: 90vh; overflow: auto; box-shadow: var(--shadow-md);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">üìä Detail cen v≈°ech d√°vek</h2>
                <button @click="showPriceDetail = false"
                        style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;"
                        title="Zav≈ô√≠t">√ó</button>
            </div>

            <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 0.5rem; text-align: left; color: var(--text-muted); font-weight: 600;">D√°vka</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">ƒåas/ks</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Materi√°l</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">V√Ωroba</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Se≈ô√≠zen√≠</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">Koop</th>
                        <th style="padding: 0.5rem; text-align: right; color: var(--text-muted); font-weight: 600;">CELKEM</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="batch in batches" :key="batch.id">
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <span x-text="batch.quantity + ' ks'"></span>
                                    <span x-show="batch.is_frozen"
                                          style="background: var(--accent-green); color: white; padding: 0.15rem 0.35rem; border-radius: 3px; font-size: 0.6rem; font-weight: 600;">
                                        ZMRAZENO
                                    </span>
                                </div>
                            </td>
                            <td style="padding: 0.5rem; text-align: right; color: var(--text-secondary);"
                                x-text="batch.unit_time_min.toFixed(1) + ' min'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.material_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.machining_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.setup_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right;"
                                x-text="batch.coop_cost.toFixed(0) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem; text-align: right; font-weight: 700; color: var(--accent-blue);"
                                x-text="batch.unit_cost.toFixed(0) + ' Kƒç'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
function partEdit(partId) {
    return {
        partId: partId,

        // UI state
        showBasic: true,
        showMaterial: true,
        showStock: true,
        showPrice: true,
        showBatches: true,
        showTime: true,
        showOperations: true,
        showPriceDetail: false,

        // Part data
        partData: {
            article_number: '',
            name: '',
            material_item_id: null,
            length: 0,
            notes: '',
            stock_diameter: null,
            stock_length: null,
            stock_width: null,
            stock_height: null,
            stock_wall_thickness: null,
            version: 0
        },

        // Material selection
        materialItems: [],
        filteredMaterials: [],
        materialSearch: '',
        showMaterialDropdown: false,
        selectedMaterial: null,

        // Machines
        machines: [],

        // Computed
        get selectedShape() {
            return this.selectedMaterial?.shape || null;
        },

        get totalCoopCost() {
            return this.operations
                .filter(op => op.is_coop)
                .reduce((sum, op) => sum + (op.coop_price || 0), 0);
        },

        get coopOperations() {
            return this.operations.filter(op => op.is_coop).length;
        },

        // Stock cost (from backend)
        stockCost: {
            volume_mm3: 0,
            weight_kg: 0,
            price_per_kg: 0,
            cost: 0,
            density: 0
        },

        // Operations & Batches
        operations: [],
        batches: [],
        totalTime: 0,
        newBatchQty: 1,

        // Debounce timers
        saveTimeout: null,
        stockCostTimeout: null,
        operationUpdateTimeout: null,

        async init() {
            // 1. Load reference data
            await Promise.all([
                this.loadMaterialItems(),
                this.loadMachines()
            ]);

            // 2. Load part with material item
            await this.loadPart();

            // 3. Load stock cost, operations, batches
            await Promise.all([
                this.loadStockCost(),
                this.loadOperations(),
                this.loadBatches()
            ]);
        },

        async loadMaterialItems() {
            try {
                const response = await fetch('/api/materials/items');
                if (response.ok) {
                    this.materialItems = await response.json();
                    this.filteredMaterials = this.materialItems;
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load materials:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st materi√°ly', 'error');
                }
            } catch (error) {
                console.error('Error loading material items:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ materi√°l≈Ø', 'error');
            }
        },

        async loadMachines() {
            try {
                const response = await fetch('/api/data/machines');
                if (response.ok) {
                    this.machines = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load machines:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st stroje', 'error');
                }
            } catch (error) {
                console.error('Error loading machines:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ stroj≈Ø', 'error');
            }
        },

        async loadPart() {
            try {
                const response = await fetch(`/api/parts/${this.partId}/full`);
                if (response.ok) {
                    const data = await response.json();
                    this.partData = {
                        article_number: data.article_number || '',
                        name: data.name || '',
                        material_item_id: data.material_item_id,
                        length: data.length || 0,
                        notes: data.notes || '',
                        stock_diameter: data.stock_diameter,
                        stock_length: data.stock_length,
                        stock_width: data.stock_width,
                        stock_height: data.stock_height,
                        stock_wall_thickness: data.stock_wall_thickness,
                        version: data.version
                    };

                    // Set selected material
                    if (data.material_item) {
                        this.selectedMaterial = data.material_item;
                        this.materialSearch = data.material_item.name;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load part:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st d√≠l', 'error');
                }
            } catch (error) {
                console.error('Error loading part:', error);
                window.showToast('Kritick√° chyba p≈ôi naƒç√≠t√°n√≠ d√≠lu', 'error');
            }
        },

        filterMaterials() {
            const search = this.materialSearch.toLowerCase();
            if (!search) {
                this.filteredMaterials = this.materialItems;
            } else {
                this.filteredMaterials = this.materialItems.filter(item =>
                    item.name.toLowerCase().includes(search) ||
                    item.code.toLowerCase().includes(search) ||
                    (item.group?.name || '').toLowerCase().includes(search)
                );
            }
        },

        async selectMaterial(item) {
            this.selectedMaterial = item;
            this.materialSearch = item.name;
            this.partData.material_item_id = item.id;
            this.showMaterialDropdown = false;

            // Save immediately
            await this.savePart();
            await this.loadStockCost();
            await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ materi√°lu
        },

        shapeLabel(shape) {
            const labels = {
                'round_bar': 'Tyƒç kruhov√°',
                'square_bar': 'Tyƒç ƒçtvercov√°',
                'flat_bar': 'Tyƒç ploch√°',
                'hexagonal_bar': 'Tyƒç ≈°estihrann√°',
                'plate': 'Plech',
                'tube': 'Trubka',
                'casting': 'Odlitek',
                'forging': 'V√Ωkovek'
            };
            return labels[shape] || shape || '-';
        },

        getMachineName(machineId) {
            if (!machineId) return '-';
            const machine = this.machines.find(m => m.id === machineId);
            return machine ? machine.name : 'Nezn√°m√Ω stroj';
        },

        getMachineRate(machineId) {
            if (!machineId) return 0;
            const machine = this.machines.find(m => m.id === machineId);
            return machine ? machine.hourly_rate : 0;
        },

        async copyGeometryFromCatalog() {
            try {
                const response = await fetch(`/api/parts/${this.partId}/copy-material-geometry`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    // Reload part to get updated geometry
                    await this.loadPart();
                    await this.loadStockCost();
                    window.showToast('Rozmƒõry naƒçteny z katalogu', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba', 'error');
                }
            } catch (error) {
                console.error('Error copying geometry:', error);
                window.showToast('Chyba p≈ôi kop√≠rov√°n√≠ rozmƒõr≈Ø', 'error');
            }
        },

        async loadStockCost() {
            try {
                const response = await fetch(`/api/parts/${this.partId}/stock-cost`);
                if (response.ok) {
                    this.stockCost = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load stock cost:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st cenu polotovaru', 'error');
                    // Keep previous stockCost to avoid showing 0
                }
            } catch (error) {
                console.error('Error loading stock cost:', error);
                window.showToast('Chyba p≈ôi v√Ωpoƒçtu ceny polotovaru', 'error');
            }
        },

        // Combined debounced save + stock cost load (fixes race condition)
        debouncedSaveAndLoadStock() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(async () => {
                await this.savePart();
                await this.loadStockCost();
                await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ stock fields
            }, 400);
        },

        debouncedSave() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => {
                this.savePart();
            }, 500);
        },

        debouncedUpdateOperation(op) {
            clearTimeout(this.operationUpdateTimeout);
            this.operationUpdateTimeout = setTimeout(async () => {
                await this.updateOperation(op);
            }, 400);
        },

        async savePart() {
            try {
                const response = await fetch(`/api/parts/${this.partId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.partData,
                        version: this.partData.version
                    })
                });

                if (response.ok) {
                    const updated = await response.json();
                    this.partData.version = updated.version;
                } else if (response.status === 409) {
                    // Version conflict - offer reload (HIGH-006 fix)
                    if (confirm('Data byla zmƒõnƒõna jin√Ωm u≈æivatelem. Obnovit str√°nku? (Neulo≈æen√© zmƒõny budou ztraceny)')) {
                        window.location.reload();
                    } else {
                        await this.loadPart();
                        window.showToast('Naƒçtena aktu√°ln√≠ verze. Zkuste zmƒõnu znovu.', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save part:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se ulo≈æit d√≠l', 'error');
                }
            } catch (error) {
                console.error('Error saving part:', error);
                window.showToast('Kritick√° chyba p≈ôi ukl√°d√°n√≠ d√≠lu', 'error');
            }
        },

        async loadOperations() {
            try {
                const response = await fetch(`/api/operations/part/${this.partId}`);
                if (response.ok) {
                    this.operations = await response.json();
                    this.calculateTotalTime();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load operations:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st operace', 'error');
                }
            } catch (error) {
                console.error('Error loading operations:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ operac√≠', 'error');
            }
        },

        async loadBatches() {
            try {
                const response = await fetch(`/api/batches/part/${this.partId}`);
                if (response.ok) {
                    this.batches = await response.json();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load batches:', response.status, errorText);
                    window.showToast('Nepoda≈ôilo se naƒç√≠st cenov√© p≈ôehledy', 'error');
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                window.showToast('Chyba p≈ôi naƒç√≠t√°n√≠ cenov√Ωch p≈ôehled≈Ø', 'error');
            }
        },

        calculateTotalTime() {
            this.totalTime = this.operations.reduce((sum, op) => sum + op.operation_time_min, 0);
        },

        async recalculateAllBatches() {
            /**
             * P≈ôepoƒç√≠t√° v≈°echny batches po zmƒõnƒõ operac√≠ nebo materi√°lu.
             * SEQUENTIAL to avoid race conditions (CRITICAL-001 fix).
             */
            if (!this.batches || this.batches.length === 0) {
                return; // ≈Ω√°dn√© batches k p≈ôepoƒç√≠t√°n√≠
            }

            const batchCount = this.batches.length;

            try {
                // Sequential recalculation to avoid race conditions
                let successCount = 0;
                let failCount = 0;

                for (const batch of this.batches) {
                    const response = await fetch(`/api/batches/${batch.id}/recalculate`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        const errorText = await response.text();
                        console.warn(`Batch ${batch.id} recalculation failed:`, response.status, errorText);
                    }
                }

                // Reload batches to show updated prices
                await this.loadBatches();

                if (failCount === 0) {
                    console.log(`All ${batchCount} batches recalculated successfully`);
                } else {
                    window.showToast(`P≈ôepoƒç√≠t√°no ${successCount}/${batchCount} d√°vek (${failCount} selhalo)`, 'warning');
                }
            } catch (error) {
                console.error('Error recalculating batches:', error);
                window.showToast('Chyba p≈ôi p≈ôepoƒçtu cenov√Ωch p≈ôehled≈Ø', 'error');
            }
        },

        async addOperation() {
            const maxSeq = this.operations.reduce((max, op) => Math.max(max, op.seq), 0);

            try {
                const response = await fetch('/api/operations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        seq: maxSeq + 10,
                        name: 'OP' + (maxSeq + 10) + ' - Soustru≈æen√≠',
                        type: 'turning',
                        icon: 'üîÑ',
                        cutting_mode: 'mid',
                        setup_time_min: 30.0
                    })
                });

                if (response.ok) {
                    const newOp = await response.json();
                    this.operations.push(newOp);
                    this.calculateTotalTime();
                    await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po p≈ôid√°n√≠ operace
                    window.showToast('Operace p≈ôid√°na', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
                }
            } catch (error) {
                console.error('Error adding operation:', error);
                window.showToast('Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
            }
        },

        async changeMode(op, mode) {
            try {
                const response = await fetch(`/api/operations/${op.id}/change-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cutting_mode: mode,
                        version: op.version
                    })
                });

                if (response.ok) {
                    const updated = await response.json();
                    const index = this.operations.findIndex(o => o.id === op.id);
                    if (index !== -1) {
                        this.operations[index] = updated;
                        this.calculateTotalTime();
                    }
                    window.showToast(`Re≈æim zmƒõnƒõn na ${mode.toUpperCase()}`, 'success');
                } else if (response.status === 409) {
                    window.showToast('Verze konfliktu - obnovte str√°nku', 'error');
                }
            } catch (error) {
                console.error('Error changing mode:', error);
                window.showToast('Chyba p≈ôi zmƒõnƒõ re≈æimu', 'error');
            }
        },

        async updateOperation(op) {
            try {
                console.log('updateOperation called:', { id: op.id, machine_id: op.machine_id, version: op.version });
                const response = await fetch(`/api/operations/${op.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        machine_id: op.machine_id,
                        operation_time_min: op.operation_time_min,
                        setup_time_min: op.setup_time_min,
                        is_coop: op.is_coop,
                        coop_type: op.coop_type,
                        coop_price: op.coop_price,
                        coop_days: op.coop_days,
                        version: op.version
                    })
                });

                if (response.ok) {
                    const updated = await response.json();
                    console.log('updateOperation success:', updated);

                    // CRITICAL: Create new array to trigger Alpine reactivity
                    this.operations = this.operations.map(o =>
                        o.id === updated.id ? updated : o
                    );

                    this.calculateTotalTime();
                    await this.recalculateAllBatches(); // P≈ôepoƒç√≠tat ceny po zmƒõnƒõ operace
                    window.showToast('Operace aktualizov√°na', 'success');
                } else if (response.status === 409) {
                    window.showToast('Verze konfliktu - obnovte str√°nku', 'error');
                    await this.loadOperations();
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi aktualizaci operace', 'error');
                }
            } catch (error) {
                console.error('Error updating operation:', error);
                window.showToast('Chyba p≈ôi aktualizaci operace', 'error');
            }
        },

        async addBatch() {
            if (!this.newBatchQty || this.newBatchQty < 1) {
                window.showToast('Zadejte platn√© mno≈æstv√≠', 'error');
                return;
            }

            try {
                const response = await fetch('/api/batches/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        quantity: this.newBatchQty
                    })
                });

                if (response.ok) {
                    const newBatch = await response.json();
                    this.batches.push(newBatch);
                    this.newBatchQty = 1;
                    window.showToast('Batch p≈ôid√°n', 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ batche', 'error');
                }
            } catch (error) {
                console.error('Error adding batch:', error);
                window.showToast('Chyba p≈ôi p≈ôid√°n√≠ batche', 'error');
            }
        },

        async cloneBatch(batchId) {
            if (!confirm('Vytvo≈ôit kopii tohoto batche? Nov√Ω batch nebude zmrazen√Ω.')) {
                return;
            }

            try {
                const response = await fetch(`/api/batches/${batchId}/clone`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const clonedBatch = await response.json();
                    await this.loadBatches();
                    window.showToast(`Batch naklonov√°n (${clonedBatch.quantity} ks)`, 'success');
                } else {
                    const error = await response.json();
                    window.showToast(error.detail || 'Chyba p≈ôi klonov√°n√≠', 'error');
                }
            } catch (error) {
                console.error('Error cloning batch:', error);
                window.showToast('Chyba p≈ôi klonov√°n√≠ batche', 'error');
            }
        }
    }
}
</script>
{% endblock %}
