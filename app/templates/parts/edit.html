{% extends "base.html" %}

{% block title %}GESTIMA - {{ part.part_number }}{% endblock %}

{% block content %}
<div class="split-layout" x-data="partEdit({{ part.id }})">
    
    <!-- LEFT PANEL (280px) -->
    <div class="left-panel">
        
        <!-- Z√°kladn√≠ √∫daje -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showBasic = !showBasic">
                <div class="ribbon-title">üìã Z√°kladn√≠ √∫daje</div>
                <div class="ribbon-toggle" x-text="showBasic ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showBasic">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.8rem;">
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">ƒå√≠slo v√Ωkresu</div>
                        <div style="font-weight: 600;">{{ part.part_number }}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">N√°zev</div>
                        <div>{{ part.name or '-' }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Materi√°l & Polotovar -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showMaterial = !showMaterial">
                <div class="ribbon-title">üî© Materi√°l & Polotovar</div>
                <div class="ribbon-toggle" x-text="showMaterial ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body ribbon-body-sections" x-show="showMaterial">
                
                <!-- SEKCE: Materi√°l -->
                <div x-data="{ expanded: true }" style="margin-bottom: -1px;">
                    <div @click="expanded = !expanded" class="section-header">
                        <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">MATERI√ÅL</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñº</span>
                    </div>
                    <div x-show="expanded" class="section-body" style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.75rem;">
                        <div>
                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Kategorie materi√°lu</label>
                            <div x-show="!dataLoaded" style="padding: 0.4rem; color: var(--text-muted); font-size: 0.75rem;">
                                Naƒç√≠t√°n√≠...
                            </div>
                            <select x-show="dataLoaded" x-model="partData.material_group" @change="updatePart(); updateStockPrice();" @input="updateStockPrice()"
                                    style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                <option value="">-- Vyberte materi√°l --</option>
                                <template x-for="mat in materials" :key="mat.code">
                                    <option :value="mat.code" :selected="mat.code === partData.material_group" x-text="mat.name"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Oznaƒçen√≠ materi√°lu</label>
                            <input type="text" x-model="partData.material_name" @input="updatePart()"
                                   placeholder="nap≈ô. 1.4301, S235..."
                                   style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                        </div>
                        
                        <!-- Rozmƒõry polotovaru (editovateln√©) -->
                        <div>
                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Typ polotovaru</label>
                            <select x-model="partData.stock_type" @change="updatePart(); updateStockPrice();" @input="updateStockPrice()"
                                    style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                                <option value="tyc">üîµ Tyƒç</option>
                                <option value="trubka">‚≠ï Trubka</option>
                                <option value="prizez">üì¶ P≈ô√≠≈ôez</option>
                                <option value="odlitek">üè≠ Odlitek</option>
                                <option value="plech">üìÑ Plech</option>
                            </select>
                        </div>
                        
                        <!-- Rozmƒõry podle typu -->
                        <div x-show="['tyc', 'trubka', 'odlitek'].includes(partData.stock_type)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">√ò [mm]</label>
                                <input type="number" step="0.1" x-model.number="partData.stock_diameter" @input="updatePart(); updateStockPrice();"
                                       style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D√©lka [mm]</label>
                                <input type="number" step="0.1" x-model.number="partData.stock_length" @input="updatePart(); updateStockPrice();"
                                       style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                        
                        <div x-show="partData.stock_type === 'trubka'">
                            <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">Vnit≈ôn√≠ √ò [mm]</label>
                            <input type="number" step="0.1" x-model.number="partData.stock_diameter_inner" @input="updatePart(); updateStockPrice();"
                                   style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                        </div>
                        
                        <div x-show="['prizez', 'plech'].includes(partData.stock_type)" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">D [mm]</label>
                                <input type="number" step="0.1" x-model.number="partData.stock_length" @input="updatePart(); updateStockPrice();"
                                       style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">≈† [mm]</label>
                                <input type="number" step="0.1" x-model.number="partData.stock_width" @input="updatePart(); updateStockPrice();"
                                       style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-bottom: 0.25rem;">V [mm]</label>
                                <input type="number" step="0.1" x-model.number="partData.stock_height" @input="updatePart(); updateStockPrice();"
                                       style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.4rem; font-size: 0.75rem; color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SEKCE: Polotovar (cena) -->
                <div x-data="{ expanded: true }">
                    <div @click="expanded = !expanded" class="section-header">
                        <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">POLOTOVAR</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted);" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñº</span>
                    </div>
                    <div x-show="expanded" class="section-body">
                        <div x-show="stockPrice.cost > 0" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Hmotnost:</span>
                                <span style="font-weight: 600;" x-text="stockPrice.weight_kg.toFixed(3) + ' kg'">0 kg</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Cena/kg:</span>
                                <span style="font-weight: 600;" x-text="stockPrice.price_per_kg.toFixed(0) + ' Kƒç'">0 Kƒç</span>
                            </div>
                            <div style="border-top: 1px solid var(--border-color); margin: 0.25rem 0;"></div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted); font-weight: 600;">CELKEM:</span>
                                <span style="font-weight: 700; font-size: 0.9rem; color: var(--accent-blue);" x-text="stockPrice.cost.toFixed(0) + ' Kƒç'">0 Kƒç</span>
                            </div>
                        </div>
                        <div x-show="stockPrice.cost === 0" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.7rem;">
                            Naƒç√≠t√°n√≠...
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Cenov√Ω p≈ôehled -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showPrices = !showPrices">
                <div class="ribbon-title">üìä Cenov√Ω p≈ôehled</div>
                <div class="ribbon-toggle" x-text="showPrices ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showPrices">
                <table class="price-table">
                    <tbody>
                        <template x-for="batch in batches" :key="batch.id">
                            <tr>
                                <td class="batch-qty" x-text="batch.quantity + ' ks'"></td>
                                <td class="price-value" x-text="batch.unit_cost.toFixed(0) + ' Kƒç'"></td>
                            </tr>
                        </template>
                        <tr x-show="batches.length === 0">
                            <td colspan="2" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.75rem;">
                                Zat√≠m ≈æ√°dn√© ceny
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tlaƒç√≠tko zpƒõt -->
        <a href="/parts" class="btn-flat" style="text-decoration: none; text-align: center;">
            ‚Üê Zpƒõt na seznam
        </a>
        
    </div>
    
    <!-- RIGHT PANEL -->
    <div class="right-panel">
        
        <!-- ƒåas na kus (STICKY RIBBON) -->
        <div class="right-panel-sticky">
            <div class="ribbon">
                <div class="ribbon-header" @click="showTime = !showTime">
                    <div class="ribbon-title">‚è±Ô∏è ƒåas na kus</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--accent-blue);" x-text="totalTime.toFixed(1) + ' min'">
                            0.0 min
                        </div>
                        <div class="ribbon-toggle" x-text="showTime ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showTime">
                    <div style="color: var(--text-muted); font-size: 0.75rem;">
                        Detailn√≠ rozpad ƒçasu (zat√≠m neimplementov√°no)
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scrollovateln√Ω obsah -->
        <div class="right-panel-content">
            
            <!-- Operace (RIBBON) -->
            <div class="ribbon">
                <div class="ribbon-header" @click="showOperations = !showOperations">
                    <div class="ribbon-title">
                        üîß OPERACE (<span x-text="operations.length">0</span>)
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="addOperation" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                            + P≈ôidat operaci
                        </button>
                        <div class="ribbon-toggle" x-text="showOperations ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                
                <div class="ribbon-body" x-show="showOperations" style="padding: 0.5rem;">
                    <!-- Seznam operac√≠ -->
                    <template x-for="(op, index) in operations" :key="op.id">
                <div class="operation-card" x-data="{ expanded: false }">
                    <!-- Header (klikac√≠) -->
                    <div class="op-header" @click="expanded = !expanded" style="cursor: pointer;">
                        <div class="op-seq" x-text="op.seq"></div>
                        <div class="op-icon" x-text="op.icon"></div>
                        <div class="op-name" x-text="op.name"></div>
                        
                        <div class="op-header-right">
                            <!-- Mode buttons -->
                            <div class="mode-buttons-inline" @click.stop>
                                <button @click="changeMode(op.id, 'low')" 
                                        :class="{ 'active': op.cutting_mode === 'low' }"
                                        class="mode-btn-sm mode-low">LOW</button>
                                <button @click="changeMode(op.id, 'mid')"
                                        :class="{ 'active': op.cutting_mode === 'mid' }"
                                        class="mode-btn-sm mode-mid">MID</button>
                                <button @click="changeMode(op.id, 'high')"
                                        :class="{ 'active': op.cutting_mode === 'high' }"
                                        class="mode-btn-sm mode-high">HIGH</button>
                            </div>
                            
                            <!-- Times -->
                            <div class="op-time-display">
                                tp: <strong x-text="op.operation_time_min.toFixed(1)"></strong> min
                            </div>
                            <div class="op-time-display">
                                tj: <strong x-text="op.setup_time_min.toFixed(1)"></strong> min
                            </div>
                            
                            <!-- Expand indicator -->
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-left: 0.5rem;" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                        </div>
                    </div>
                    
                    <!-- Features (rozbalovac√≠) -->
                    <div class="features-section" x-show="expanded" x-collapse>
                        <div class="no-features">
                            üìù Kroky operace (zat√≠m neimplementov√°no)
                        </div>
                    </div>
                </div>
                    </template>
                    
                    <!-- Pr√°zdn√Ω stav -->
                    <div x-show="operations.length === 0" 
                         style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">üîß Zat√≠m ≈æ√°dn√© operace</div>
                        <div style="font-size: 0.75rem;">Klikni na "+ P≈ôidat operaci" pro zaƒç√°tek</div>
                    </div>
                </div><!-- /ribbon-body -->
            </div><!-- /ribbon operace -->
            
        </div><!-- /right-panel-content -->
        
    </div><!-- /right-panel -->
    
</div><!-- /split-layout -->

<script>
function partEdit(partId) {
    return {
        partId: partId,
        operations: [],
        batches: [],
        totalTime: 0,
        showBasic: true,
        showTime: true,
        showOperations: true,
        showMaterial: true,
        showPrices: true,
        
        dataLoaded: false,  // Flag pro naƒçten√≠ dat
        
        partData: {
            material_group: '',
            material_name: '',
            stock_type: 'tyc',
            stock_diameter: 0,
            stock_diameter_inner: 0,
            stock_length: 0,
            stock_width: 0,
            stock_height: 0
        },
        
        materials: [],  // Naƒçten√© z API
        
        stockPrice: {
            volume_mm3: 0,
            weight_kg: 0,
            price_per_kg: 0,
            cost: 0
        },
        
        updateTimeout: null,
        priceTimeout: null,
        
        async init() {
            console.log('Initializing part edit for ID:', this.partId);
            // D≈ÆLE≈ΩIT√â: Naƒç√≠st data d√≠lu A materi√°ly P≈òED zobrazen√≠m
            await Promise.all([
                this.loadPartData(),
                this.loadMaterials()
            ]);
            // Nastavit flag ≈æe data jsou naƒçten√°
            this.dataLoaded = true;
            // Poƒçkat na vykreslen√≠ DOM (x-for mus√≠ vykreslit options)
            await this.$nextTick();
            // Teƒè naƒç√≠st zbytek
            await Promise.all([
                this.loadOperations(),
                this.loadBatches(),
                this.loadStockPrice()
            ]);
        },
        
        async loadMaterials() {
            try {
                const response = await fetch('/api/data/materials');
                if (response.ok) {
                    this.materials = await response.json();
                    console.log('Materials loaded:', this.materials.length);
                }
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        },
        
        async loadPartData() {
            try {
                const response = await fetch(`/api/parts/${this.partId}`);
                if (response.ok) {
                    const part = await response.json();
                    this.partData = {
                        material_group: part.material_group,
                        material_name: part.material_name || '',
                        stock_type: part.stock_type,
                        stock_diameter: part.stock_diameter,
                        stock_diameter_inner: part.stock_diameter_inner,
                        stock_length: part.stock_length,
                        stock_width: part.stock_width,
                        stock_height: part.stock_height
                    };
                }
            } catch (error) {
                console.error('Error loading part data:', error);
            }
        },
        
        async loadOperations() {
            try {
                const response = await fetch(`/api/operations/part/${this.partId}`);
                if (response.ok) {
                    this.operations = await response.json();
                    this.calculateTotalTime();
                    console.log('Loaded operations:', this.operations);
                }
            } catch (error) {
                console.error('Error loading operations:', error);
            }
        },
        
        async loadBatches() {
            try {
                const response = await fetch(`/api/batches/part/${this.partId}`);
                if (response.ok) {
                    this.batches = await response.json();
                    console.log('Loaded batches:', this.batches);
                }
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        },
        
        calculateTotalTime() {
            this.totalTime = this.operations.reduce((sum, op) => sum + op.operation_time_min, 0);
        },
        
        async addOperation() {
            const maxSeq = this.operations.reduce((max, op) => Math.max(max, op.seq), 0);
            
            console.log('Adding operation with seq:', maxSeq + 10);
            
            try {
                const response = await fetch('/api/operations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        seq: maxSeq + 10,
                        name: 'OP' + (maxSeq + 10) + ' - Soustru≈æen√≠',
                        type: 'turning',
                        icon: 'üîÑ',
                        cutting_mode: 'mid',
                        setup_time_min: 30.0
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('API error:', error);
                    window.showToast('‚ùå ' + (error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ operace'), 'error');
                    return;
                }
                
                const newOp = await response.json();
                this.operations.push(newOp);
                this.calculateTotalTime();
                console.log('Operation added:', newOp);
                window.showToast('‚úÖ Operace p≈ôid√°na', 'success');
                
            } catch (error) {
                console.error('Error adding operation:', error);
                window.showToast('‚ùå Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
            }
        },
        
        async changeMode(operationId, mode) {
            try {
                const response = await fetch(`/api/operations/${operationId}/change-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cutting_mode: mode })
                });
                
                if (response.ok) {
                    const updatedOp = await response.json();
                    const index = this.operations.findIndex(op => op.id === operationId);
                    if (index !== -1) {
                        this.operations[index] = updatedOp;
                        this.calculateTotalTime();
                    }
                    window.showToast(`‚úÖ Re≈æim zmƒõnƒõn na ${mode.toUpperCase()}`, 'success');
                }
            } catch (error) {
                console.error('Error changing mode:', error);
                window.showToast('‚ùå Chyba p≈ôi zmƒõnƒõ re≈æimu', 'error');
            }
        },
        
        async loadStockPrice() {
            try {
                console.log('Loading stock price for:', this.partData);
                
                const params = new URLSearchParams({
                    stock_type: this.partData.stock_type,
                    material_group: this.partData.material_group,
                    stock_diameter: this.partData.stock_diameter || 0,
                    stock_length: this.partData.stock_length || 0,
                    stock_diameter_inner: this.partData.stock_diameter_inner || 0,
                    stock_width: this.partData.stock_width || 0,
                    stock_height: this.partData.stock_height || 0,
                });
                
                const url = `/api/data/stock-price?${params}`;
                console.log('Fetching:', url);
                
                const priceResponse = await fetch(url);
                
                if (priceResponse.ok) {
                    this.stockPrice = await priceResponse.json();
                    console.log('Stock price loaded:', this.stockPrice);
                } else {
                    console.error('Failed to load stock price:', priceResponse.status);
                }
            } catch (error) {
                console.error('Error loading stock price:', error);
            }
        },
        
        updatePart() {
            // Debounce - ƒçekej 500ms po posledn√≠m inputu
            clearTimeout(this.updateTimeout);
            this.updateTimeout = setTimeout(async () => {
                await this.savePart();
            }, 500);
        },
        
        async savePart() {
            try {
                const response = await fetch(`/api/parts/${this.partId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.partData)
                });
                
                if (response.ok) {
                    console.log('Part updated');
                } else {
                    console.error('Failed to update part');
                }
            } catch (error) {
                console.error('Error updating part:', error);
            }
        },
        
        updateStockPrice() {
            console.log('updateStockPrice called');
            // Debounce pro p≈ôepoƒçet ceny (samostatn√Ω timeout!)
            clearTimeout(this.priceTimeout);
            this.priceTimeout = setTimeout(async () => {
                console.log('Debounce timeout fired, calling loadStockPrice');
                await this.loadStockPrice();
            }, 300);
        }
    }
}
</script>
{% endblock %}
