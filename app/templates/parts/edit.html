{% extends "base.html" %}

{% block title %}GESTIMA - {{ part.part_number }}{% endblock %}

{% block content %}
<div class="split-layout" x-data="partEdit({{ part.id }})">
    
    <!-- LEFT PANEL (280px) -->
    <div class="left-panel">
        
        <!-- Z√°kladn√≠ √∫daje -->
        <div class="ribbon">
            <div class="ribbon-header" @click="showBasic = !showBasic">
                <div class="ribbon-title">üìã Z√°kladn√≠ √∫daje</div>
                <div class="ribbon-toggle" x-text="showBasic ? '‚ñº' : '‚ñ∂'">‚ñº</div>
            </div>
            <div class="ribbon-body" x-show="showBasic" x-data="{ showBasic: true }">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.8rem;">
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">ƒå√≠slo v√Ωkresu</div>
                        <div style="font-weight: 600;">{{ part.part_number }}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">N√°zev</div>
                        <div>{{ part.name or '-' }}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">Materi√°l</div>
                        <div>{{ part.material_group }}</div>
                        {% if part.material_name %}
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">{{ part.material_name }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.25rem;">Polotovar</div>
                        <div>{{ part.stock_type.value }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cenov√Ω p≈ôehled -->
        <div class="ribbon">
            <div class="ribbon-header">
                <div class="ribbon-title">üìä Cenov√Ω p≈ôehled</div>
            </div>
            <div class="ribbon-body">
                <table class="price-table">
                    <tbody>
                        <template x-for="batch in batches" :key="batch.id">
                            <tr>
                                <td class="batch-qty" x-text="batch.quantity + ' ks'"></td>
                                <td class="price-value" x-text="batch.unit_cost.toFixed(0) + ' Kƒç'"></td>
                            </tr>
                        </template>
                        <tr x-show="batches.length === 0">
                            <td colspan="2" style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.75rem;">
                                Zat√≠m ≈æ√°dn√© ceny
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tlaƒç√≠tko zpƒõt -->
        <a href="/parts" class="btn-flat" style="text-decoration: none; text-align: center;">
            ‚Üê Zpƒõt na seznam
        </a>
        
    </div>
    
    <!-- RIGHT PANEL -->
    <div class="right-panel">
        
        <!-- ƒåas na kus (STICKY RIBBON) -->
        <div class="right-panel-sticky">
            <div class="ribbon">
                <div class="ribbon-header" @click="showTime = !showTime">
                    <div class="ribbon-title">‚è±Ô∏è ƒåas na kus</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--accent-blue);" x-text="totalTime.toFixed(1) + ' min'">
                            0.0 min
                        </div>
                        <div class="ribbon-toggle" x-text="showTime ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                <div class="ribbon-body" x-show="showTime">
                    <div style="color: var(--text-muted); font-size: 0.75rem;">
                        Detailn√≠ rozpad ƒçasu (zat√≠m neimplementov√°no)
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scrollovateln√Ω obsah -->
        <div class="right-panel-content">
            
            <!-- Operace (RIBBON) -->
            <div class="ribbon">
                <div class="ribbon-header" @click="showOperations = !showOperations">
                    <div class="ribbon-title">
                        üîß OPERACE (<span x-text="operations.length">0</span>)
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button @click.stop="addOperation" class="btn-flat btn-add-op" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                            + P≈ôidat operaci
                        </button>
                        <div class="ribbon-toggle" x-text="showOperations ? '‚ñº' : '‚ñ∂'">‚ñº</div>
                    </div>
                </div>
                
                <div class="ribbon-body" x-show="showOperations" style="padding: 0.5rem;">
                    <!-- Seznam operac√≠ -->
                    <template x-for="(op, index) in operations" :key="op.id">
                <div class="operation-card" x-data="{ expanded: false }">
                    <!-- Header (klikac√≠) -->
                    <div class="op-header" @click="expanded = !expanded" style="cursor: pointer;">
                        <div class="op-seq" x-text="op.seq"></div>
                        <div class="op-icon" x-text="op.icon"></div>
                        <div class="op-name" x-text="op.name"></div>
                        
                        <div class="op-header-right">
                            <!-- Mode buttons -->
                            <div class="mode-buttons-inline" @click.stop>
                                <button @click="changeMode(op.id, 'low')" 
                                        :class="{ 'active': op.cutting_mode === 'low' }"
                                        class="mode-btn-sm mode-low">LOW</button>
                                <button @click="changeMode(op.id, 'mid')"
                                        :class="{ 'active': op.cutting_mode === 'mid' }"
                                        class="mode-btn-sm mode-mid">MID</button>
                                <button @click="changeMode(op.id, 'high')"
                                        :class="{ 'active': op.cutting_mode === 'high' }"
                                        class="mode-btn-sm mode-high">HIGH</button>
                            </div>
                            
                            <!-- Times -->
                            <div class="op-time-display">
                                tp: <strong x-text="op.operation_time_min.toFixed(1)"></strong> min
                            </div>
                            <div class="op-time-display">
                                tj: <strong x-text="op.setup_time_min.toFixed(1)"></strong> min
                            </div>
                            
                            <!-- Expand indicator -->
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-left: 0.5rem;" x-text="expanded ? '‚ñº' : '‚ñ∂'">‚ñ∂</div>
                        </div>
                    </div>
                    
                    <!-- Features (rozbalovac√≠) -->
                    <div class="features-section" x-show="expanded" x-collapse>
                        <div class="no-features">
                            üìù Kroky operace (zat√≠m neimplementov√°no)
                        </div>
                    </div>
                </div>
                    </template>
                    
                    <!-- Pr√°zdn√Ω stav -->
                    <div x-show="operations.length === 0" 
                         style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">üîß Zat√≠m ≈æ√°dn√© operace</div>
                        <div style="font-size: 0.75rem;">Klikni na "+ P≈ôidat operaci" pro zaƒç√°tek</div>
                    </div>
                </div><!-- /ribbon-body -->
            </div><!-- /ribbon operace -->
            
        </div><!-- /right-panel-content -->
        
    </div><!-- /right-panel -->
    
</div><!-- /split-layout -->

<script>
function partEdit(partId) {
    return {
        partId: partId,
        operations: [],
        batches: [],
        totalTime: 0,
        showBasic: true,
        showTime: true,
        showOperations: true,
        
        async init() {
            console.log('Initializing part edit for ID:', this.partId);
            await this.loadOperations();
            await this.loadBatches();
        },
        
        async loadOperations() {
            try {
                const response = await fetch(`/api/operations/part/${this.partId}`);
                if (response.ok) {
                    this.operations = await response.json();
                    this.calculateTotalTime();
                    console.log('Loaded operations:', this.operations);
                }
            } catch (error) {
                console.error('Error loading operations:', error);
            }
        },
        
        async loadBatches() {
            try {
                const response = await fetch(`/api/batches/part/${this.partId}`);
                if (response.ok) {
                    this.batches = await response.json();
                    console.log('Loaded batches:', this.batches);
                }
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        },
        
        calculateTotalTime() {
            this.totalTime = this.operations.reduce((sum, op) => sum + op.operation_time_min, 0);
        },
        
        async addOperation() {
            const maxSeq = this.operations.reduce((max, op) => Math.max(max, op.seq), 0);
            
            console.log('Adding operation with seq:', maxSeq + 10);
            
            try {
                const response = await fetch('/api/operations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        part_id: this.partId,
                        seq: maxSeq + 10,
                        name: 'OP' + (maxSeq + 10) + ' - Soustru≈æen√≠',
                        type: 'turning',
                        icon: 'üîÑ',
                        cutting_mode: 'mid',
                        setup_time_min: 30.0
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('API error:', error);
                    window.showToast('‚ùå ' + (error.detail || 'Chyba p≈ôi p≈ôid√°n√≠ operace'), 'error');
                    return;
                }
                
                const newOp = await response.json();
                this.operations.push(newOp);
                this.calculateTotalTime();
                console.log('Operation added:', newOp);
                window.showToast('‚úÖ Operace p≈ôid√°na', 'success');
                
            } catch (error) {
                console.error('Error adding operation:', error);
                window.showToast('‚ùå Chyba p≈ôi p≈ôid√°n√≠ operace', 'error');
            }
        },
        
        async changeMode(operationId, mode) {
            try {
                const response = await fetch(`/api/operations/${operationId}/change-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cutting_mode: mode })
                });
                
                if (response.ok) {
                    const updatedOp = await response.json();
                    const index = this.operations.findIndex(op => op.id === operationId);
                    if (index !== -1) {
                        this.operations[index] = updatedOp;
                        this.calculateTotalTime();
                    }
                    window.showToast(`‚úÖ Re≈æim zmƒõnƒõn na ${mode.toUpperCase()}`, 'success');
                }
            } catch (error) {
                console.error('Error changing mode:', error);
                window.showToast('‚ùå Chyba p≈ôi zmƒõnƒõ re≈æimu', 'error');
            }
        }
    }
}
</script>
{% endblock %}
