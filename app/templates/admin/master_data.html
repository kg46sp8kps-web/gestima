{% extends "base.html" %}

{% block title %}Master Data - GESTIMA{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/forms.css">
<style>
[x-cloak] { display: none !important; }
/* Tabs styling */
.admin-tabs {
    display: flex;
    gap: 0.25rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.admin-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
    top: 2px;
}

.admin-tab:hover {
    color: var(--text-primary);
    background: var(--bg-primary);
}

.admin-tab.active {
    color: var(--accent-red);
    border-bottom-color: var(--accent-red);
    font-weight: 600;
}

/* Table styling */
.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.admin-table thead {
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border-color);
}

.admin-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.admin-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.admin-table tbody tr:hover {
    background: var(--bg-primary);
}

.alias-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    background: var(--bg-secondary);
    border-radius: 3px;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}

.primary-code {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
}

.standard-badge {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-left: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700;">‚öôÔ∏è Master Data</h1>
        <p style="color: var(--text-muted); margin-top: 0.5rem;">
            Centr√°ln√≠ spr√°va kmenov√Ωch dat: materi√°ly, pracovi≈°tƒõ, koeficienty
        </p>
    </div>

    <!-- Alpine.js component -->
    <script>
        // Pass data via JavaScript variable to avoid inline JSON issues
        window.MATERIAL_NORMS_DATA = {{ norms_json | tojson | safe }};
        window.MATERIAL_GROUPS_DATA = {{ groups_json | tojson | safe }};
        window.MATERIAL_CATEGORIES_DATA = {{ categories_json | tojson | safe }};
        window.WORK_CENTERS_DATA = {{ work_centers_json | tojson | safe }};
        window.WORK_CENTER_TYPES = {{ work_center_types | tojson | safe }};
    </script>
    <div x-data="adminPanel(window.MATERIAL_NORMS_DATA, window.MATERIAL_GROUPS_DATA, window.MATERIAL_CATEGORIES_DATA, window.WORK_CENTERS_DATA, window.WORK_CENTER_TYPES)" x-on:close-modal.window="showModal = false; showWorkCenterModal = false">
        <!-- Tabs -->
        <div class="admin-tabs">
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'norms' }"
                @click="activeTab = 'norms'">
                üìã Material Norms
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'groups' }"
                @click="activeTab = 'groups'">
                üè∑Ô∏è Groups (<span x-text="allGroups.length"></span>)
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'categories' }"
                @click="activeTab = 'categories'">
                üí∞ Ceny (<span x-text="allCategories.length"></span>)
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'workcenters' }"
                @click="activeTab = 'workcenters'">
                üè≠ Pracovi≈°tƒõ (<span x-text="allWorkCenters.length"></span>)
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'config' }"
                @click="activeTab = 'config'">
                ‚öôÔ∏è Nastaven√≠
            </button>
        </div>

        <!-- Tab: Material Norms -->
        <div x-show="activeTab === 'norms'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Material Norms</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Mapov√°n√≠ oznaƒçen√≠ materi√°l≈Ø (EN, DIN, AISI, ƒåSN) na MaterialGroup.
                        Podporuje aliasy (nap≈ô. 1.4301 = X5CrNi18-10 = AISI 304).
                    </p>
                </div>
                <button @click="openCreateNorm()" class="btn btn-primary">
                    ‚ûï P≈ôidat normu
                </button>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat normu (nap≈ô. 1.4301, C45, AISI 304)..."
                    x-model="searchQuery"
                    class="form-input"
                    style="max-width: 400px;">
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    <span x-show="searchQuery.length > 0">
                        Nalezeno: <strong x-text="filteredNorms.length"></strong> z <strong x-text="allNorms.length"></strong>
                    </span>
                </small>
            </div>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>W.Nr</th>
                        <th>EN ISO</th>
                        <th>ƒåSN</th>
                        <th>AISI</th>
                        <th>Kategorie materi√°lu</th>
                        <th>Hustota</th>
                        <th style="text-align: right;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="norm in filteredNorms" :key="norm.id">
                        <tr>
                            <td x-text="norm.w_nr || '-'"></td>
                            <td x-text="norm.en_iso || '-'"></td>
                            <td x-text="norm.csn || '-'"></td>
                            <td x-text="norm.aisi || '-'"></td>
                            <td style="font-weight: 500;" x-text="norm.material_group.name"></td>
                            <td style="color: var(--text-secondary); font-size: 0.85rem;" x-text="norm.material_group.density + ' kg/dm¬≥'"></td>
                            <td style="text-align: right;">
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        @click="editNorm(norm.id, norm.w_nr || '', norm.en_iso || '', norm.csn || '', norm.aisi || '', norm.material_group_id, norm.note || '', norm.version)">
                                    Upravit
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredNorms.length === 0">
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span x-show="searchQuery.length > 0">≈Ω√°dn√© v√Ωsledky pro "<span x-text="searchQuery"></span>"</span>
                            <span x-show="searchQuery.length === 0">≈Ω√°dn√© normy v datab√°zi</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Info box -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Jak funguje p≈ôevodn√≠ tabulka:</div>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <li>Ka≈æd√Ω ≈ô√°dek = p≈ôevodn√≠ z√°znam (4 sloupce norem ‚Üí 1 kategorie materi√°lu)</li>
                    <li>P≈ô√≠klad: W.Nr "1.0503" | EN ISO "C45" | ƒåSN "12050" | AISI "1045" ‚Üí Ocel konstrukƒçn√≠</li>
                    <li>P≈ôi vytv√°≈ôen√≠ MaterialItem zad√°≈° k√≥d (nap≈ô. "D20 11109" nebo "1.0036-HR005w05-T")</li>
                    <li>Syst√©m extrahuje normu a najde ji v tabulce nap≈ô√≠ƒç v≈°emi 4 sloupci</li>
                    <li>Automaticky p≈ôi≈ôad√≠ MaterialGroup (hustota) + MaterialPriceCategory (cena)</li>
                </ul>
            </div>
        </div>

        <!-- Tab: Material Groups -->
        <div x-show="activeTab === 'groups'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üè∑Ô∏è Material Groups</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Kategorie materi√°l≈Ø pro v√Ωpoƒçty (hustota, ≈ôezn√© podm√≠nky).
                    </p>
                </div>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat skupinu..."
                    x-model="searchGroupQuery"
                    class="form-input"
                    style="max-width: 400px;">
            </div>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>K√≥d</th>
                        <th>N√°zev</th>
                        <th>Hustota (kg/dm¬≥)</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="group in filteredGroups" :key="group.id">
                        <tr>
                            <td style="font-weight: 600; font-family: monospace;" x-text="group.code"></td>
                            <td x-text="group.name"></td>
                            <td style="color: var(--text-secondary);" x-text="group.density"></td>
                        </tr>
                    </template>
                    <tr x-show="filteredGroups.length === 0">
                        <td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            ≈Ω√°dn√© skupiny
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tab: Price Categories -->
        <div x-show="activeTab === 'categories'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üí∞ Cenov√© Kategorie</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Cenov√© kategorie s price tiers (hmotnostn√≠ p√°sma). Klikni na ≈ô√°dek pro zobrazen√≠ cen.
                    </p>
                </div>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat kategorii..."
                    x-model="searchCategoryQuery"
                    class="form-input"
                    style="max-width: 400px;">
            </div>

            <!-- Categories List (Expandable) -->
            <div style="border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden;">
                <template x-for="category in filteredCategories" :key="category.id">
                    <div style="border-bottom: 1px solid var(--border-color);">
                        <!-- Category Row (Clickable) -->
                        <div @click="toggleCategory(category.id)"
                             style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s;"
                             :style="isCategoryExpanded(category.id) ? 'background: var(--bg-primary);' : ''"
                             @mouseenter="$el.style.background = 'var(--bg-primary)'"
                             @mouseleave="$el.style.background = isCategoryExpanded(category.id) ? 'var(--bg-primary)' : 'transparent'">

                            <!-- Expand/Collapse Icon -->
                            <span style="font-size: 0.7rem; color: var(--text-muted); width: 12px; transition: transform 0.2s;"
                                  :style="isCategoryExpanded(category.id) ? 'transform: rotate(90deg);' : ''">
                                ‚ñ∂
                            </span>

                            <!-- Category Info -->
                            <div style="flex: 1;">
                                <span style="font-family: monospace; font-weight: 600; color: var(--accent-blue);" x-text="category.code"></span>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî</span>
                                <span style="margin-left: 0.5rem;" x-text="category.name"></span>
                                <template x-if="category.material_group">
                                    <span style="color: var(--text-muted); margin-left: 0.5rem;">
                                        (<span x-text="category.material_group.name"></span>)
                                    </span>
                                </template>
                            </div>

                            <!-- Tier count badge -->
                            <span style="background: var(--bg-secondary); padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.75rem; color: var(--text-muted);">
                                <span x-text="category.tiers.length"></span> tier<span x-show="category.tiers.length !== 1">s</span>
                            </span>
                        </div>

                        <!-- Price Tiers (Expanded) -->
                        <div x-show="isCategoryExpanded(category.id)"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform scale-95"
                             x-transition:enter-end="opacity-100 transform scale-100"
                             style="background: var(--bg-primary); padding: 0.5rem 1rem 0.75rem 3rem;">
                            <template x-if="category.tiers.length > 0">
                                <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                                    <template x-for="tier in category.tiers" :key="tier.id">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                            <span style="color: var(--text-secondary); min-width: 80px;">
                                                <span x-text="tier.min_weight"></span>‚Äì<span x-show="tier.max_weight !== null" x-text="tier.max_weight"></span><span x-show="tier.max_weight === null">‚àû</span> kg
                                            </span>
                                            <span style="color: var(--text-muted);">‚Üí</span>
                                            <span style="font-weight: 600; color: var(--accent-green);">
                                                <span x-text="tier.price_per_kg"></span> Kƒç/kg
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="category.tiers.length === 0">
                                <div style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">
                                    ≈Ω√°dn√© price tiers
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- No results -->
            <div x-show="filteredCategories.length === 0" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                ≈Ω√°dn√© kategorie
            </div>
        </div>

        <!-- Tab: Work Centers -->
        <div x-show="activeTab === 'workcenters'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üè≠ Pracovi≈°tƒõ</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Stroje a pracovi≈°tƒõ pro TPV kalkulace. Hodinov√© sazby, tech specs, capabilities.
                    </p>
                </div>
                <button @click="openCreateWorkCenter()" class="btn btn-primary">
                    ‚ûï P≈ôidat pracovi≈°tƒõ
                </button>
            </div>

            <!-- Search + Filters -->
            <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <input
                    type="text"
                    placeholder="üîç Hledat pracovi≈°tƒõ..."
                    x-model="searchWorkCenterQuery"
                    class="form-input"
                    style="max-width: 300px;">
                <select x-model="filterWorkCenterType" class="form-input" style="max-width: 200px;">
                    <option value="">V≈°echny typy</option>
                    <template x-for="t in workCenterTypes" :key="t.value">
                        <option :value="t.value" x-text="getWorkCenterTypeLabel(t.value)"></option>
                    </template>
                </select>
                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <input type="checkbox" x-model="showInactiveWorkCenters">
                    Zobrazit neaktivn√≠
                </label>
            </div>

            <!-- Dirty Rate Warning -->
            <template x-if="workCentersNeedingRecalc.length > 0">
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; border-left: 4px solid #ff6b6b;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                                <span x-text="workCentersNeedingRecalc.length"></span> pracovi≈°tƒõ <span x-show="workCentersNeedingRecalc.length === 1">m√°</span><span x-show="workCentersNeedingRecalc.length > 1">maj√≠</span> zmƒõnƒõn√© sazby
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">
                                Hodinov√© sazby byly zmƒõnƒõny, ale batches nebyly p≈ôepoƒç√≠t√°ny. Ceny mohou b√Ωt neaktu√°ln√≠!
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                Pracovi≈°tƒõ:
                                <template x-for="(wc, index) in workCentersNeedingRecalc" :key="wc.id">
                                    <span>
                                        <strong x-text="wc.name"></strong><span x-show="index < workCentersNeedingRecalc.length - 1">, </span>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ƒå√≠slo</th>
                        <th>N√°zev</th>
                        <th>Typ</th>
                        <th>Sazba (Kƒç/h)</th>
                        <th>Capabilities</th>
                        <th>Status</th>
                        <th style="text-align: right;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="wc in filteredWorkCenters" :key="wc.id">
                        <tr :style="!wc.is_active ? 'opacity: 0.5;' : ''">
                            <td style="font-family: monospace; font-weight: 600;" x-text="wc.work_center_number"></td>
                            <td x-text="wc.name"></td>
                            <td>
                                <span x-text="getWorkCenterTypeIcon(wc.work_center_type)"></span>
                                <span style="font-size: 0.8rem; color: var(--text-secondary);" x-text="getWorkCenterTypeLabel(wc.work_center_type)"></span>
                            </td>
                            <td>
                                <template x-if="wc.hourly_rate_total">
                                    <span style="font-weight: 600; color: var(--accent-green);" x-text="wc.hourly_rate_total + ' Kƒç'"></span>
                                </template>
                                <template x-if="!wc.hourly_rate_total">
                                    <span style="color: var(--text-muted);">-</span>
                                </template>
                            </td>
                            <td style="font-size: 0.8rem;">
                                <span x-show="wc.has_bar_feeder" title="Bar Feeder" style="margin-right: 0.25rem;">üì¶</span>
                                <span x-show="wc.has_sub_spindle" title="Protiv≈ôeteno" style="margin-right: 0.25rem;">üîÑ</span>
                                <span x-show="wc.has_milling" title="Live Tooling" style="margin-right: 0.25rem;">‚öôÔ∏è</span>
                                <span x-show="wc.axes >= 4" title="Multi-axis" style="margin-right: 0.25rem;" x-text="wc.axes + 'AX'"></span>
                            </td>
                            <td>
                                <span x-show="wc.is_active" style="color: var(--accent-green); font-size: 0.8rem;">‚úÖ Aktivn√≠</span>
                                <span x-show="!wc.is_active" style="color: var(--text-muted); font-size: 0.8rem;">‚ùå Neaktivn√≠</span>
                            </td>
                            <td style="text-align: right;">
                                <button class="btn-flat"
                                        :style="wc.needs_batch_recalculation
                                            ? 'padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #ff6b6b; color: white; font-weight: 600;'
                                            : 'padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--text-muted);'"
                                        :title="wc.needs_batch_recalculation ? 'P≈ôepoƒç√≠tat batches (sazby zmƒõnƒõny!)' : 'Batches aktu√°ln√≠'"
                                        :disabled="!wc.needs_batch_recalculation"
                                        @click="recalculateWorkCenterBatches(wc)">
                                    üîÑ P≈ôepoƒç√≠tat
                                </button>
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        @click="editWorkCenter(wc)">
                                    Upravit
                                </button>
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--error);"
                                        @click="deleteWorkCenter(wc)">
                                    Smazat
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredWorkCenters.length === 0">
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span x-show="searchWorkCenterQuery.length > 0 || filterWorkCenterType">≈Ω√°dn√© v√Ωsledky</span>
                            <span x-show="searchWorkCenterQuery.length === 0 && !filterWorkCenterType">≈Ω√°dn√° pracovi≈°tƒõ v datab√°zi</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Info box -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Hodinov√© sazby:</div>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <li><strong>Sazba se≈ô√≠zen√≠ (tp):</strong> Odpisy + Mzda + Re≈æie (bez n√°stroj≈Ø)</li>
                    <li><strong>Sazba v√Ωroby (tj):</strong> Odpisy + Mzda + N√°stroje + Re≈æie</li>
                    <li>Virtu√°ln√≠ pracovi≈°tƒõ (Kontrola, Kooperace) nemus√≠ m√≠t sazby</li>
                </ul>
            </div>
        </div>

        <!-- Tab: System Config -->
        <div x-show="activeTab === 'config'" x-cloak>
            <div style="margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">‚öôÔ∏è Syst√©mov√© nastaven√≠</h2>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">
                    Glob√°ln√≠ cenov√© koeficienty pro kalkulace
                </p>
            </div>

            <!-- Success/Error messages -->
            <div x-show="successMessage"
                 class="alert alert-success"
                 x-text="successMessage"
                 style="margin-bottom: 1.5rem;"></div>
            <div x-show="errorMessage"
                 class="alert alert-error"
                 x-text="errorMessage"
                 style="margin-bottom: 1.5rem;"></div>

            <!-- Form -->
            <form @submit.prevent="saveSettings">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Koeficienty jsou n√°sobitele (1.20 = +20%, 1.25 = +25%, atd.)
                    </p>
                </div>

                <!-- Coefficients grid -->
                <div class="form-grid-2col">
                    {% for config in configs %}
                    <div class="form-field">
                        <label for="{{ config.key }}">
                            {{ config.description }}
                            <span style="color: var(--error);">*</span>
                        </label>
                        <input
                            type="number"
                            id="{{ config.key }}"
                            name="{{ config.key }}"
                            x-model="values['{{ config.key }}']"
                            value="{{ config.value_float }}"
                            step="0.01"
                            min="1.0"
                            max="5.0"
                            required
                            class="form-input"
                        >
                        <input type="hidden" name="version_{{ config.key }}" value="{{ config.version }}">
                        <small class="help-text">
                            Aktu√°lnƒõ: {{ config.value_float }}
                            {% if config.updated_by %}
                            | Upravil: {{ config.updated_by }} ({{ config.updated_at.strftime('%d.%m.%Y %H:%M') }})
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>

                <!-- Info box -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Jak koeficienty funguj√≠:</div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        <li><strong>Overhead (re≈æie):</strong> N√°sob√≠ n√°klady stroj≈Ø (administrativn√≠ re≈æie)</li>
                        <li><strong>Margin (mar≈æe):</strong> N√°sob√≠ pr√°ci (stroje + re≈æie) pro zisk</li>
                        <li><strong>Stock (skladov√Ω):</strong> N√°sob√≠ cenu materi√°lu (ztr√°ty, ≈ôezivo)</li>
                        <li><strong>Coop (kooperaƒçn√≠):</strong> N√°sob√≠ cenu kooperace (handling, komunikace)</li>
                    </ul>
                </div>

                <!-- Action buttons -->
                <div class="btn-group btn-group-right" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" @click="window.location.href='/'">
                        Zru≈°it
                    </button>
                    <button type="submit"
                            class="btn btn-primary"
                            :disabled="saving"
                            x-text="saving ? 'Ukl√°d√°m...' : 'Ulo≈æit zmƒõny'">
                    </button>
                </div>
            </form>
        </div>

        <!-- Modal for Create/Edit MaterialNorm -->
        <div x-show="showModal" x-cloak @keydown.escape.window="showModal = false">
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" @click.self="showModal = false">
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <p>üöß Modal pro p≈ôid√°n√≠/editaci norem bude implementov√°n v p≈ô√≠≈°t√≠ verzi.</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                        Zat√≠m m≈Ø≈æe≈° normy spravovat p≈ô√≠mo v datab√°zi nebo p≈ôes API endpointy.
                    </p>
                    <button @click="showModal = false" class="btn btn-primary" style="margin-top: 1.5rem;">
                        Zav≈ô√≠t
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for Create/Edit WorkCenter -->
        <div x-show="showWorkCenterModal" x-cloak @keydown.escape.window="showWorkCenterModal = false">
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" @click.self="showWorkCenterModal = false">
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 2rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <span x-show="!editingWorkCenter">‚ûï P≈ôidat pracovi≈°tƒõ</span>
                        <span x-show="editingWorkCenter">‚úèÔ∏è Upravit pracovi≈°tƒõ</span>
                    </h3>

                    <form @submit.prevent="saveWorkCenter()">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-field">
                                <label>N√°zev <span style="color: var(--error);">*</span></label>
                                <input type="text" x-model="wcForm.name" required maxlength="200" class="form-input" placeholder="nap≈ô. MASTURN 32">
                            </div>
                            <div class="form-field">
                                <label>Typ <span style="color: var(--error);">*</span></label>
                                <select x-model="wcForm.work_center_type" required class="form-input">
                                    <option value="">-- Vyber typ --</option>
                                    <template x-for="t in workCenterTypes" :key="t.value">
                                        <option :value="t.value" x-text="getWorkCenterTypeIcon(t.value) + ' ' + getWorkCenterTypeLabel(t.value)"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Hourly Rates -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem;">üí∞ Hodinov√© sazby (Kƒç/h)</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-field">
                                    <label>Odpisy stroje</label>
                                    <input type="number" x-model.number="wcForm.hourly_rate_amortization" step="1" min="0" class="form-input" placeholder="400">
                                </div>
                                <div class="form-field">
                                    <label>Mzda oper√°tora</label>
                                    <input type="number" x-model.number="wcForm.hourly_rate_labor" step="1" min="0" class="form-input" placeholder="300">
                                </div>
                                <div class="form-field">
                                    <label>N√°stroje</label>
                                    <input type="number" x-model.number="wcForm.hourly_rate_tools" step="1" min="0" class="form-input" placeholder="200">
                                </div>
                                <div class="form-field">
                                    <label>Provozn√≠ re≈æie</label>
                                    <input type="number" x-model.number="wcForm.hourly_rate_overhead" step="1" min="0" class="form-input" placeholder="300">
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                Celkem: <strong x-text="computeWcTotal()"></strong> Kƒç/h
                            </div>
                        </div>

                        <!-- Capabilities (show for CNC types) -->
                        <template x-if="isCncType(wcForm.work_center_type)">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.75rem;">üîß Capabilities</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" x-model="wcForm.has_bar_feeder">
                                        üì¶ Bar Feeder
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" x-model="wcForm.has_sub_spindle">
                                        üîÑ Protiv≈ôeteno
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" x-model="wcForm.has_milling">
                                        ‚öôÔ∏è Live Tooling
                                    </label>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <div class="form-field">
                                        <label>Max √∏ obrobku (mm)</label>
                                        <input type="number" x-model.number="wcForm.max_workpiece_diameter" step="1" min="0" class="form-input">
                                    </div>
                                    <div class="form-field">
                                        <label>Max d√©lka (mm)</label>
                                        <input type="number" x-model.number="wcForm.max_workpiece_length" step="1" min="0" class="form-input">
                                    </div>
                                    <div class="form-field">
                                        <label>Poƒçet os</label>
                                        <select x-model.number="wcForm.axes" class="form-input">
                                            <option value="">-</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Setup Times -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 0.75rem;">‚è±Ô∏è Se≈ôizovac√≠ ƒçasy</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-field">
                                    <label>Z√°kladn√≠ se≈ô√≠zen√≠ (min)</label>
                                    <input type="number" x-model.number="wcForm.setup_base_min" step="1" min="0" class="form-input" placeholder="30">
                                </div>
                                <div class="form-field">
                                    <label>Se≈ô√≠zen√≠ na n√°stroj (min)</label>
                                    <input type="number" x-model.number="wcForm.setup_per_tool_min" step="0.5" min="0" class="form-input" placeholder="3">
                                </div>
                            </div>
                        </div>

                        <!-- Production Suitability + Status -->
                        <div style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" x-model="wcForm.suitable_for_series">
                                Vhodn√Ω pro s√©rie
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" x-model="wcForm.suitable_for_single">
                                Vhodn√Ω pro kusy
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" x-model="wcForm.is_active">
                                ‚úÖ Aktivn√≠
                            </label>
                        </div>

                        <!-- Notes -->
                        <div class="form-field" style="margin-bottom: 1.5rem;">
                            <label>Pozn√°mky</label>
                            <textarea x-model="wcForm.notes" rows="2" maxlength="1000" class="form-input" placeholder="Voliteln√© pozn√°mky..."></textarea>
                        </div>

                        <!-- Buttons -->
                        <div class="btn-group btn-group-right">
                            <button type="button" class="btn btn-secondary" @click="showWorkCenterModal = false">
                                Zru≈°it
                            </button>
                            <button type="submit" class="btn btn-primary" :disabled="savingWorkCenter"
                                    x-text="savingWorkCenter ? 'Ukl√°d√°m...' : (editingWorkCenter ? 'Ulo≈æit zmƒõny' : 'Vytvo≈ôit')">
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function adminPanel(allNorms, allGroups, allCategories, allWorkCenters, workCenterTypes) {
    return {
        // Tab state
        activeTab: 'norms',

        // Material Norms tab
        allNorms: allNorms || [],
        searchQuery: '',
        showModal: false,

        // Material Groups tab
        allGroups: allGroups || [],
        searchGroupQuery: '',

        // Price Categories tab
        allCategories: allCategories || [],
        searchCategoryQuery: '',
        expandedCategories: [],

        // Work Centers tab
        allWorkCenters: allWorkCenters || [],
        workCenterTypes: workCenterTypes || [],
        searchWorkCenterQuery: '',
        filterWorkCenterType: '',
        showInactiveWorkCenters: false,
        showWorkCenterModal: false,
        editingWorkCenter: null,
        savingWorkCenter: false,
        wcForm: {
            name: '',
            work_center_type: '',
            hourly_rate_amortization: null,
            hourly_rate_labor: null,
            hourly_rate_tools: null,
            hourly_rate_overhead: null,
            max_workpiece_diameter: null,
            max_workpiece_length: null,
            axes: null,
            has_bar_feeder: false,
            has_sub_spindle: false,
            has_milling: false,
            setup_base_min: 30,
            setup_per_tool_min: 3,
            suitable_for_series: true,
            suitable_for_single: true,
            is_active: true,
            notes: '',
            version: 1
        },

        // Computed: filteredNorms based on searchQuery
        get filteredNorms() {
            if (!this.searchQuery || this.searchQuery.trim().length === 0) {
                return this.allNorms;
            }

            const query = this.searchQuery.trim().toLowerCase();

            return this.allNorms.filter(norm => {
                // Search across all 4 columns + category name (case-insensitive)
                const w_nr = (norm.w_nr || '').toLowerCase();
                const en_iso = (norm.en_iso || '').toLowerCase();
                const csn = (norm.csn || '').toLowerCase();
                const aisi = (norm.aisi || '').toLowerCase();
                const category = (norm.material_group?.name || '').toLowerCase();

                return w_nr.includes(query) ||
                       en_iso.includes(query) ||
                       csn.includes(query) ||
                       aisi.includes(query) ||
                       category.includes(query);
            });
        },

        // Computed: filteredGroups
        get filteredGroups() {
            if (!this.searchGroupQuery || this.searchGroupQuery.trim().length === 0) {
                return this.allGroups;
            }

            const query = this.searchGroupQuery.trim().toLowerCase();

            return this.allGroups.filter(group => {
                const code = (group.code || '').toLowerCase();
                const name = (group.name || '').toLowerCase();
                return code.includes(query) || name.includes(query);
            });
        },

        // Computed: filteredCategories
        get filteredCategories() {
            if (!this.searchCategoryQuery || this.searchCategoryQuery.trim().length === 0) {
                return this.allCategories;
            }

            const query = this.searchCategoryQuery.trim().toLowerCase();

            return this.allCategories.filter(category => {
                const code = (category.code || '').toLowerCase();
                const name = (category.name || '').toLowerCase();
                return code.includes(query) || name.includes(query);
            });
        },

        // Computed: filteredWorkCenters
        get filteredWorkCenters() {
            let filtered = this.allWorkCenters;

            // Filter by active status
            if (!this.showInactiveWorkCenters) {
                filtered = filtered.filter(wc => wc.is_active);
            }

            // Filter by type
            if (this.filterWorkCenterType) {
                filtered = filtered.filter(wc => wc.work_center_type === this.filterWorkCenterType);
            }

            // Filter by search query
            if (this.searchWorkCenterQuery && this.searchWorkCenterQuery.trim().length > 0) {
                const query = this.searchWorkCenterQuery.trim().toLowerCase();
                filtered = filtered.filter(wc => {
                    const number = (wc.work_center_number || '').toLowerCase();
                    const name = (wc.name || '').toLowerCase();
                    return number.includes(query) || name.includes(query);
                });
            }

            return filtered;
        },

        // Computed: workCentersNeedingRecalc (dirty rate warning)
        get workCentersNeedingRecalc() {
            return this.allWorkCenters.filter(wc => wc.needs_batch_recalculation === true);
        },

        // Work Center type helpers
        getWorkCenterTypeIcon(type) {
            const icons = {
                'CNC_LATHE': 'üîÑ',
                'CNC_MILL_3AX': '‚öôÔ∏è',
                'CNC_MILL_4AX': '‚öôÔ∏è',
                'CNC_MILL_5AX': '‚öôÔ∏è',
                'SAW': 'ü™ö',
                'DRILL': 'üî©',
                'QUALITY_CONTROL': '‚úÖ',
                'MANUAL_ASSEMBLY': 'üîß',
                'EXTERNAL': 'üè≠'
            };
            return icons[type] || 'üè≠';
        },

        getWorkCenterTypeLabel(type) {
            const labels = {
                'CNC_LATHE': 'Soustruh',
                'CNC_MILL_3AX': 'Fr√©zka 3-axis',
                'CNC_MILL_4AX': 'Fr√©zka 4-axis',
                'CNC_MILL_5AX': 'Fr√©zka 5-axis',
                'SAW': 'Pila',
                'DRILL': 'Vrtaƒçka',
                'QUALITY_CONTROL': 'Kontrola',
                'MANUAL_ASSEMBLY': 'Mont√°≈æ',
                'EXTERNAL': 'Kooperace'
            };
            return labels[type] || type;
        },

        isCncType(type) {
            return type && (type.startsWith('CNC_') || type === 'DRILL');
        },

        computeWcTotal() {
            const rates = [
                this.wcForm.hourly_rate_amortization,
                this.wcForm.hourly_rate_labor,
                this.wcForm.hourly_rate_tools,
                this.wcForm.hourly_rate_overhead
            ];
            const sum = rates.reduce((acc, r) => acc + (r || 0), 0);
            return sum > 0 ? sum : '-';
        },

        // Work Center CRUD
        openCreateWorkCenter() {
            this.editingWorkCenter = null;
            this.wcForm = {
                name: '',
                work_center_type: '',
                hourly_rate_amortization: null,
                hourly_rate_labor: null,
                hourly_rate_tools: null,
                hourly_rate_overhead: null,
                max_workpiece_diameter: null,
                max_workpiece_length: null,
                axes: null,
                has_bar_feeder: false,
                has_sub_spindle: false,
                has_milling: false,
                setup_base_min: 30,
                setup_per_tool_min: 3,
                suitable_for_series: true,
                suitable_for_single: true,
                is_active: true,
                notes: '',
                version: 1
            };
            this.showWorkCenterModal = true;
        },

        editWorkCenter(wc) {
            this.editingWorkCenter = wc;
            this.wcForm = {
                name: wc.name,
                work_center_type: wc.work_center_type,
                hourly_rate_amortization: wc.hourly_rate_amortization,
                hourly_rate_labor: wc.hourly_rate_labor,
                hourly_rate_tools: wc.hourly_rate_tools,
                hourly_rate_overhead: wc.hourly_rate_overhead,
                max_workpiece_diameter: wc.max_workpiece_diameter,
                max_workpiece_length: wc.max_workpiece_length,
                axes: wc.axes,
                has_bar_feeder: wc.has_bar_feeder,
                has_sub_spindle: wc.has_sub_spindle,
                has_milling: wc.has_milling,
                setup_base_min: wc.setup_base_min,
                setup_per_tool_min: wc.setup_per_tool_min,
                suitable_for_series: wc.suitable_for_series,
                suitable_for_single: wc.suitable_for_single,
                is_active: wc.is_active,
                notes: wc.notes || '',
                version: wc.version
            };
            this.showWorkCenterModal = true;
        },

        async saveWorkCenter() {
            this.savingWorkCenter = true;

            try {
                const url = this.editingWorkCenter
                    ? `/api/work-centers/${this.editingWorkCenter.work_center_number}`
                    : '/api/work-centers';

                const method = this.editingWorkCenter ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.wcForm)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                }

                const saved = await response.json();

                if (this.editingWorkCenter) {
                    const index = this.allWorkCenters.findIndex(w => w.id === saved.id);
                    if (index !== -1) {
                        this.allWorkCenters[index] = saved;
                    }
                    window.showToast && window.showToast('Pracovi≈°tƒõ aktualizov√°no', 'success');
                } else {
                    this.allWorkCenters.push(saved);
                    window.showToast && window.showToast('Pracovi≈°tƒõ vytvo≈ôeno', 'success');
                }

                this.showWorkCenterModal = false;
            } catch (error) {
                console.error('Error saving work center:', error);
                window.showToast && window.showToast(error.message, 'error');
            } finally {
                this.savingWorkCenter = false;
            }
        },

        async deleteWorkCenter(wc) {
            if (!confirm(`Opravdu smazat pracovi≈°tƒõ "${wc.name}"?\n\nTato akce je nevratn√°.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/work-centers/${wc.work_center_number}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi maz√°n√≠');
                }

                this.allWorkCenters = this.allWorkCenters.filter(w => w.id !== wc.id);
                window.showToast && window.showToast('Pracovi≈°tƒõ smaz√°no', 'success');
            } catch (error) {
                console.error('Error deleting work center:', error);
                window.showToast && window.showToast(error.message, 'error');
            }
        },

        async recalculateWorkCenterBatches(wc) {
            if (!wc.needs_batch_recalculation) {
                return;
            }

            const confirmMsg = `P≈ôepoƒç√≠tat v≈°echny batches pou≈æ√≠vaj√≠c√≠ "${wc.name}"?\n\nBude p≈ôepoƒç√≠t√°na cena v≈°ech nezamƒçen√Ωch batches s t√≠mto pracovi≈°tƒõm.`;
            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                window.showToast && window.showToast(`P≈ôepoƒç√≠t√°v√°m batches pro ${wc.name}...`, 'info');

                const response = await fetch(`/api/work-centers/${wc.work_center_number}/recalculate-batches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi p≈ôepoƒçtu');
                }

                const result = await response.json();

                // Refresh work center data to update timestamps
                const wcResponse = await fetch(`/api/work-centers/${wc.work_center_number}`);
                if (wcResponse.ok) {
                    const updatedWc = await wcResponse.json();
                    const index = this.allWorkCenters.findIndex(w => w.id === wc.id);
                    if (index !== -1) {
                        this.allWorkCenters[index] = updatedWc;
                    }
                }

                const msg = result.failed_count > 0
                    ? `P≈ôepoƒç√≠t√°no ${result.recalculated_count} batches, ${result.failed_count} selhalo`
                    : `‚úÖ P≈ôepoƒç√≠t√°no ${result.recalculated_count} batches`;

                window.showToast && window.showToast(msg, result.failed_count > 0 ? 'warning' : 'success');
            } catch (error) {
                console.error('Error recalculating batches:', error);
                window.showToast && window.showToast(`Chyba: ${error.message}`, 'error');
            }
        },

        // System Config tab
        saving: false,
        successMessage: '',
        errorMessage: '',
        values: {
            {% for config in configs -%}
            '{{ config.key }}': {{ config.value_float }}{% if not loop.last %},{% endif %}
            {% endfor %}
        },
        versions: {
            {% for config in configs -%}
            '{{ config.key }}': {{ config.version }}{% if not loop.last %},{% endif %}
            {% endfor %}
        },

        openCreateNorm() {
            this.showModal = true;
            // Dispatch event to materialNormForm component
            window.dispatchEvent(new CustomEvent('create-material-norm'));
        },

        editNorm(id, w_nr, en_iso, csn, aisi, material_group_id, note, version) {
            this.showModal = true;
            // Dispatch event to materialNormForm component
            window.dispatchEvent(new CustomEvent('edit-material-norm', {
                detail: {
                    id: id,
                    w_nr: w_nr,
                    en_iso: en_iso,
                    csn: csn,
                    aisi: aisi,
                    material_group_id: material_group_id,
                    note: note,
                    version: version
                }
            }));
        },

        toggleCategory(id) {
            const index = this.expandedCategories.indexOf(id);
            if (index === -1) {
                this.expandedCategories.push(id);
            } else {
                this.expandedCategories.splice(index, 1);
            }
        },

        isCategoryExpanded(id) {
            return this.expandedCategories.includes(id);
        },

        async saveSettings() {
            this.saving = true;
            this.successMessage = '';
            this.errorMessage = '';

            const configs = [
                {% for config in configs %}
                { key: '{{ config.key }}', value: this.values['{{ config.key }}'], version: this.versions['{{ config.key }}'] },
                {% endfor %}
            ];

            let allSuccess = true;

            for (const config of configs) {
                try {
                    const response = await fetch(`/api/config/${config.key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            value_float: parseFloat(config.value),
                            version: config.version
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                    }

                    const updated = await response.json();
                    this.versions[config.key] = updated.version;

                } catch (error) {
                    console.error(`Error updating ${config.key}:`, error);
                    this.errorMessage = `Chyba p≈ôi ukl√°d√°n√≠ ${config.key}: ${error.message}`;
                    allSuccess = false;
                    break;
                }
            }

            this.saving = false;

            if (allSuccess) {
                this.successMessage = '‚úÖ Nastaven√≠ √∫spƒõ≈°nƒõ ulo≈æeno';
                window.showToast && window.showToast('Nastaven√≠ ulo≈æeno', 'success');

                // Reload page after 1 second to show updated timestamps
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                window.showToast && window.showToast(this.errorMessage, 'error');
            }
        }
    };
}
</script>
{% endblock %}
