{% extends "base.html" %}

{% block title %}Admin - Kategorie materi√°l≈Ø - GESTIMA{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/forms.css">
<style>
[x-cloak] { display: none !important; }
/* Tabs styling */
.admin-tabs {
    display: flex;
    gap: 0.25rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.admin-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
    top: 2px;
}

.admin-tab:hover {
    color: var(--text-primary);
    background: var(--bg-primary);
}

.admin-tab.active {
    color: var(--accent-red);
    border-bottom-color: var(--accent-red);
    font-weight: 600;
}

/* Table styling */
.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.admin-table thead {
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border-color);
}

.admin-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.admin-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.admin-table tbody tr:hover {
    background: var(--bg-primary);
}

/* Modal styling */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700;">üì¶ Kategorie materi√°l≈Ø</h1>
        <p style="color: var(--text-muted); margin-top: 0.5rem;">
            Spr√°va materi√°lov√Ωch skupin a cenov√Ωch kategori√≠ p≈ôed importem katalogu
        </p>
    </div>

    <!-- Alpine.js component -->
    <script>
        // Pass data via JavaScript variable to avoid inline JSON issues
        window.MATERIAL_GROUPS_DATA = {{ groups_json | tojson | safe }};
        window.MATERIAL_PRICE_CATEGORIES_DATA = {{ categories_json | tojson | safe }};
    </script>
    <div x-data="materialCatalogAdmin(window.MATERIAL_GROUPS_DATA, window.MATERIAL_PRICE_CATEGORIES_DATA)">
        <!-- Tabs -->
        <div class="admin-tabs">
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'groups' }"
                @click="activeTab = 'groups'">
                üè∑Ô∏è Material Groups (<span x-text="allGroups.length"></span>)
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'categories' }"
                @click="activeTab = 'categories'">
                üí∞ Price Categories (<span x-text="allCategories.length"></span>)
            </button>
        </div>

        <!-- Tab: Material Groups -->
        <div x-show="activeTab === 'groups'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üè∑Ô∏è Material Groups</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Kategorie materi√°l≈Ø pro v√Ωpoƒçty (hustota, ≈ôezn√© podm√≠nky).
                    </p>
                </div>
                <button @click="openCreateGroup()" class="btn btn-primary">
                    ‚ûï P≈ôidat skupinu
                </button>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat skupinu (k√≥d, n√°zev)..."
                    x-model="searchGroupQuery"
                    class="form-input"
                    style="max-width: 400px;">
            </div>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>K√≥d</th>
                        <th>N√°zev</th>
                        <th>Hustota (kg/dm¬≥)</th>
                        <th style="text-align: right;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="group in filteredGroups" :key="group.id">
                        <tr>
                            <td style="font-weight: 600; font-family: monospace;" x-text="group.code"></td>
                            <td x-text="group.name"></td>
                            <td style="color: var(--text-secondary);" x-text="group.density"></td>
                            <td style="text-align: right;">
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        @click="editGroup(group)">
                                    Upravit
                                </button>
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--error);"
                                        @click="deleteGroup(group)">
                                    Smazat
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredGroups.length === 0">
                        <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span x-show="searchGroupQuery.length > 0">≈Ω√°dn√© v√Ωsledky pro "<span x-text="searchGroupQuery"></span>"</span>
                            <span x-show="searchGroupQuery.length === 0">≈Ω√°dn√© skupiny v datab√°zi</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Info box -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è O Material Groups:</div>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <li>Kategorie pro technick√© v√Ωpoƒçty (hustota, ≈ôezn√© podm√≠nky)</li>
                    <li>P≈ô√≠klady: "Ocel konstrukƒçn√≠" (7.85 kg/dm¬≥), "Hlin√≠k 6060" (2.70 kg/dm¬≥)</li>
                    <li>Hustota se pou≈æije pro v√Ωpoƒçet v√°hy d√≠l≈Ø a polotovar≈Ø</li>
                    <li>P≈ôed importem katalogu zkontroluj ≈æe m√°≈° v≈°echny pot≈ôebn√© skupiny</li>
                </ul>
            </div>
        </div>

        <!-- Tab: Material Price Categories -->
        <div x-show="activeTab === 'categories'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üí∞ Material Price Categories</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Cenov√© kategorie pro skupiny polotovar≈Ø (tvar + materi√°l).
                    </p>
                </div>
                <button @click="openCreateCategory()" class="btn btn-primary">
                    ‚ûï P≈ôidat kategorii
                </button>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat kategorii (k√≥d, n√°zev)..."
                    x-model="searchCategoryQuery"
                    class="form-input"
                    style="max-width: 400px;">
            </div>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>K√≥d</th>
                        <th>N√°zev</th>
                        <th>Material Group</th>
                        <th style="text-align: right;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="category in filteredCategories" :key="category.id">
                        <tr>
                            <td style="font-weight: 600; font-family: monospace;" x-text="category.code"></td>
                            <td x-text="category.name"></td>
                            <td style="color: var(--text-secondary);">
                                <span x-show="category.material_group" x-text="category.material_group?.name"></span>
                                <span x-show="!category.material_group" style="font-style: italic;">-</span>
                            </td>
                            <td style="text-align: right;">
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        @click="editCategory(category)">
                                    Upravit
                                </button>
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--error);"
                                        @click="deleteCategory(category)">
                                    Smazat
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredCategories.length === 0">
                        <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span x-show="searchCategoryQuery.length > 0">≈Ω√°dn√© v√Ωsledky pro "<span x-text="searchCategoryQuery"></span>"</span>
                            <span x-show="searchCategoryQuery.length === 0">≈Ω√°dn√© kategorie v datab√°zi</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Info box -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è O Price Categories:</div>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <li>Cenov√© kategorie kombinuj√≠ tvar + materi√°l</li>
                    <li>P≈ô√≠klady: "OCEL-KONS-KRUHOVA" (ocel konstrukƒçn√≠ - kruhov√° tyƒç), "HLINIK-DESKA" (hlin√≠k - deska)</li>
                    <li>V≈°echny polotovary ve stejn√© kategorii sd√≠l√≠ price tiers (0-15kg, 15-100kg, ...)</li>
                    <li>P≈ôed importem katalogu zkontroluj ≈æe m√°≈° v≈°echny pot≈ôebn√© kategorie</li>
                </ul>
            </div>
        </div>

        <!-- Modal for MaterialGroup Create/Edit -->
        <div x-show="showGroupModal" x-cloak @keydown.escape.window="showGroupModal = false">
            <div class="modal-overlay" @click.self="showGroupModal = false">
                <div class="modal-content">
                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <span x-show="!editingGroup">‚ûï P≈ôidat Material Group</span>
                        <span x-show="editingGroup">‚úèÔ∏è Upravit Material Group</span>
                    </h3>

                    <form @submit.prevent="saveGroup()">
                        <div class="form-field">
                            <label for="group-code">
                                K√≥d skupiny <span style="color: var(--error);">*</span>
                            </label>
                            <input
                                type="text"
                                id="group-code"
                                x-model="groupForm.code"
                                placeholder="nap≈ô. 11xxx, S235"
                                required
                                maxlength="20"
                                class="form-input">
                            <small class="help-text">Unik√°tn√≠ k√≥d pro identifikaci (nap≈ô. 11xxx pro automaty)</small>
                        </div>

                        <div class="form-field">
                            <label for="group-name">
                                N√°zev skupiny <span style="color: var(--error);">*</span>
                            </label>
                            <input
                                type="text"
                                id="group-name"
                                x-model="groupForm.name"
                                placeholder="nap≈ô. Ocel automatov√°"
                                required
                                maxlength="100"
                                class="form-input">
                        </div>

                        <div class="form-field">
                            <label for="group-density">
                                Hustota (kg/dm¬≥) <span style="color: var(--error);">*</span>
                            </label>
                            <input
                                type="number"
                                id="group-density"
                                x-model.number="groupForm.density"
                                placeholder="nap≈ô. 7.85"
                                required
                                step="0.01"
                                min="0.01"
                                class="form-input">
                            <small class="help-text">Hustota materi√°lu pro v√Ωpoƒçet v√°hy (ocel ~7.85, hlin√≠k ~2.70)</small>
                        </div>

                        <div class="btn-group btn-group-right" style="margin-top: 2rem;">
                            <button type="button" class="btn btn-secondary" @click="showGroupModal = false">
                                Zru≈°it
                            </button>
                            <button type="submit"
                                    class="btn btn-primary"
                                    :disabled="saving"
                                    x-text="saving ? 'Ukl√°d√°m...' : (editingGroup ? 'Ulo≈æit zmƒõny' : 'Vytvo≈ôit')">
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for MaterialPriceCategory Create/Edit -->
        <div x-show="showCategoryModal" x-cloak @keydown.escape.window="showCategoryModal = false">
            <div class="modal-overlay" @click.self="showCategoryModal = false">
                <div class="modal-content">
                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <span x-show="!editingCategory">‚ûï P≈ôidat Price Category</span>
                        <span x-show="editingCategory">‚úèÔ∏è Upravit Price Category</span>
                    </h3>

                    <form @submit.prevent="saveCategory()">
                        <div class="form-field">
                            <label for="category-code">
                                K√≥d kategorie <span style="color: var(--error);">*</span>
                            </label>
                            <input
                                type="text"
                                id="category-code"
                                x-model="categoryForm.code"
                                placeholder="nap≈ô. OCEL-KONS-KRUHOVA"
                                required
                                maxlength="50"
                                class="form-input">
                            <small class="help-text">Unik√°tn√≠ k√≥d (form√°t: MATERIAL-SHAPE)</small>
                        </div>

                        <div class="form-field">
                            <label for="category-name">
                                N√°zev kategorie <span style="color: var(--error);">*</span>
                            </label>
                            <input
                                type="text"
                                id="category-name"
                                x-model="categoryForm.name"
                                placeholder="nap≈ô. OCEL konstrukƒçn√≠ - kruhov√° tyƒç"
                                required
                                maxlength="200"
                                class="form-input">
                        </div>

                        <div class="btn-group btn-group-right" style="margin-top: 2rem;">
                            <button type="button" class="btn btn-secondary" @click="showCategoryModal = false">
                                Zru≈°it
                            </button>
                            <button type="submit"
                                    class="btn btn-primary"
                                    :disabled="saving"
                                    x-text="saving ? 'Ukl√°d√°m...' : (editingCategory ? 'Ulo≈æit zmƒõny' : 'Vytvo≈ôit')">
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function materialCatalogAdmin(initialGroups, initialCategories) {
    return {
        // Tab state
        activeTab: 'groups',

        // Data
        allGroups: initialGroups || [],
        allCategories: initialCategories || [],

        // Search
        searchGroupQuery: '',
        searchCategoryQuery: '',

        // Modals
        showGroupModal: false,
        showCategoryModal: false,
        editingGroup: null,
        editingCategory: null,
        saving: false,

        // Forms
        groupForm: {
            code: '',
            name: '',
            density: null,
            version: 1
        },
        categoryForm: {
            code: '',
            name: '',
            version: 1
        },

        // Computed: filteredGroups
        get filteredGroups() {
            if (!this.searchGroupQuery || this.searchGroupQuery.trim().length === 0) {
                return this.allGroups;
            }

            const query = this.searchGroupQuery.trim().toLowerCase();

            return this.allGroups.filter(group => {
                const code = (group.code || '').toLowerCase();
                const name = (group.name || '').toLowerCase();
                return code.includes(query) || name.includes(query);
            });
        },

        // Computed: filteredCategories
        get filteredCategories() {
            if (!this.searchCategoryQuery || this.searchCategoryQuery.trim().length === 0) {
                return this.allCategories;
            }

            const query = this.searchCategoryQuery.trim().toLowerCase();

            return this.allCategories.filter(category => {
                const code = (category.code || '').toLowerCase();
                const name = (category.name || '').toLowerCase();
                return code.includes(query) || name.includes(query);
            });
        },

        // === MaterialGroup Actions ===

        openCreateGroup() {
            this.editingGroup = null;
            this.groupForm = {
                code: '',
                name: '',
                density: null,
                version: 1
            };
            this.showGroupModal = true;
        },

        editGroup(group) {
            this.editingGroup = group;
            this.groupForm = {
                code: group.code,
                name: group.name,
                density: group.density,
                version: group.version
            };
            this.showGroupModal = true;
        },

        async saveGroup() {
            this.saving = true;

            try {
                const url = this.editingGroup
                    ? `/admin/api/material-groups/${this.editingGroup.id}`
                    : '/admin/api/material-groups';

                const method = this.editingGroup ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.groupForm)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                }

                const savedGroup = await response.json();

                // Update local data
                if (this.editingGroup) {
                    const index = this.allGroups.findIndex(g => g.id === savedGroup.id);
                    if (index !== -1) {
                        this.allGroups[index] = savedGroup;
                    }
                    window.showToast && window.showToast('Skupina aktualizov√°na', 'success');
                } else {
                    this.allGroups.push(savedGroup);
                    window.showToast && window.showToast('Skupina vytvo≈ôena', 'success');
                }

                this.showGroupModal = false;
            } catch (error) {
                console.error('Error saving group:', error);
                window.showToast && window.showToast(error.message, 'error');
            } finally {
                this.saving = false;
            }
        },

        async deleteGroup(group) {
            if (!confirm(`Opravdu smazat skupinu "${group.code}"?\n\nTato akce je nevratn√°.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/api/material-groups/${group.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi maz√°n√≠');
                }

                // Remove from local data
                this.allGroups = this.allGroups.filter(g => g.id !== group.id);
                window.showToast && window.showToast('Skupina smaz√°na', 'success');
            } catch (error) {
                console.error('Error deleting group:', error);
                window.showToast && window.showToast(error.message, 'error');
            }
        },

        // === MaterialPriceCategory Actions ===

        openCreateCategory() {
            this.editingCategory = null;
            this.categoryForm = {
                code: '',
                name: '',
                version: 1
            };
            this.showCategoryModal = true;
        },

        editCategory(category) {
            this.editingCategory = category;
            this.categoryForm = {
                code: category.code,
                name: category.name,
                version: category.version
            };
            this.showCategoryModal = true;
        },

        async saveCategory() {
            this.saving = true;

            try {
                const url = this.editingCategory
                    ? `/admin/api/material-price-categories/${this.editingCategory.id}`
                    : '/admin/api/material-price-categories';

                const method = this.editingCategory ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.categoryForm)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                }

                const savedCategory = await response.json();

                // Update local data
                if (this.editingCategory) {
                    const index = this.allCategories.findIndex(c => c.id === savedCategory.id);
                    if (index !== -1) {
                        // Preserve material_group if it exists
                        savedCategory.material_group = this.allCategories[index].material_group;
                        this.allCategories[index] = savedCategory;
                    }
                    window.showToast && window.showToast('Kategorie aktualizov√°na', 'success');
                } else {
                    this.allCategories.push(savedCategory);
                    window.showToast && window.showToast('Kategorie vytvo≈ôena', 'success');
                }

                this.showCategoryModal = false;
            } catch (error) {
                console.error('Error saving category:', error);
                window.showToast && window.showToast(error.message, 'error');
            } finally {
                this.saving = false;
            }
        },

        async deleteCategory(category) {
            if (!confirm(`Opravdu smazat kategorii "${category.code}"?\n\nTato akce je nevratn√°.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/api/material-price-categories/${category.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi maz√°n√≠');
                }

                // Remove from local data
                this.allCategories = this.allCategories.filter(c => c.id !== category.id);
                window.showToast && window.showToast('Kategorie smaz√°na', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                window.showToast && window.showToast(error.message, 'error');
            }
        }
    };
}
</script>
{% endblock %}
