{% extends "base.html" %}

{% block title %}Admin - Material Norms - GESTIMA{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/forms.css">
<style>
[x-cloak] { display: none !important; }
/* Tabs styling */
.admin-tabs {
    display: flex;
    gap: 0.25rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.admin-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
    top: 2px;
}

.admin-tab:hover {
    color: var(--text-primary);
    background: var(--bg-primary);
}

.admin-tab.active {
    color: var(--accent-red);
    border-bottom-color: var(--accent-red);
    font-weight: 600;
}

/* Table styling */
.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.admin-table thead {
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border-color);
}

.admin-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.admin-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.admin-table tbody tr:hover {
    background: var(--bg-primary);
}

.alias-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    background: var(--bg-secondary);
    border-radius: 3px;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}

.primary-code {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
}

.standard-badge {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-left: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700;">‚öôÔ∏è Administrace syst√©mu</h1>
        <p style="color: var(--text-muted); margin-top: 0.5rem;">
            Spr√°va materi√°lov√Ωch norem a glob√°ln√≠ho nastaven√≠
        </p>
    </div>

    <!-- Alpine.js component -->
    <script>
        // Pass data via JavaScript variable to avoid inline JSON issues
        window.MATERIAL_NORMS_DATA = {{ norms_json | tojson | safe }};
    </script>
    <div x-data="adminPanel(window.MATERIAL_NORMS_DATA)" x-on:close-modal.window="showModal = false">
        <!-- Tabs -->
        <div class="admin-tabs">
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'norms' }"
                @click="activeTab = 'norms'">
                üìã Material Norms
            </button>
            <button
                class="admin-tab"
                :class="{ 'active': activeTab === 'config' }"
                @click="activeTab = 'config'">
                ‚öôÔ∏è Syst√©mov√© nastaven√≠
            </button>
        </div>

        <!-- Tab: Material Norms -->
        <div x-show="activeTab === 'norms'" x-cloak>
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Material Norms</h2>
                    <p style="color: var(--text-secondary); font-size: 0.85rem;">
                        Mapov√°n√≠ oznaƒçen√≠ materi√°l≈Ø (EN, DIN, AISI, ƒåSN) na MaterialGroup.
                        Podporuje aliasy (nap≈ô. 1.4301 = X5CrNi18-10 = AISI 304).
                    </p>
                </div>
                <button @click="openCreateNorm()" class="btn btn-primary">
                    ‚ûï P≈ôidat normu
                </button>
            </div>

            <!-- Search -->
            <div style="margin-bottom: 1.5rem;">
                <input
                    type="text"
                    placeholder="üîç Hledat normu (nap≈ô. 1.4301, C45, AISI 304)..."
                    x-model="searchQuery"
                    class="form-input"
                    style="max-width: 400px;">
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                    <span x-show="searchQuery.length > 0">
                        Nalezeno: <strong x-text="filteredNorms.length"></strong> z <strong x-text="allNorms.length"></strong>
                    </span>
                </small>
            </div>

            <!-- Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>W.Nr</th>
                        <th>EN ISO</th>
                        <th>ƒåSN</th>
                        <th>AISI</th>
                        <th>Kategorie materi√°lu</th>
                        <th>Hustota</th>
                        <th style="text-align: right;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="norm in filteredNorms" :key="norm.id">
                        <tr>
                            <td x-text="norm.w_nr || '-'"></td>
                            <td x-text="norm.en_iso || '-'"></td>
                            <td x-text="norm.csn || '-'"></td>
                            <td x-text="norm.aisi || '-'"></td>
                            <td style="font-weight: 500;" x-text="norm.material_group.name"></td>
                            <td style="color: var(--text-secondary); font-size: 0.85rem;" x-text="norm.material_group.density + ' kg/dm¬≥'"></td>
                            <td style="text-align: right;">
                                <button class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        @click="editNorm(norm.id, norm.w_nr || '', norm.en_iso || '', norm.csn || '', norm.aisi || '', norm.material_group_id, norm.note || '', norm.version)">
                                    Upravit
                                </button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredNorms.length === 0">
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span x-show="searchQuery.length > 0">≈Ω√°dn√© v√Ωsledky pro "<span x-text="searchQuery"></span>"</span>
                            <span x-show="searchQuery.length === 0">≈Ω√°dn√© normy v datab√°zi</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Info box -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Jak funguje p≈ôevodn√≠ tabulka:</div>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    <li>Ka≈æd√Ω ≈ô√°dek = p≈ôevodn√≠ z√°znam (4 sloupce norem ‚Üí 1 kategorie materi√°lu)</li>
                    <li>P≈ô√≠klad: W.Nr "1.0503" | EN ISO "C45" | ƒåSN "12050" | AISI "1045" ‚Üí Ocel konstrukƒçn√≠</li>
                    <li>P≈ôi vytv√°≈ôen√≠ MaterialItem zad√°≈° k√≥d (nap≈ô. "D20 11109" nebo "1.0036-HR005w05-T")</li>
                    <li>Syst√©m extrahuje normu a najde ji v tabulce nap≈ô√≠ƒç v≈°emi 4 sloupci</li>
                    <li>Automaticky p≈ôi≈ôad√≠ MaterialGroup (hustota) + MaterialPriceCategory (cena)</li>
                </ul>
            </div>
        </div>

        <!-- Tab: System Config -->
        <div x-show="activeTab === 'config'" x-cloak>
            <div style="margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">‚öôÔ∏è Syst√©mov√© nastaven√≠</h2>
                <p style="color: var(--text-secondary); font-size: 0.85rem;">
                    Glob√°ln√≠ cenov√© koeficienty pro kalkulace
                </p>
            </div>

            <!-- Success/Error messages -->
            <div x-show="successMessage"
                 class="alert alert-success"
                 x-text="successMessage"
                 style="margin-bottom: 1.5rem;"></div>
            <div x-show="errorMessage"
                 class="alert alert-error"
                 x-text="errorMessage"
                 style="margin-bottom: 1.5rem;"></div>

            <!-- Form -->
            <form @submit.prevent="saveSettings">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Koeficienty jsou n√°sobitele (1.20 = +20%, 1.25 = +25%, atd.)
                    </p>
                </div>

                <!-- Coefficients grid -->
                <div class="form-grid-2col">
                    {% for config in configs %}
                    <div class="form-field">
                        <label for="{{ config.key }}">
                            {{ config.description }}
                            <span style="color: var(--error);">*</span>
                        </label>
                        <input
                            type="number"
                            id="{{ config.key }}"
                            name="{{ config.key }}"
                            x-model="values['{{ config.key }}']"
                            value="{{ config.value_float }}"
                            step="0.01"
                            min="1.0"
                            max="5.0"
                            required
                            class="form-input"
                        >
                        <input type="hidden" name="version_{{ config.key }}" value="{{ config.version }}">
                        <small class="help-text">
                            Aktu√°lnƒõ: {{ config.value_float }}
                            {% if config.updated_by %}
                            | Upravil: {{ config.updated_by }} ({{ config.updated_at.strftime('%d.%m.%Y %H:%M') }})
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>

                <!-- Info box -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Jak koeficienty funguj√≠:</div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        <li><strong>Overhead (re≈æie):</strong> N√°sob√≠ n√°klady stroj≈Ø (administrativn√≠ re≈æie)</li>
                        <li><strong>Margin (mar≈æe):</strong> N√°sob√≠ pr√°ci (stroje + re≈æie) pro zisk</li>
                        <li><strong>Stock (skladov√Ω):</strong> N√°sob√≠ cenu materi√°lu (ztr√°ty, ≈ôezivo)</li>
                        <li><strong>Coop (kooperaƒçn√≠):</strong> N√°sob√≠ cenu kooperace (handling, komunikace)</li>
                    </ul>
                </div>

                <!-- Action buttons -->
                <div class="btn-group btn-group-right" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" @click="window.location.href='/'">
                        Zru≈°it
                    </button>
                    <button type="submit"
                            class="btn btn-primary"
                            :disabled="saving"
                            x-text="saving ? 'Ukl√°d√°m...' : 'Ulo≈æit zmƒõny'">
                    </button>
                </div>
            </form>
        </div>

        <!-- Modal for Create/Edit MaterialNorm -->
        <div x-show="showModal" x-cloak @keydown.escape.window="showModal = false">
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" @click.self="showModal = false">
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <p>üöß Modal pro p≈ôid√°n√≠/editaci norem bude implementov√°n v p≈ô√≠≈°t√≠ verzi.</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                        Zat√≠m m≈Ø≈æe≈° normy spravovat p≈ô√≠mo v datab√°zi nebo p≈ôes API endpointy.
                    </p>
                    <button @click="showModal = false" class="btn btn-primary" style="margin-top: 1.5rem;">
                        Zav≈ô√≠t
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function adminPanel(allNorms) {
    return {
        // Tab state
        activeTab: 'norms',

        // Material Norms tab
        allNorms: allNorms || [],
        searchQuery: '',
        showModal: false,

        // Computed: filteredNorms based on searchQuery
        get filteredNorms() {
            if (!this.searchQuery || this.searchQuery.trim().length === 0) {
                return this.allNorms;
            }

            const query = this.searchQuery.trim().toLowerCase();

            return this.allNorms.filter(norm => {
                // Search across all 4 columns + category name (case-insensitive)
                const w_nr = (norm.w_nr || '').toLowerCase();
                const en_iso = (norm.en_iso || '').toLowerCase();
                const csn = (norm.csn || '').toLowerCase();
                const aisi = (norm.aisi || '').toLowerCase();
                const category = (norm.material_group?.name || '').toLowerCase();

                return w_nr.includes(query) ||
                       en_iso.includes(query) ||
                       csn.includes(query) ||
                       aisi.includes(query) ||
                       category.includes(query);
            });
        },

        // System Config tab
        saving: false,
        successMessage: '',
        errorMessage: '',
        values: {
            {% for config in configs -%}
            '{{ config.key }}': {{ config.value_float }}{% if not loop.last %},{% endif %}
            {% endfor %}
        },
        versions: {
            {% for config in configs -%}
            '{{ config.key }}': {{ config.version }}{% if not loop.last %},{% endif %}
            {% endfor %}
        },

        openCreateNorm() {
            this.showModal = true;
            // Dispatch event to materialNormForm component
            window.dispatchEvent(new CustomEvent('create-material-norm'));
        },

        editNorm(id, w_nr, en_iso, csn, aisi, material_group_id, note, version) {
            this.showModal = true;
            // Dispatch event to materialNormForm component
            window.dispatchEvent(new CustomEvent('edit-material-norm', {
                detail: {
                    id: id,
                    w_nr: w_nr,
                    en_iso: en_iso,
                    csn: csn,
                    aisi: aisi,
                    material_group_id: material_group_id,
                    note: note,
                    version: version
                }
            }));
        },

        async saveSettings() {
            this.saving = true;
            this.successMessage = '';
            this.errorMessage = '';

            const configs = [
                {% for config in configs %}
                { key: '{{ config.key }}', value: this.values['{{ config.key }}'], version: this.versions['{{ config.key }}'] },
                {% endfor %}
            ];

            let allSuccess = true;

            for (const config of configs) {
                try {
                    const response = await fetch(`/api/config/${config.key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            value_float: parseFloat(config.value),
                            version: config.version
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                    }

                    const updated = await response.json();
                    this.versions[config.key] = updated.version;

                } catch (error) {
                    console.error(`Error updating ${config.key}:`, error);
                    this.errorMessage = `Chyba p≈ôi ukl√°d√°n√≠ ${config.key}: ${error.message}`;
                    allSuccess = false;
                    break;
                }
            }

            this.saving = false;

            if (allSuccess) {
                this.successMessage = '‚úÖ Nastaven√≠ √∫spƒõ≈°nƒõ ulo≈æeno';
                window.showToast && window.showToast('Nastaven√≠ ulo≈æeno', 'success');

                // Reload page after 1 second to show updated timestamps
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                window.showToast && window.showToast(this.errorMessage, 'error');
            }
        }
    };
}
</script>
{% endblock %}
