{% extends "base.html" %}
{% from "macros.html" import form_section, form_input_number, btn_primary, btn_secondary %}

{% block title %}Nastaven√≠ syst√©mu - GESTIMA{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/forms.css">
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700;">‚öôÔ∏è Nastaven√≠ syst√©mu</h1>
        <p style="color: var(--text-muted); margin-top: 0.5rem;">
            Glob√°ln√≠ cenov√© koeficienty pro kalkulace
        </p>
    </div>

    <!-- Alpine.js component -->
    <div x-data="settingsForm()">
        <!-- Success/Error messages -->
        <div x-show="successMessage"
             class="alert alert-success"
             x-text="successMessage"
             style="margin-bottom: 1.5rem;"></div>
        <div x-show="errorMessage"
             class="alert alert-error"
             x-text="errorMessage"
             style="margin-bottom: 1.5rem;"></div>

        <!-- Form -->
        <form @submit.prevent="saveSettings">
            <!-- Pricing Coefficients Section -->
            {% call form_section('üí∞ Cenov√© koeficienty') %}
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Koeficienty jsou n√°sobitele (1.20 = +20%, 1.25 = +25%, atd.)
                    </p>
                </div>

                <!-- Coefficients grid -->
                <div class="form-grid-2col">
                    {% for config in configs %}
                    <div class="form-field">
                        <label for="{{ config.key }}">
                            {{ config.description }}
                            <span style="color: var(--error);">*</span>
                        </label>
                        <input
                            type="number"
                            id="{{ config.key }}"
                            name="{{ config.key }}"
                            x-model="values['{{ config.key }}']"
                            value="{{ config.value_float }}"
                            step="0.01"
                            min="1.0"
                            max="5.0"
                            required
                            class="form-input"
                        >
                        <input type="hidden" name="version_{{ config.key }}" value="{{ config.version }}">
                        <small class="help-text">
                            Aktu√°lnƒõ: {{ config.value_float }}
                            {% if config.updated_by %}
                            | Upravil: {{ config.updated_by }} ({{ config.updated_at.strftime('%d.%m.%Y %H:%M') }})
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>

                <!-- Info box -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Jak koeficienty funguj√≠:</div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        <li><strong>Overhead (re≈æie):</strong> N√°sob√≠ n√°klady stroj≈Ø (administrativn√≠ re≈æie)</li>
                        <li><strong>Margin (mar≈æe):</strong> N√°sob√≠ pr√°ci (stroje + re≈æie) pro zisk</li>
                        <li><strong>Stock (skladov√Ω):</strong> N√°sob√≠ cenu materi√°lu (ztr√°ty, ≈ôezivo)</li>
                        <li><strong>Coop (kooperaƒçn√≠):</strong> N√°sob√≠ cenu kooperace (handling, komunikace)</li>
                    </ul>
                </div>
            {% endcall %}

            <!-- Action buttons -->
            <div class="btn-group btn-group-right" style="margin-top: 2rem;">
                {{ btn_secondary('Zru≈°it', "window.location.href='/'", 'button') }}
                <button type="submit"
                        class="btn btn-primary"
                        :disabled="saving"
                        x-text="saving ? 'Ukl√°d√°m...' : 'Ulo≈æit zmƒõny'">
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsForm() {
    return {
        saving: false,
        successMessage: '',
        errorMessage: '',
        values: {
            {% for config in configs %}
            '{{ config.key }}': {{ config.value_float }},
            {% endfor %}
        },
        versions: {
            {% for config in configs %}
            '{{ config.key }}': {{ config.version }},
            {% endfor %}
        },

        async saveSettings() {
            this.saving = true;
            this.successMessage = '';
            this.errorMessage = '';

            const configs = [
                {% for config in configs %}
                { key: '{{ config.key }}', value: this.values['{{ config.key }}'], version: this.versions['{{ config.key }}'] },
                {% endfor %}
            ];

            let allSuccess = true;
            let errorCount = 0;

            for (const config of configs) {
                try {
                    const response = await fetch(`/api/config/${config.key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            value_float: parseFloat(config.value),
                            version: config.version
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Chyba p≈ôi ukl√°d√°n√≠');
                    }

                    const updated = await response.json();
                    this.versions[config.key] = updated.version;

                } catch (error) {
                    console.error(`Error updating ${config.key}:`, error);
                    this.errorMessage = `Chyba p≈ôi ukl√°d√°n√≠ ${config.key}: ${error.message}`;
                    allSuccess = false;
                    errorCount++;
                    break;
                }
            }

            this.saving = false;

            if (allSuccess) {
                this.successMessage = '‚úÖ Nastaven√≠ √∫spƒõ≈°nƒõ ulo≈æeno';
                window.showToast && window.showToast('Nastaven√≠ ulo≈æeno', 'success');

                // Reload page after 1 second to show updated timestamps
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                window.showToast && window.showToast(this.errorMessage, 'error');
            }
        }
    };
}
</script>
{% endblock %}
