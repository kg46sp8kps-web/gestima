<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestima - Proxy Features Test (v1.25.0)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            color: #60a5fa;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .layout {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .panel h2 {
            color: #60a5fa;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Left panel - File selector */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            background: #334155;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .file-item:hover {
            background: #475569;
            transform: translateX(4px);
        }

        .file-item.active {
            background: #3b82f6;
            color: white;
        }

        /* Middle panel - 3D viewer */
        #viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
        }

        .viewer-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(30, 41, 59, 0.95);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .viewer-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .control-btn {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #334155;
            border-color: #60a5fa;
        }

        .control-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Right panel - Metrics */
        .metrics-section {
            margin-bottom: 20px;
        }

        .metrics-section h3 {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
            font-size: 13px;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #94a3b8;
        }

        .metric-value {
            color: #e2e8f0;
            font-weight: 500;
        }

        .metric-value.highlight {
            color: #60a5fa;
            font-weight: 600;
        }

        .time-card {
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .time-card h4 {
            color: #60a5fa;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .time-value {
            font-size: 24px;
            color: #60a5fa;
            font-weight: 600;
        }

        .time-unit {
            font-size: 14px;
            color: #94a3b8;
            margin-left: 4px;
        }

        .error {
            background: #991b1b;
            color: #fecaca;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.rot {
            background: #7c3aed;
            color: white;
        }

        .badge.pri {
            background: #2563eb;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Proxy Features Test Environment</h1>
        <div class="subtitle">v1.25.0 - Inner/Outer Visualization + Time Estimation</div>

        <div class="layout">
            <!-- LEFT: File selector -->
            <div class="panel">
                <h2>üìÅ Test Files (37 parts)</h2>
                <div class="file-list" id="file-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading files...</div>
                    </div>
                </div>
            </div>

            <!-- MIDDLE: 3D Viewer -->
            <div class="panel">
                <h2>üé® 3D Viewer</h2>
                <div id="viewer-container">
                    <div class="loading" id="viewer-loading">
                        <div class="spinner"></div>
                        <div>Select a file to view</div>
                    </div>

                    <div class="viewer-legend" id="viewer-legend" style="display: none;">
                        <div class="legend-item">
                            <div class="color-box" style="background: #4A90E2;"></div>
                            <span>Vnƒõj≈°√≠ plochy</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background: #E74C3C;"></div>
                            <span>Vnit≈ôn√≠ plochy (dutiny)</span>
                        </div>
                    </div>

                    <div class="viewer-controls" id="viewer-controls" style="display: none;">
                        <button class="control-btn active" onclick="setColorMode('inner-outer')">Inner/Outer</button>
                        <button class="control-btn" onclick="setColorMode('default')">Default</button>
                        <button class="control-btn" onclick="resetCamera()">Reset View</button>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Metrics & Time -->
            <div class="panel">
                <h2>üìä Proxy Metrics</h2>
                <div id="metrics-container">
                    <div style="color: #94a3b8; text-align: center; padding: 40px 0;">
                        Select a file to view metrics
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls;
        let currentMesh = null;
        let currentColorMode = 'inner-outer';
        let currentStepUrl = null;
        let currentFeatures = null;

        // Initialize Three.js scene
        function initViewer() {
            const container = document.getElementById('viewer-container');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);

            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 10000);
            camera.position.set(200, 200, 200);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 100);
            scene.add(directionalLight);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-100, -100, -100);
            scene.add(directionalLight2);

            // Grid
            const gridHelper = new THREE.GridHelper(500, 50, 0x475569, 0x334155);
            scene.add(gridHelper);

            // Axes
            const axesHelper = new THREE.AxesHelper(100);
            scene.add(axesHelper);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Load STEP file and features
        async function loadPart(filename) {
            try {
                document.getElementById('viewer-loading').style.display = 'block';
                document.getElementById('viewer-legend').style.display = 'none';
                document.getElementById('viewer-controls').style.display = 'none';

                // Load STEP geometry (via backend WASM conversion)
                currentStepUrl = `/uploads/drawings/${filename}`;

                // Load features from backend
                const featuresResponse = await fetch(`/api/geometry-features/extract?filename=${filename}`);
                if (!featuresResponse.ok) throw new Error('Failed to load features');
                currentFeatures = await featuresResponse.json();

                // Load 3D model (simplified - using Three.js loader)
                // TODO: Implement actual STEP loading via occt-import-js
                // For now, show a placeholder cube with face orientation
                loadPlaceholder3D();

                // Show metrics
                displayMetrics(currentFeatures);

                // Show controls
                document.getElementById('viewer-loading').style.display = 'none';
                document.getElementById('viewer-legend').style.display = 'block';
                document.getElementById('viewer-controls').style.display = 'flex';

            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('viewer-loading').innerHTML = `
                    <div style="color: #ef4444;">
                        ‚ùå Error loading part<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Placeholder 3D (until WASM loader implemented)
        function loadPlaceholder3D() {
            if (currentMesh) scene.remove(currentMesh);

            const geometry = new THREE.BoxGeometry(50, 50, 50);

            // Create materials for inner/outer
            const outerMaterial = new THREE.MeshPhongMaterial({
                color: 0x4A90E2,
                side: THREE.DoubleSide
            });
            const innerMaterial = new THREE.MeshPhongMaterial({
                color: 0xE74C3C,
                side: THREE.DoubleSide
            });

            // Assign groups (simplified demo)
            geometry.clearGroups();
            geometry.addGroup(0, 18, 0);  // Outer faces (first 3 faces)
            geometry.addGroup(18, 18, 1); // Inner faces (last 3 faces)

            currentMesh = new THREE.Mesh(geometry, [outerMaterial, innerMaterial]);
            scene.add(currentMesh);

            resetCamera();
        }

        // Display metrics in right panel
        function displayMetrics(features) {
            const container = document.getElementById('metrics-container');

            const html = `
                <div class="metrics-section">
                    <h3>Part Classification</h3>
                    <div class="metric-row">
                        <span class="metric-label">Type</span>
                        <span class="metric-value"><span class="badge ${features.part_type.toLowerCase()}">${features.part_type}</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Rotational Score</span>
                        <span class="metric-value">${(features.rotational_score * 100).toFixed(1)}%</span>
                    </div>
                </div>

                <div class="metrics-section">
                    <h3>Volume Metrics</h3>
                    <div class="metric-row">
                        <span class="metric-label">Part Volume</span>
                        <span class="metric-value">${(features.part_volume_mm3 / 1000).toFixed(1)} cm¬≥</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Removal Volume</span>
                        <span class="metric-value">${(features.removal_volume_mm3 / 1000).toFixed(1)} cm¬≥</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Removal Ratio</span>
                        <span class="metric-value">${(features.removal_ratio * 100).toFixed(1)}%</span>
                    </div>
                </div>

                <div class="metrics-section">
                    <h3>üî¥ Complexity Metrics (NEW!)</h3>
                    <div class="metric-row">
                        <span class="metric-label">Internal Cavity Volume</span>
                        <span class="metric-value highlight">${(features.internal_cavity_volume_mm3 / 1000).toFixed(1)} cm¬≥</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Cavity Ratio</span>
                        <span class="metric-value highlight">${(features.cavity_to_stock_ratio * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Inner Surface Ratio</span>
                        <span class="metric-value highlight">${(features.inner_surface_ratio * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Concave Edge Ratio</span>
                        <span class="metric-value highlight">${(features.concave_edge_ratio * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Max Feature Depth</span>
                        <span class="metric-value highlight">${features.max_feature_depth_mm.toFixed(1)} mm</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Openness Ratio</span>
                        <span class="metric-value highlight">${(features.openness_ratio * 100).toFixed(1)}%</span>
                    </div>
                </div>

                <div class="metrics-section">
                    <h3>Surface Distribution</h3>
                    <div class="metric-row">
                        <span class="metric-label">Planar</span>
                        <span class="metric-value">${(features.planar_surface_ratio * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Cylindrical</span>
                        <span class="metric-value">${(features.cylindrical_surface_ratio * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Freeform</span>
                        <span class="metric-value">${(features.freeform_surface_ratio * 100).toFixed(1)}%</span>
                    </div>
                </div>

                <div class="time-card">
                    <h4>‚è±Ô∏è Estimated Time (MRR baseline)</h4>
                    <div class="metric-row">
                        <span class="metric-label">Roughing</span>
                        <span class="metric-value">~${Math.round(features.removal_volume_mm3 / 100)} min</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Finishing</span>
                        <span class="metric-value">~${Math.round(features.surface_area_mm2 / 500)} min</span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #475569;">
                        <span class="time-value">${Math.round(features.removal_volume_mm3 / 100 + features.surface_area_mm2 / 500)}</span>
                        <span class="time-unit">minutes total</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Load file list
        async function loadFileList() {
            try {
                const response = await fetch('/api/step-files/list');
                const files = await response.json();

                const listHtml = files.map(file => `
                    <div class="file-item" onclick="selectFile('${file.filename}')">
                        ${file.filename}
                    </div>
                `).join('');

                document.getElementById('file-list').innerHTML = listHtml;
            } catch (error) {
                document.getElementById('file-list').innerHTML = `
                    <div class="error">Failed to load file list</div>
                `;
            }
        }

        // Select file
        window.selectFile = function(filename) {
            // Update active state
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.toggle('active', item.textContent.trim() === filename);
            });

            // Load part
            loadPart(filename);
        };

        // Color mode toggle
        window.setColorMode = function(mode) {
            currentColorMode = mode;
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // TODO: Update mesh materials based on mode
            if (mode === 'default' && currentMesh) {
                currentMesh.material = new THREE.MeshPhongMaterial({ color: 0x94a3b8 });
            } else if (mode === 'inner-outer') {
                loadPlaceholder3D(); // Reload with inner/outer colors
            }
        };

        // Reset camera
        window.resetCamera = function() {
            if (currentMesh) {
                const box = new THREE.Box3().setFromObject(currentMesh);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                const cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 2;

                camera.position.set(center.x + cameraZ * 0.5, center.y + cameraZ * 0.5, center.z + cameraZ);
                camera.lookAt(center);
                controls.target.copy(center);
                controls.update();
            }
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('viewer-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // Initialize on load
        initViewer();
        loadFileList();
    </script>
</body>
</html>
