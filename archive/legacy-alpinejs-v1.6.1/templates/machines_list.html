{% extends "base.html" %}
{% from "macros.html" import table_header, table_empty_state, badge, btn_primary, btn_danger %}

{% block title %}GESTIMA - Stroje{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/forms.css">
<script src="/static/js/crud_components.js"></script>
{% endblock %}

{% block content %}
<div x-data="entityList('/api/machines')">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Stroje</h1>
        <a href="/machines/new" class="btn btn-primary">
            ‚ûï Nov√Ω stroj
        </a>
    </div>

    <!-- Search -->
    <div style="margin-bottom: 1.5rem;">
        <input
            type="text"
            x-model="searchQuery"
            @input.debounce.300ms="loadItems()"
            placeholder="Hledat stroj (k√≥d, n√°zev, typ)..."
            class="form-input"
            style="max-width: 400px;"
        >
    </div>

    <!-- Loading state -->
    <div x-show="loading" style="text-align: center; padding: 2rem;">
        <div class="spinner spinner-large" style="margin: 0 auto;"></div>
        <p style="margin-top: 1rem; color: var(--text-muted);">Naƒç√≠t√°n√≠...</p>
    </div>

    <!-- Error state -->
    <div x-show="error" class="alert alert-error" x-text="error"></div>

    <!-- Table -->
    <div x-show="!loading && !error" style="overflow-x: auto;">
        <table class="table">
            {{ table_header(['K√≥d', 'N√°zev', 'Typ', 'Sazba Setup', 'Sazba Operace', 'Priorita', 'Stav', 'Akce']) }}
            <tbody>
                <template x-for="machine in items" :key="machine.id">
                    <tr>
                        <td>
                            <strong x-text="machine.code" style="font-family: monospace;"></strong>
                        </td>
                        <td x-text="machine.name"></td>
                        <td>
                            <span x-text="machine.type"></span>
                            <span x-show="machine.subtype" x-text="' (' + machine.subtype + ')'" class="text-muted"></span>
                        </td>
                        <td style="text-align: right; font-family: monospace;">
                            <strong x-text="machine.hourly_rate_setup.toFixed(0) + ' Kƒç/h'"></strong>
                            <br>
                            <small class="text-muted">(bez n√°stroj≈Ø)</small>
                        </td>
                        <td style="text-align: right; font-family: monospace;">
                            <strong x-text="machine.hourly_rate_operation.toFixed(0) + ' Kƒç/h'"></strong>
                            <br>
                            <small class="text-muted">(s n√°stroji)</small>
                        </td>
                        <td style="text-align: center;">
                            <span class="badge badge-default" x-text="machine.priority"></span>
                        </td>
                        <td>
                            <span
                                class="badge"
                                :class="machine.active ? 'badge-success' : 'badge-error'"
                                x-text="machine.active ? 'Aktivn√≠' : 'Neaktivn√≠'"
                            ></span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button
                                    @click="navigateTo(`/machines/${machine.id}/edit`)"
                                    class="btn btn-secondary"
                                    style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"
                                >
                                    ‚úèÔ∏è Edit
                                </button>
                                <button
                                    @click="deleteItem(machine.id)"
                                    class="btn btn-danger"
                                    style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>

                <!-- Empty state -->
                <tr x-show="items.length === 0">
                    {{ table_empty_state('≈Ω√°dn√© stroje nenalezeny') }}
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Stats -->
    <div x-show="!loading && items.length > 0" style="margin-top: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
        Celkem: <strong x-text="items.length"></strong> stroj≈Ø
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Extend entityList with search support
function entityList(apiEndpoint) {
    return {
        loading: false,
        items: [],
        error: null,
        searchQuery: '',

        async init() {
            await this.loadItems();
        },

        async loadItems() {
            this.loading = true;
            this.error = null;

            try {
                let url = apiEndpoint;
                if (this.searchQuery.trim()) {
                    url = `${apiEndpoint}/search?search=${encodeURIComponent(this.searchQuery)}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                this.items = data.machines || data;
            } catch (error) {
                console.error('Load error:', error);
                this.error = 'Chyba p≈ôi naƒç√≠t√°n√≠ dat';
                window.showToast && window.showToast(this.error, 'error');
            } finally {
                this.loading = false;
            }
        },

        async deleteItem(id) {
            if (!confirm('Opravdu smazat tento stroj? Tato akce je nevratn√°.')) return;

            try {
                const response = await fetch(`${apiEndpoint}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Chyba p≈ôi maz√°n√≠');
                }

                window.showToast && window.showToast('Stroj smaz√°n', 'success');
                await this.loadItems();
            } catch (error) {
                console.error('Delete error:', error);
                window.showToast && window.showToast(error.message, 'error');
            }
        },

        navigateTo(path) {
            window.location.href = path;
        }
    };
}
</script>
{% endblock %}
