{% extends "base.html" %}

{% block title %}Sada {{ batch_set.set_number }} - GESTIMA{% endblock %}

{% block content %}
<div x-data="batchSetDetailModule({{ batch_set.id }})" x-init="init()" style="padding: 1.5rem 2rem;">

    <!-- Breadcrumb + Header -->
    <div style="margin-bottom: 1.5rem;">
        <div style="margin-bottom: 0.5rem;">
            <a href="/pricing/batch-sets" style="color: var(--text-secondary); text-decoration: none; font-size: 0.85rem;">
                ‚Üê Zpƒõt na sady cen
            </a>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                    <span x-text="batchSet?.name || 'Naƒç√≠t√°m...'"></span>
                    <span x-show="batchSet?.status === 'frozen'"
                          style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        ‚ùÑÔ∏è Zmrazeno
                    </span>
                    <span x-show="batchSet?.status === 'draft'"
                          style="background: rgba(34, 197, 94, 0.1); color: var(--accent-green); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                        üìù Rozpracov√°no
                    </span>
                </h1>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">
                    Sada <span x-text="batchSet?.set_number"></span>
                    <template x-if="batchSet?.part_id">
                        <span> ‚Ä¢ D√≠l #<span x-text="batchSet?.part_id"></span></span>
                    </template>
                </p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button x-show="batchSet?.status === 'draft'"
                        @click="recalculateSet()"
                        class="btn-flat"
                        :disabled="loading || batches.length === 0">
                    üîÑ P≈ôepoƒç√≠tat
                </button>
                <button x-show="batchSet?.status === 'draft'"
                        @click="freezeSet()"
                        class="btn-primary"
                        :disabled="loading || batches.length === 0">
                    ‚ùÑÔ∏è Zmrazit sadu
                </button>
                <button @click="cloneSet()"
                        class="btn-flat"
                        :disabled="loading">
                    üìã Klonovat
                </button>
                {% if user and user.role.value == 'admin' %}
                <button @click="deleteSet()"
                        class="btn-flat"
                        style="color: var(--accent-red);"
                        :disabled="loading">
                    üóëÔ∏è Smazat
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
        Naƒç√≠t√°m...
    </div>

    <!-- Content -->
    <div x-show="!loading" style="display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem;">

        <!-- Left: Batches Table -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                    D√°vky (<span x-text="batches.length"></span>)
                </h2>
                <div x-show="batchSet?.status === 'draft'" style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="number" x-model.number="newQuantity" min="1"
                           placeholder="Mno≈æstv√≠"
                           style="width: 100px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    <button @click="addBatch()" class="btn-primary" :disabled="!newQuantity || newQuantity < 1">
                        + P≈ôidat d√°vku
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="batches.length === 0"
                 style="text-align: center; padding: 2rem; background: var(--bg-secondary); border-radius: 8px; border: 1px dashed var(--border-color);">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìä</div>
                <div style="color: var(--text-secondary);">Sada nem√° ≈æ√°dn√© d√°vky</div>
                <div x-show="batchSet?.status === 'draft'" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                    P≈ôidejte prvn√≠ d√°vku pomoc√≠ formul√°≈ôe v√Ω≈°e
                </div>
            </div>

            <!-- Batches Table -->
            <table x-show="batches.length > 0"
                   style="width: 100%; border-collapse: collapse; background: var(--bg-primary); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            ks
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Materi√°l
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Stroje
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Se≈ô√≠zen√≠
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Koop
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Re≈æie
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase;">
                            Mar≈æe
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--accent-blue); font-size: 0.7rem; text-transform: uppercase;">
                            Cena/ks
                        </th>
                        <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--accent-blue); font-size: 0.7rem; text-transform: uppercase;">
                            Celkem
                        </th>
                        <th x-show="batchSet?.status === 'draft'" style="padding: 0.5rem 0.75rem; width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="batch in batches" :key="batch.id">
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600;" x-text="batch.quantity"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.material_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.machining_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.setup_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.coop_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.overhead_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--text-secondary);" x-text="formatNumber(batch.margin_cost)"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--accent-blue);" x-text="formatNumber(batch.unit_cost) + ' Kƒç'"></td>
                            <td style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: var(--accent-blue);" x-text="formatNumber(batch.total_cost) + ' Kƒç'"></td>
                            <td x-show="batchSet?.status === 'draft'" style="padding: 0.5rem 0.75rem; text-align: center;">
                                <button @click="removeBatch(batch)"
                                        class="btn-flat"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--accent-red);">
                                    ‚úï
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tfoot x-show="batches.length > 0">
                    <tr style="background: var(--bg-secondary); font-weight: 600;">
                        <td style="padding: 0.5rem 0.75rem; text-align: right;" x-text="totalQuantity + ' ks'"></td>
                        <td colspan="6" style="padding: 0.5rem 0.75rem;"></td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--accent-blue);">Pr≈Ømƒõr:</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--accent-blue);" x-text="formatNumber(averageUnitCost) + ' Kƒç'"></td>
                        <td x-show="batchSet?.status === 'draft'"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Right: Info Panel -->
        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem; height: fit-content;">
            <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0;">
                Informace o sadƒõ
            </h3>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.85rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">ƒå√≠slo sady:</span>
                    <span style="color: var(--text-primary); font-weight: 500;" x-text="batchSet?.set_number"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Stav:</span>
                    <span :style="{ color: batchSet?.status === 'frozen' ? 'var(--accent-blue)' : 'var(--accent-green)' }"
                          x-text="batchSet?.status === 'frozen' ? 'Zmrazeno' : 'Rozpracov√°no'"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Poƒçet d√°vek:</span>
                    <span style="color: var(--text-primary);" x-text="batches.length"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Celkov√° hodnota:</span>
                    <span style="color: var(--accent-blue); font-weight: 600;" x-text="formatNumber(totalValue) + ' Kƒç'"></span>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">

                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Vytvo≈ôeno:</span>
                    <span style="color: var(--text-primary);" x-text="formatDate(batchSet?.created_at)"></span>
                </div>
                <template x-if="batchSet?.frozen_at">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Zmrazeno:</span>
                        <span style="color: var(--text-primary);" x-text="formatDate(batchSet?.frozen_at)"></span>
                    </div>
                </template>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Verze:</span>
                    <span style="color: var(--text-muted);" x-text="'v' + batchSet?.version"></span>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
function batchSetDetailModule(setId) {
    return {
        // Module identity (ADR-023: Workspace ready)
        moduleType: 'batch-set-detail',
        moduleId: crypto.randomUUID(),

        // Props
        setId: setId,

        // State
        batchSet: null,
        batches: [],
        loading: false,
        newQuantity: 1,

        // Computed
        get totalQuantity() {
            return this.batches.reduce((sum, b) => sum + b.quantity, 0);
        },
        get totalValue() {
            return this.batches.reduce((sum, b) => sum + b.total_cost, 0);
        },
        get averageUnitCost() {
            if (this.batches.length === 0) return 0;
            return this.batches.reduce((sum, b) => sum + b.unit_cost, 0) / this.batches.length;
        },

        // Lifecycle
        async init() {
            await this.loadBatchSet();
        },

        // API Methods
        async loadBatchSet() {
            this.loading = true;
            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}`);
                if (!response.ok) throw new Error('Failed to load batch set');
                const data = await response.json();
                this.batchSet = data;
                this.batches = data.batches || [];
            } catch (error) {
                console.error('Error loading batch set:', error);
                alert('Nepoda≈ôilo se naƒç√≠st sadu');
            } finally {
                this.loading = false;
            }
        },

        async addBatch() {
            if (!this.newQuantity || this.newQuantity < 1) return;

            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}/batches?quantity=${this.newQuantity}`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to add batch');
                }
                this.newQuantity = 1;
                await this.loadBatchSet();
            } catch (error) {
                console.error('Error adding batch:', error);
                alert('Nepoda≈ôilo se p≈ôidat d√°vku: ' + error.message);
            }
        },

        async removeBatch(batch) {
            if (!confirm(`Smazat d√°vku pro ${batch.quantity} ks?`)) return;

            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}/batches/${batch.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to remove batch');
                }
                await this.loadBatchSet();
            } catch (error) {
                console.error('Error removing batch:', error);
                alert('Nepoda≈ôilo se smazat d√°vku: ' + error.message);
            }
        },

        async freezeSet() {
            if (!confirm(`Zmrazit sadu "${this.batchSet.name}"?\n\nV≈°echny d√°vky budou zmrazeny a nebude je mo≈æn√© upravovat.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}/freeze`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to freeze batch set');
                }
                await this.loadBatchSet();
            } catch (error) {
                console.error('Error freezing batch set:', error);
                alert('Nepoda≈ôilo se zmrazit sadu: ' + error.message);
            }
        },

        async recalculateSet() {
            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}/recalculate`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to recalculate batch set');
                }
                await this.loadBatchSet();
            } catch (error) {
                console.error('Error recalculating batch set:', error);
                alert('Nepoda≈ôilo se p≈ôepoƒç√≠tat sadu: ' + error.message);
            }
        },

        async cloneSet() {
            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}/clone`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to clone batch set');
                }
                const newSet = await response.json();
                // Redirect to new set
                window.location.href = `/pricing/batch-sets/${newSet.id}`;
            } catch (error) {
                console.error('Error cloning batch set:', error);
                alert('Nepoda≈ôilo se klonovat sadu: ' + error.message);
            }
        },

        async deleteSet() {
            if (!confirm(`Opravdu smazat sadu "${this.batchSet.name}"?\n\nTato akce sma≈æe sadu vƒçetnƒõ v≈°ech ${this.batches.length} d√°vek.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pricing/batch-sets/${this.setId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete batch set');
                }
                // Redirect to list
                window.location.href = '/pricing/batch-sets';
            } catch (error) {
                console.error('Error deleting batch set:', error);
                alert('Nepoda≈ôilo se smazat sadu: ' + error.message);
            }
        },

        // Helpers
        formatNumber(num) {
            if (num === null || num === undefined) return '‚Äî';
            return Number(num).toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            return date.toLocaleDateString('cs-CZ') + ' ' + date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
        }
    };
}
</script>
{% endblock %}
