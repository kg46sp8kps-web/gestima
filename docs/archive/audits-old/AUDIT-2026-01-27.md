# GESTIMA Code Audit Report

**Datum:** 2026-01-27
**Auditor:** Roy (Senior Developer)
**Verze:** 1.0
**Status:** COMPLETED

---

## Executive Summary

Provedl jsem komplexní audit GESTIMA codebase zaměřený na:
- Nepoužívaný kód (dead code)
- Duplicity a DRY violations
- Logické chyby a edge cases
- Workaroundy a hacky
- Konzistenci kódu
- Datovou integritu

### Celkové hodnocení: **7.5/10** → **8.5/10** (po opravách)

---

## 1. Provedené opravy

### 1.1 Kritické opravy (FÁZE 1)

| ID | Problém | Soubor | Řešení | Status |
|----|---------|--------|--------|--------|
| CRIT-001 | Falsy defaults skrývají 0 | `time_calculator.py:60-106` | Změněno `or` na `is not None` | ✅ FIXED |
| CRIT-002 | Chybějící FK cascade | `part.py:27-28` | Přidáno `ondelete="SET NULL"` | ✅ FIXED |
| CRIT-003 | Infinite loop risk | `number_generator.py` | Přidán `max_iterations` limit | ✅ FIXED |

### 1.2 Dead code removal (FÁZE 2)

| ID | Co smazáno | Soubor | Řádků | Status |
|----|------------|--------|-------|--------|
| DEL-001 | `calculate_material_cost_from_part()` | `price_calculator.py` | 96 | ✅ REMOVED |
| DEL-002 | `calculate_material_cost()` | `price_calculator.py` | 63 | ✅ REMOVED |
| DEL-003 | `_obsolete_v2_2026-01-27/` folder | `scripts/` | ~18,000 | ✅ REMOVED |
| DEL-004 | `searchComponent()` | `crud_components.js` | 43 | ✅ REMOVED |
| DEL-005 | `pricingWidget()` | `crud_components.js` | 49 | ✅ REMOVED |
| DEL-006 | `formValidation()` | `crud_components.js` | 57 | ✅ REMOVED |
| DEL-007 | `confirmDialog()` | `crud_components.js` | 31 | ✅ REMOVED |
| DEL-008 | Console.log debug statements | `templates/` | 7 | ✅ REMOVED |

**Celkem odstraněno: ~18,350 řádků mrtvého kódu**

### 1.3 Refaktoring

| ID | Co změněno | Soubor | Popis |
|----|------------|--------|-------|
| REF-001 | `/api/data/stock-price` endpoint | `data_router.py` | Přepsán bez deprecated funkce |

---

## 2. Identifikované problémy (Known Issues)

### 2.1 Vysoká priorita (doporučeno opravit)

#### ISSUE-001: Bare `except Exception` patterns
**Výskyt:** 19 míst v routers
**Soubory:** admin_router.py (9×), batches_router.py (3×), misc_router.py (2×), pages_router.py (2×), parts_router.py (1×), config_router.py (1×), materials_router.py (1×)

**Problém:** Zachytávání všech výjimek maskuje specifické chyby a ztěžuje debugging.

**Doporučení:**
```python
# ŠPATNĚ
except Exception as e:
    await db.rollback()
    raise HTTPException(500, f"Error: {e}")

# SPRÁVNĚ
except IntegrityError as e:
    await db.rollback()
    raise HTTPException(409, "Konflikt dat")
except SQLAlchemyError as e:
    await db.rollback()
    logger.error(f"DB error: {e}", exc_info=True)
    raise HTTPException(500, "Databázová chyba")
```

#### ISSUE-002: Nepoužívaný `safe_commit()` helper
**Výskyt:** 57× copy-paste error handling v routers
**Soubor:** `db_helpers.py` obsahuje `safe_commit()` ale není používán

**Doporučení:** Refaktorovat routers na použití existujícího helperu.

### 2.2 Střední priorita

#### ISSUE-003: Import uvnitř funkcí
**Výskyt:** 3× v `admin_router.py` (řádky 327, 526, 653)
**Problém:** `from datetime import datetime` uvnitř funkce

**Doporučení:** Přesunout importy na začátek souboru.

#### ISSUE-004: hasattr/getattr lazy-loading hack
**Výskyt:** `snapshot_service.py:39-61`, `price_calculator.py:264`
**Problém:** Zachytávání `MissingGreenlet` pro lazy-loading v async kontextu

**Doporučení:** Zajistit eager-loading v caller funkcích.

#### ISSUE-005: Duplicitní `entityList()` komponenta
**Výskyt:** `machines_list.html:116-176` vs `crud_components.js:15-68`
**Problém:** Stejná komponenta na dvou místech

**Doporučení:** Smazat lokální verzi v machines_list.html.

### 2.3 Nízká priorita

#### ISSUE-006: Redundantní snapshot fields
**Soubor:** `batch.py:46-47`
**Problém:** `unit_price_frozen` a `total_price_frozen` duplikují data ze `snapshot_data`

#### ISSUE-007: Magic numbers v Query parametrech
**Výskyt:** `limit=50, le=200` v parts_router.py, admin_router.py
**Doporučení:** Extrahovat do konstant.

---

## 3. Pozitivní nálezy

### 3.1 Co je implementováno správně

| Oblast | Hodnocení | Poznámka |
|--------|-----------|----------|
| **Naming conventions** | ✅ Výborné | 100% konzistentní snake_case/PascalCase |
| **Type hints** | ✅ Výborné | Všechny public funkce |
| **Audit trail** | ✅ Výborné | AuditMixin na všech entitách |
| **Pydantic validace** | ✅ Výborné | gt=0, ge=0 všude kde má být |
| **Logging** | ✅ Výborné | Konzistentní logger místo print() |
| **Transaction handling** | ✅ Dobré | try/except/rollback pattern (s výjimkou ISSUE-001) |
| **Optimistic locking** | ✅ Dobré | Version check implementován |
| **ADR dokumentace** | ✅ Výborné | 17+ architektonických rozhodnutí |

### 3.2 Architektura

- **Single Source of Truth** - Pydantic computed fields pro procenta
- **DRY** - `set_audit()` helper používán konzistentně (54×)
- **Separation of Concerns** - Jasné oddělení routers/services/models
- **Error handling** - Strukturované HTTPException responses

---

## 4. Bezpečnostní audit

### 4.1 Ověřené oblasti

| Oblast | Status | Poznámka |
|--------|--------|----------|
| SQL Injection | ✅ SAFE | SQLAlchemy ORM, parametrizované queries |
| XSS | ✅ SAFE | Jinja2 auto-escaping, `textContent` v JS |
| CSRF | ✅ SAFE | FastAPI default protection |
| Auth | ✅ SAFE | JWT tokens, role-based access |
| Secrets | ✅ SAFE | Žádné hardcoded credentials |
| Input validation | ✅ SAFE | Pydantic validace na všech endpointech |

### 4.2 Doporučení

- Zvážit rate limiting na auth endpoints
- Přidat audit log pro admin operace

---

## 5. Performance audit

### 5.1 N+1 Query problém

**Status:** Částečně vyřešeno

**Dobré:**
- `price_calculator.py:645-655` - Pre-load strojů v jednom query

**Vyžaduje pozornost:**
- `price_calculator.py:61-78` - Lazy loading fallback s MissingGreenlet catch

### 5.2 Caching

**Status:** Implementováno, ale s rezervami

- `reference_loader.py` - Global cache bez automatické invalidace
- Doporučení: Přidat TTL nebo event-based invalidaci

---

## 6. Testovací pokrytí

### 6.1 Existující testy

```
tests/
├── test_seed_data.py  # Seed data validace
└── (další testy)
```

### 6.2 Doporučené testy

- [ ] Unit testy pro `price_calculator.py` kalkulace
- [ ] Unit testy pro `time_calculator.py` s edge cases (0 values)
- [ ] Integration testy pro batch recalculation workflow
- [ ] Testy pro `number_generator.py` při vysoké DB utilizaci

---

## 7. Doporučení pro další vývoj

### 7.1 Krátkodobá (1-2 týdny)

1. **Fix bare `except Exception`** - Nahradit specifickými exceptions
2. **Refactor na `safe_commit()`** - Použít existující helper
3. **Přesunout importy** - `datetime` na top-level v admin_router.py

### 7.2 Střednědobá (1 měsíc)

1. **Eager loading audit** - Zajistit konzistentní selectinload
2. **Cache invalidation** - Přidat TTL na reference_loader cache
3. **Test coverage** - Přidat unit testy pro kritické kalkulace

### 7.3 Dlouhodobá (3+ měsíce)

1. **API versioning** - Přidat `/api/v1/` prefix
2. **OpenAPI docs** - Rozšířit dokumentaci endpointů
3. **Monitoring** - Přidat metrics pro performance tracking

---

## 8. Změněné soubory

### 8.1 Modifikované

| Soubor | Změna |
|--------|-------|
| `app/services/time_calculator.py` | Fix falsy defaults |
| `app/services/number_generator.py` | Add iteration limit |
| `app/services/price_calculator.py` | Remove deprecated functions |
| `app/models/part.py` | Add FK ondelete |
| `app/routers/data_router.py` | Refactor stock-price endpoint |
| `app/static/js/crud_components.js` | Remove unused components |
| `app/templates/admin/material_norm_form.html` | Remove console.log |
| `app/templates/parts/edit.html` | Remove console.log, fix toast |

### 8.2 Smazané

| Soubor/Složka |
|---------------|
| `scripts/_obsolete_v2_2026-01-27/` |

---

## 9. Závěr

GESTIMA codebase je v dobrém stavu s několika oblastmi pro zlepšení:

**Silné stránky:**
- Konzistentní coding standards
- Dobrá dokumentace (ADR)
- Bezpečná implementace
- Čistá architektura

**Oblasti pro zlepšení:**
- Error handling patterns (bare exceptions)
- Využití existujících helperů (safe_commit)
- Test coverage

**Celkové doporučení:** Codebase je připraven pro production deployment po vyřešení ISSUE-001 (bare exceptions).

---

## Appendix A: Statistiky

```
Celkem souborů:        ~120
Python souborů:        ~60
JavaScript souborů:    ~5
Template souborů:      ~30
Řádků kódu (před):     ~25,000
Řádků kódu (po):       ~6,650 (aplikace) + ~3,500 (scripts)
Smazáno řádků:         ~18,350
```

---

## Appendix B: Checklist pro code review

```
[ ] Žádné console.log v produkčním kódu
[ ] Všechny DB operace mají error handling
[ ] FK constraints mají ondelete definován
[ ] Pydantic schemas mají validace (gt, ge, max_length)
[ ] Async funkce nepoužívají lazy-loading
[ ] Importy jsou na začátku souboru
[ ] Žádné hardcoded credentials
[ ] Response models jsou definovány
[ ] Logging místo print()
```

---

**Podpis:** Roy
**Datum:** 2026-01-27
**Revize:** 1.0
